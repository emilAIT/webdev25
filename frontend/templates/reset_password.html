<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeowChat - Reset Password</title>
    <link rel="stylesheet" href="/static/css/styles.css"> <!-- –û–±—â–∏–µ —Å—Ç–∏–ª–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω—ã -->
    <link rel="stylesheet" href="/static/css/auth.css"> <!-- –°—Ç–∏–ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <main class="login-container"> <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º login-container –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <div class="login-form"> <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º login-form –¥–ª—è —Å—Ç–∏–ª–µ–π -->
            <h1 class="login-title">Set New Password</h1>

            <div id="reset-error" class="error-message" style="display: none;"></div>
            <div id="reset-success" class="success-message" style="display: none;"></div>

            <form id="reset-password-form" method="post">
                <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è —Ç–æ–∫–µ–Ω–∞, –∑–Ω–∞—á–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø–µ—Ä–µ–¥–∞–Ω–æ –∏–∑ –±—ç–∫–µ–Ω–¥–∞ -->
                <input type="hidden" id="reset-token" name="token" value="{{ token }}">

                <div class="form-group">
                    <label for="new-password">New Password</label>
                    <div class="password-container">
                        <input type="password" id="new-password" name="new_password" class="form-control" placeholder="Enter new password" required>
                        <button type="button" class="password-toggle" onclick="togglePassword('new-password')">üëÅÔ∏è</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="confirm-password">Confirm New Password</label>
                     <div class="password-container">
                        <input type="password" id="confirm-password" name="confirm_password" class="form-control" placeholder="Confirm new password" required>
                        <button type="button" class="password-toggle" onclick="togglePassword('confirm-password')">üëÅÔ∏è</button>
                    </div>
                </div>

                <button type="submit" class="login-btn">Reset Password</button>
            </form>
        </div>
    </main>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è (—Ç–∞ –∂–µ, —á—Ç–æ –∏ –≤ login.html)
        function togglePassword(inputId) {
            const passwordInput = document.getElementById(inputId);
            const passwordToggle = passwordInput.nextElementSibling;
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                passwordToggle.textContent = 'üëÅÔ∏è‚Äçüó®Ô∏è';
            } else {
                passwordInput.type = 'password';
                passwordToggle.textContent = 'üëÅÔ∏è';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        const resetForm = document.getElementById('reset-password-form');
        const errorElement = document.getElementById('reset-error');
        const successElement = document.getElementById('reset-success');

        if (resetForm) { // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–æ—Ä–º—ã
            resetForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                errorElement.style.display = 'none';
                successElement.style.display = 'none';
                const submitButton = resetForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting...';

                const token = document.getElementById('reset-token').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;

                if (newPassword !== confirmPassword) {
                    errorElement.textContent = 'Passwords do not match.';
                    errorElement.style.display = 'block';
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Reset Password';
                    return;
                }
                
                if (newPassword.length < 6) { // –ü—Ä–∏–º–µ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã
                    errorElement.textContent = 'Password must be at least 6 characters long.';
                    errorElement.style.display = 'block';
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Reset Password';
                    return;
                }

                try {
                    const response = await fetch('/reset-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: token, new_password: newPassword })
                    });
                    const result = await response.json();

                    if (response.ok) {
                        successElement.textContent = result.detail || 'Password reset successfully! Redirecting to login...';
                        successElement.style.display = 'block';
                        resetForm.reset(); // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                        submitButton.disabled = true; // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞
                        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ª–æ–≥–∏–Ω —á–µ—Ä–µ–∑ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 3000);
                    } else {
                        errorElement.textContent = result.detail || 'Failed to reset password. The link might be invalid or expired.';
                        errorElement.style.display = 'block';
                        submitButton.disabled = false;
                        submitButton.innerHTML = 'Reset Password';
                    }
                } catch (error) {
                    console.error('Reset password error:', error);
                    errorElement.textContent = 'Network or server error. Please try again.';
                    errorElement.style.display = 'block';
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Reset Password';
                }
            });
        }
    </script>
</body>
</html> 