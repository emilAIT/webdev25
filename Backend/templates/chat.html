<!DOCTYPE html>
<html lang="en" 
    {% if session and session.user_id %}
    data-user-id="{{ session.user_id }}"
    data-authenticated="true"
    {% else %}
    data-authenticated="false"
    {% endif %}
>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="app.title">TogolokChat</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/emoji-picker.css') }}">
    <script src="{{ url_for('static', filename='js/emoji-picker.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/language-manager.js') }}"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        body {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* Custom scrollbar styling */
        ::-webkit-scrollbar {
            width: 4px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        /* Background image and overlay */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('/static/images/pik_karakol.jpg.png');
            background-size: cover;
            background-position: center;
            z-index: -2;
        }
        
        /* Dark overlay with 70% opacity */
        body::after {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: -1;
        }
        
        /* Top header bar */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
        }
        
        .app-logo {
            display: flex;
            align-items: center;
        }
        
        .app-logo img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .app-title {
            color: white;
            font-size: 18px;
            font-weight: bold;
        }
        
        .chat-container {
            display: flex;
            height: 100vh;
            width: 100%;
            padding-top: 60px; /* Account for the header */
            gap: 5px; /* Smaller consistent gap */
        }
        
        .sidebar {
            width: 30%;
            height: calc(100vh - 70px);
            background-color: rgba(255, 255, 255, 0.4); /* Semi-transparent white */
            display: flex;
            flex-direction: column;
            position: relative;
            border-radius: 20px 0 0 20px;
            overflow: hidden;
            margin: 5px 0 5px 0;
            z-index: 5;
            /* Remove any other potential backgrounds */
            border: none;
            box-shadow: none;
        }
        
        .sidebar-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding-bottom: 70px; /* Make room for nav bar */
            background-color: transparent;
        }
        
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            height: 60px;
            background-color: rgba(255, 255, 255, 0.6);
            border-top-right-radius: 0;
            border-top-left-radius: 20px;
        }
        
        .app-name {
            color: black;
            font-size: 16px;
            font-weight: bold;
        }
        
        .sidebar-header-icons {
            display: flex;
            gap: 15px;
        }
        
        .search-container {
            padding: 8px;
            background-color: transparent;
        }
        
        .search-bar {
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: 20px 0 20px 20px;
            padding: 10px;
            display: flex;
            align-items: center;
        }
        
        .search-bar input {
            background: transparent;
            border: none;
            color: black;
            width: 100%;
            outline: none;
            margin-left: 10px;
            font-size: 15px;
        }
        
        .contact-list {
            overflow-y: auto;
            flex: 1;
            background-color: transparent;
        }
        
        .contact {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: none;
            cursor: pointer;
            background-color: rgba(255, 255, 255, 0.6);
            margin: 5px 5px;
            border-radius: 20px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .contact:hover {
            background-color: rgba(255, 255, 255, 0.6);
        }
        
        .contact-active {
            background-color: rgba(255, 255, 255, 0.7);
        }
        
        .profile-pic {
            width: 49px;
            height: 49px;
            border-radius: 50%;
            margin-right: 15px;
            overflow: hidden;
        }
        
        .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .contact-info {
            flex: 1;
        }
        
        .contact-name {
            color: black;
            font-size: 17px;
            margin-bottom: 3px;
        }
        
        .contact-message {
            color: #333;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .contact-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: space-between;
        }
        
        .message-time {
            color: #333;
            font-size: 12px;
            margin-bottom: 3px;
        }
        
        /* Sidebar Navigation */
        .sidebar-nav {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: transparent; /* Make it transparent to match sidebar */
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            height: 80px;
            z-index: 10;
            border-bottom-left-radius: 20px;
        }
        
        .nav-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #333;
            cursor: pointer;
            padding: 8px;
            border-radius: 12px;
            transition: background-color 0.2s;
            min-width: 70px;
            height: 100%;
        }
        
        .nav-icon:hover {
            background-color: rgba(255, 255, 255, 0.6);
        }
        
        .nav-icon.active {
            color: #000;
        }
        
        .nav-icon svg {
            margin-bottom: 6px;
            width: 36px;
            height: 36px;
        }
        
        .nav-icon-label {
            font-size: 14px;
            font-weight: bold;
        }
        
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            margin: 5px 5px 5px 0; /* Match sidebar margins */
        }
        
        .chat-header {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            background-color: rgba(255, 255, 255, 0.6);
            height: 60px;
            border-top-right-radius: 20px;
            border-top-left-radius: 0;
        }
        
        .chat-header-info {
            flex: 1;
            margin-left: 15px;
        }
        
        .chat-header-name {
            color: black;
            font-size: 16px;
        }
        
        .chat-header-status {
            font-size: 13px;
            color: #333;
            margin-top: 2px;
        }
        
        .chat-header-status.online {
            color: green;
        }
        
        .chat-header-status.offline {
            color: #333;
        }
        
        .chat-header-icons {
            display: flex;
            gap: 20px;
            color: #333;
        }
        
        .chat-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background-color: transparent;
        }
        
        .message {
            max-width: 80% !important;
            padding: 8px 12px 20px 12px !important;
            margin: 5px 0 !important;
            border-radius: 16px !important;
            position: relative !important;
            overflow: visible !important;
            word-wrap: break-word !important;
            cursor: pointer !important;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1) !important;
        }
        
        .message.sent {
            align-self: flex-end !important;
            background-color: #e7e7e7 !important;
            color: black !important;
            margin-left: auto !important;
            margin-right: 10px !important;
            border-top-right-radius: 0 !important;
        }
        
        .message-content {
            font-size: 16px !important;
            padding-right: 40px !important;
            margin-bottom: 0 !important;
            word-break: break-word !important;
        }
        
        .message-meta {
            display: flex !important;
            align-items: center !important;
            position: absolute !important;
            bottom: 4px !important;
            right: 12px !important;
            font-size: 11px !important;
        }
        
        .message-timestamp {
            font-size: 12px !important;
            color: #000 !important;
            margin-right: 4px !important;
            opacity: 0.5 !important;
        }
        
        .message-options {
            position: absolute;
            top: 0;
            right: -120px;
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: 8px;
            padding: 8px;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .message-options.visible {
            display: flex;
            gap: 10px;
        }
        
        .message-option {
            padding: 8px;
            color: #333;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }
        
        .message-option:hover {
            background-color: rgba(255, 255, 255, 0.8);
        }
        
        .message-option.delete {
            color: #ff6b6b;
        }
        
        .message-option.edit {
            color: green;
        }
        
        .edited-indicator {
            font-size: 10px;
            color: #333;
            margin-left: 5px;
            font-style: italic;
        }
        
        .received {
            background-color: #e7e7e7 !important;
            color: black !important;
            align-self: flex-start !important;
            margin-right: auto !important;
            margin-left: 10px !important;
            border-top-left-radius: 0 !important;
        }
        
        .chat-footer {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.6);
            border-bottom-right-radius: 20px;
            border-bottom-left-radius: 0;
        }
        
        .chat-footer-icons {
            display: flex;
            gap: 15px;
            color: #333;
            padding: 0 15px;
        }
        
        .message-input {
            flex: 1;
            background-color: rgba(255, 255, 255, 0.4);
            border-radius: 20px;
            border: none;
            padding: 9px 12px;
            color: black;
            outline: none;
            font-size: 15px;
        }
        
        .send-button {
            margin-left: 10px;
            color: #333;
            cursor: pointer;
        }
        
        .icon {
            cursor: pointer;
        }
        
        /* Content Areas */
        .content-area {
            display: none;
            flex: 1;
            flex-direction: column;
        }
        
        .content-area.active {
            display: flex;
        }
        
        .contacts-area {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        /* Contacts screen */
        .contacts-header {
            padding: 16px;
            background-color: #1f2c33;
            color: #e9edef;
            font-size: 20px;
            font-weight: bold;
        }
        
        /* Utility Classes */
        .flex-center {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                display: none;
            }
            
            .main-chat {
                width: 100%;
            }
        }
        
        /* Settings Sidebar Styles */
        /* These styles have been removed because we're using a new approach with the showSettingsSidebar function */
        
        /* Profile Section Styles */
        .profile-section {
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .profile-avatar-container {
            position: relative;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            position: relative;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-edit {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            text-align: center;
            padding: 5px;
            cursor: pointer;
        }

        .profile-info {
            flex: 1;
        }

        .profile-nickname {
            color: #333;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .profile-name input {
            background-color: transparent;
            border: none;
            border-bottom: 1px solid #374045;
            color: #333;
            font-size: 16px;
            padding: 5px 0;
            width: 100%;
            outline: none;
        }

        .profile-bio textarea {
            background-color: transparent;
            border: 1px solid #374045;
            border-radius: 5px;
            color: #333;
            width: 100%;
            padding: 10px;
            resize: none;
            height: 100px;
            outline: none;
        }

        .profile-bio textarea:focus,
        .profile-name input:focus {
            border-color: #333;
        }

        /* Settings Section Styles */
        .settings-section {
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: 10px;
            padding: 20px;
        }
        
        .settings-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .settings-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            color: #333;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        
        .settings-item:hover {
            background-color: rgba(255, 255, 255, 0.8);
        }
        
        .settings-item i,
        .settings-item svg {
            width: 24px;
            height: 24px;
            color: #333;
        }
        
        .settings-item span {
            font-size: 16px;
        }

        #logout-button {
            color: #f15e6c;
        }

        #logout-button i {
            color: #f15e6c;
        }

        /* Logout Modal Styles */
        .logout-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .logout-modal-content {
            background-color: #202c33;
            padding: 20px;
            border-radius: 10px;
            width: 300px;
            text-align: center;
        }

        .logout-modal-title {
            color: #e9edef;
            font-size: 18px;
            margin-bottom: 20px;
        }

        .logout-modal-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .logout-modal-button {
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            border: none;
        }

        .logout-modal-cancel {
            background-color: #374045;
            color: #e9edef;
        }

        .logout-modal-confirm {
            background-color: #f15e6c;
            color: white;
        }

        /* Added for user selection */
        .user-item.user-selected {
            background-color: #2a3942 !important; /* Force selection background */
        }

        .add-contact-footer {
            padding: 10px 15px;
            background-color: transparent;
            margin-top: auto; /* Push to bottom */
            border-radius: 0 0 0 20px;
        }

        .add-contact-footer button {
            width: 100%;
            padding: 12px;
            background-color: rgba(0, 168, 132, 0.8);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        .add-contact-footer button:disabled {
            background-color: rgba(180, 180, 180, 0.6);
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* ... existing styles ... */

        .contacts-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background-color: transparent;
        }

        .contact-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
            background-color: transparent;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: none;
            transition: background-color 0.2s;
            background-color: rgba(255, 255, 255, 0.6);
            margin: 5px;
            border-radius: 20px;
        }

        .contact-item:hover {
            background-color: rgba(255, 255, 255, 0.8);
        }

        .contact-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin-right: 15px;
            overflow: hidden;
        }

        .contact-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            color: #333;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .contact-status {
            color: #333;
            font-size: 13px;
        }

        .loading-contacts {
            text-align: center;
            padding: 20px;
            color: #333;
            background-color: transparent;
        }

        .no-contacts {
            text-align: center;
            padding: 20px;
            color: #333;
            background-color: transparent;
        }

        /* Removing the duplicate sidebar-nav definition */
        
        .date-separator {
            text-align: center;
            margin: 20px 0;
            color: #333;
            font-size: 12.5px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .date-separator::before,
        .date-separator::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #8696a0;
            margin: 0 10px;
            opacity: 0.2;
        }

        /* User selection in add contacts view */
        .user-item.user-selected {
            background-color: rgba(255, 255, 255, 0.8) !important; /* Force selection background */
        }
        
        /* Update search result styling */
        .user-item {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            background-color: rgba(255, 255, 255, 0.6);
            margin: 5px;
            border-radius: 20px;
        }
        
        .user-item:hover {
            background-color: rgba(255, 255, 255, 0.8);
        }

        .message-meta {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            float: right;
            clear: both;
            font-size: 11px;
            margin-top: 2px;
        }

        .message-timestamp {
            font-size: 12px;
            color: #8696a0;
            margin-right: 4px;
        }

        .message-content {
            font-size: 16px;
            margin-right: 5px;
        }

        .message.deleted {
            background-color: rgba(255, 255, 255, 0.4);
            color: #333;
            font-style: italic;
        }

        .contact-message-container {
            display: flex;
            align-items: center;
        }

        .contact-message {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .contact-status {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #333;
            font-size: 13px;
        }

        /* Profile Info Panel Styles */
        .profile-info-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100%;
            background-color: #1f2c33;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
            z-index: 100;
            transition: right 0.3s ease;
            overflow-y: auto;
        }
        
        /* Settings Sidebar Styles */
        /* These styles are no longer needed with the new approach */
        
        /* Profile Section Styles */
        .profile-section {
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .profile-avatar-container {
            position: relative;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            position: relative;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-edit {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            text-align: center;
            padding: 5px;
            cursor: pointer;
        }

        .profile-info {
            flex: 1;
        }

        .profile-nickname {
            color: #333;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .profile-name input {
            background-color: transparent;
            border: none;
            border-bottom: 1px solid #374045;
            color: #333;
            font-size: 16px;
            padding: 5px 0;
            width: 100%;
            outline: none;
        }

        .profile-bio textarea {
            background-color: transparent;
            border: 1px solid #374045;
            border-radius: 5px;
            color: #333;
            width: 100%;
            padding: 10px;
            resize: none;
            height: 100px;
            outline: none;
        }

        .profile-bio textarea:focus,
        .profile-name input:focus {
            border-color: #333;
        }

        /* Settings Section Styles */
        .settings-section {
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: 10px;
            padding: 20px;
        }
        
        .settings-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .settings-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            color: #333;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        
        .settings-item:hover {
            background-color: rgba(255, 255, 255, 0.8);
        }
        
        .settings-item i,
        .settings-item svg {
            width: 24px;
            height: 24px;
            color: #333;
        }
        
        .settings-item span {
            font-size: 16px;
        }

        #logout-button {
            color: #f15e6c;
        }

        #logout-button i {
            color: #f15e6c;
        }

        /* Logout Modal Styles */
        .logout-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .logout-modal-content {
            background-color: #202c33;
            padding: 20px;
            border-radius: 10px;
            width: 300px;
            text-align: center;
        }

        .logout-modal-title {
            color: #e9edef;
            font-size: 18px;
            margin-bottom: 20px;
        }

        .logout-modal-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .logout-modal-button {
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            border: none;
        }

        .logout-modal-cancel {
            background-color: #374045;
            color: #e9edef;
        }

        .logout-modal-confirm {
            background-color: #f15e6c;
            color: white;
        }

        /* Added for user selection */
        .user-item.user-selected {
            background-color: #2a3942 !important; /* Force selection background */
        }

        .add-contact-footer {
            padding: 10px 15px;
            background-color: transparent;
            margin-top: auto; /* Push to bottom */
            border-radius: 0 0 0 20px;
        }

        .add-contact-footer button {
            width: 100%;
            padding: 12px;
            background-color: rgba(0, 168, 132, 0.8);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        .add-contact-footer button:disabled {
            background-color: rgba(180, 180, 180, 0.6);
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* ... existing styles ... */

        .contacts-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background-color: transparent;
        }

        .contact-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
            background-color: transparent;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: none;
            transition: background-color 0.2s;
            background-color: rgba(255, 255, 255, 0.6);
            margin: 5px;
            border-radius: 20px;
        }

        .contact-item:hover {
            background-color: rgba(255, 255, 255, 0.8);
        }

        .contact-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin-right: 15px;
            overflow: hidden;
        }

        .contact-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            color: #333;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .contact-status {
            color: #333;
            font-size: 13px;
        }

        .loading-contacts {
            text-align: center;
            padding: 20px;
            color: #333;
            background-color: transparent;
        }

        .no-contacts {
            text-align: center;
            padding: 20px;
            color: #333;
            background-color: transparent;
        }

        /* Removing the duplicate sidebar-nav definition */
        
        .date-separator {
            text-align: center;
            margin: 20px 0;
            color: #333;
            font-size: 12.5px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .date-separator::before,
        .date-separator::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #8696a0;
            margin: 0 10px;
            opacity: 0.2;
        }

        /* User selection in add contacts view */
        .user-item.user-selected {
            background-color: rgba(255, 255, 255, 0.8) !important; /* Force selection background */
        }
        
        /* Update search result styling */
        .user-item {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            background-color: rgba(255, 255, 255, 0.6);
            margin: 5px;
            border-radius: 20px;
        }
        
        .user-item:hover {
            background-color: rgba(255, 255, 255, 0.8);
        }

        .message-meta {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            float: right;
            clear: both;
            font-size: 11px;
            margin-top: 2px;
        }

        .message-timestamp {
            font-size: 12px;
            color: #8696a0;
            margin-right: 4px;
        }

        .message-content {
            font-size: 16px;
            margin-right: 5px;
        }

        .message.deleted {
            background-color: rgba(255, 255, 255, 0.4);
            color: #333;
            font-style: italic;
        }

        .contact-message-container {
            display: flex;
            align-items: center;
        }

        .contact-message {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .contact-status {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #333;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <!-- Top header with logo -->
    <div class="app-header">
        <div class="app-logo">
            <img src="/static/images/logo_icon.png" alt="TogolokChat Logo">
            <span data-i18n="app.title">TogolokChat</span>
        </div>
    </div>
    
    <div class="chat-container">
        <!-- Sidebar with transparent background -->
        <div class="sidebar">
            <div class="sidebar-content">
                <div class="sidebar-header">
                    <div class="app-name" data-i18n="chat.chats">Chats</div>
                    <div class="sidebar-header-icons">
                        <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                            <path fill="currentColor" d="M15.009 13.805h-.636l-.22-.219a5.184 5.184 0 0 0 1.256-3.386 5.207 5.207 0 1 0-5.207 5.208 5.183 5.183 0 0 0 3.385-1.255l.221.22v.635l4.004 3.999 1.194-1.195-3.997-4.007zm-4.808 0a3.605 3.605 0 1 1 0-7.21 3.605 3.605 0 0 1 0 7.21z"></path>
                        </svg>
                    </div>
                </div>
                
                <div class="search-container">
                    <div class="search-bar">
                        <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                            <path fill="currentColor" d="M15.009 13.805h-.636l-.22-.219a5.184 5.184 0 0 0 1.256-3.386 5.207 5.207 0 1 0-5.207 5.208 5.183 5.183 0 0 0 3.385-1.255l.221.22v.635l4.004 3.999 1.194-1.195-3.997-4.007zm-4.808 0a3.605 3.605 0 1 1 0-7.21 3.605 3.605 0 0 1 0 7.21z"></path>
                        </svg>
                        <input type="text" id="search-input" data-i18n-placeholder="chat.search" placeholder="Search contacts" onkeyup="searchContacts()">
                    </div>
                </div>
                
                <div class="contact-list" id="contact-list">
                    <!-- Contacts will be loaded dynamically -->
                    <div class="loading-contacts">
                        Loading contacts...
                    </div>
                </div>
            </div>
            
            <!-- Sidebar Navigation -->
            <div class="sidebar-nav">
                <div class="nav-icon active" data-target="contacts">
                    <svg viewBox="0 0 24 24" width="28" height="28">
                        <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"></path>
                    </svg>
                    <span class="nav-icon-label" data-i18n="chat.contacts">Contacts</span>
                </div>
                <div class="nav-icon" data-target="groups">
                    <svg viewBox="0 0 24 24" width="28" height="28">
                        <path fill="currentColor" d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5z"></path>
                    </svg>
                    <span class="nav-icon-label" data-i18n="chat.groups">Groups</span>
                </div>
                <div class="nav-icon" data-target="add">
                    <svg viewBox="0 0 24 24" width="28" height="28">
                        <path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path>
                    </svg>
                    <span class="nav-icon-label" data-i18n="chat.add">Add</span>
                </div>
                <div class="nav-icon" data-target="settings">
                    <svg viewBox="0 0 24 24" width="28" height="28">
                        <path fill="currentColor" d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"></path>
                    </svg>
                    <span class="nav-icon-label" data-i18n="chat.settings">Settings</span>
                </div>
            </div>
        </div>
        
        <!-- Settings Sidebar -->
        <!-- This sidebar has been replaced by the new approach using showSettingsSidebar function -->
        
        <!-- Main Chat Area -->
        <div class="main-chat">
            <!-- Chat Header -->
            <div class="chat-header">
                <!-- Will be filled by JS -->
            </div>
            
            <!-- Chat Body -->
            <div class="chat-body">
                <!-- there should be messages between users   -->
                 
            </div>
            
            <!-- Chat Footer -->
            <div class="chat-footer">
                <!-- Container for file preview -->
                <div id="file-preview-container" style="display: none; width: 100%; background-color: #2a3942; padding: 8px; margin-bottom: 5px; border-radius: 8px; align-items: center; justify-content: space-between;">
                    <span id="file-preview-name" style="color: #e9edef; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></span>
                    <button id="remove-file-btn" style="background: none; border: none; color: #f15c6d; cursor: pointer; font-size: 16px;">&times;</button>
                </div>

                <div style="display: flex; align-items: center; width: 100%;">
                <div class="chat-footer-icons">
                    <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                        <path fill="currentColor" d="M9.153 11.603c.795 0 1.439-.879 1.439-1.962s-.644-1.962-1.439-1.962-1.439.879-1.439 1.962.644 1.962 1.439 1.962zm-3.204 1.362c-.026-.307-.131 5.218 6.063 5.551 6.066-.25 6.066-5.551 6.066-5.551-6.078 1.416-12.129 0-12.129 0zm11.363 1.108s-.669 1.959-5.051 1.959c-3.505 0-5.388-1.164-5.607-1.959 0 0 5.912 1.055 10.658 0zM11.804 1.011C5.609 1.011.978 6.033.978 12.228s4.826 10.761 11.021 10.761S23.02 18.423 23.02 12.228c.001-6.195-5.021-11.217-11.216-11.217zM12 21.354c-5.273 0-9.381-3.886-9.381-9.159s3.942-9.548 9.215-9.548 9.548 4.275 9.548 9.548c-.001 5.272-4.109 9.159-9.382 9.159zm3.108-9.751c.795 0 1.439-.879 1.439-1.962s-.644-1.962-1.439-1.962-1.439.879-1.439 1.962.644 1.962 1.439 1.962z"></path>
                    </svg>
                        <svg id="attach-file-icon" viewBox="0 0 24 24" width="24" height="24" class="icon" style="cursor: pointer;">
                        <path fill="currentColor" d="M1.816 15.556v.002c0 1.502.584 2.912 1.646 3.972s2.472 1.647 3.974 1.647a5.58 5.58 0 0 0 3.972-1.645l9.547-9.548c.769-.768 1.147-1.767 1.058-2.817-.079-.968-.548-1.927-1.319-2.698-1.594-1.592-4.068-1.711-5.517-.262l-7.916 7.915c-.881.881-.792 2.25.214 3.261.959.958 2.423 1.053 3.263.215l5.511-5.512c.28-.28.267-.722.053-.936l-.244-.244c-.191-.191-.567-.349-.957.04l-5.506 5.506c-.18.18-.635.127-.976-.214-.098-.097-.576-.613-.213-.973l7.915-7.917c.818-.817 2.267-.699 3.23.262.5.501.802 1.1.849 1.685.051.573-.156 1.111-.589 1.543l-9.547 9.549a3.97 3.97 0 0 1-2.829 1.171 3.975 3.975 0 0 1-2.83-1.173 3.973 3.973 0 0 1-1.172-2.828c0-1.071.415-2.076 1.172-2.83l7.209-7.211c.157-.157.264-.579.028-.814L11.5 4.36a.572.572 0 0 0-.834.018l-7.205 7.207a5.577 5.577 0 0 0-1.645 3.971z"></path>
                    </svg>
                        <input type="file" id="file-input" style="display: none;">
                </div>
                
                <input type="text" class="message-input" data-i18n-placeholder="chat.messageInput" placeholder="Type a message...">
                <button class="send-button" data-i18n-title="chat.send" title="Send">
                    <i class="fas fa-paper-plane"></i>
                </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Socket.IO connection with reconnection options
        const socket = io({
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            reconnectionAttempts: 5
        });
        
        // Initialize current chat variable
        window.currentChat = null;

        // Override function to ensure the right function is used for group header updates
        window.addEventListener('DOMContentLoaded', function() {
            // This will ensure our code runs after all definitions
            setTimeout(function() {
                // Store a reference to the old function with different parameters
                const updateChatHeaderSimple = window.updateChatHeader;
                
                // Make sure the full function with group support is always used
                window.updateChatHeader = function(entity, isGroup) {
                    console.log("Using enhanced updateChatHeader function");
                    
                    // Call the correct implementation that handles group chats
                    const chatHeader = document.querySelector('.chat-header');
                    
                    console.log("Updating chat header for:", isGroup ? "group" : "direct chat", entity);
                    
                    // Store entity for later reference
                    window.currentChat = {
                        id: Number(entity.id || entity),  // Handle both entity object and simple ID
                        type: isGroup ? 'group' : 'direct',
                        name: isGroup ? entity.name : (entity.username || entity),
                        entity: entity // Store the full entity for info panel
                    };
                    
                    console.log("Current chat updated to:", window.currentChat);
                    
                    // Get profile picture URL
                    let profilePic;
                    if (isGroup) {
                        profilePic = entity.picture ? `/uploads/group_images/${entity.picture}` : 'Backend/static/images/group_logo.png';
                    } else {
                        // For direct chats, use the same logic as contact list
                        profilePic = entity.profile_picture ? `/uploads/profile_photos/${entity.profile_picture}` : '/static/images/contact_logo.png';
                        
                        // If no profile picture in entity, fetch it from the API
                        if (!entity.profile_picture) {
                            fetch(`/api/user/${entity.id}/profile-picture`)
                                .then(response => response.json())
                                .then(data => {
                                    if (data.photo_url) {
                                        const img = chatHeader.querySelector('.profile-pic img');
                                        if (img) {
                                            img.src = data.photo_url;
                                        }
                                    }
                                })
                                .catch(error => console.error('Error fetching profile picture:', error));
                        }
                    }
                    
                    // For group chats, prepare member names
                    let memberDisplay = '';
                    if (isGroup) {
                        console.log('Group entity object:', entity);
                        console.log('Group members array:', entity.members);
                        if (entity.members && entity.members.length > 0) {
                            // Display member names instead of count
                            memberDisplay = entity.members.map(member => member.username).join(', ');
                            console.log('Member display string:', memberDisplay);
                        } else {
                            memberDisplay = `${entity.member_count} members`;
                            console.log('Fallback to member count:', memberDisplay);
                        }
                    } else {
                        memberDisplay = isUserOnline(entity.id || entity) ? 'online' : 'offline';
                    }

                    chatHeader.innerHTML = `
                        <div class="profile-pic" style="cursor: pointer;">
                            <img src="${profilePic}" alt="${isGroup ? entity.name : (entity.username || entity)}" 
                                 onerror="this.src='${isGroup ? '/static/images/group_logo.png' : '/static/images/contact_logo.png'}'">
                        </div>
                        <div class="chat-header-info" style="cursor: pointer;">
                            <div class="chat-header-name">${isGroup ? entity.name : (entity.username || entity)}</div>
                            <div class="chat-header-status ${!isGroup && isUserOnline(entity.id || entity) ? 'online' : 'offline'}">
                                ${isGroup 
                                    ? (entity.members && entity.members.length > 0 
                                        ? entity.members.map(member => member.username).join(', ') 
                                        : entity.member_count + ' members')
                                    : (isUserOnline(entity.id || entity) ? 'online' : 'offline')}
                            </div>
                        </div>
                    `;
                    
                    // Add event listener for profile click (both image and name/status area)
                    const profileElements = [
                        chatHeader.querySelector('.profile-pic'), 
                        chatHeader.querySelector('.chat-header-info')
                    ];
                    
                    profileElements.forEach(element => {
                        element.addEventListener('click', function() {
                            if (isGroup) {
                                showGroupInfo(entity);
                            } else {
                                // Use our new contact info sidebar instead of showUserInfo
                                showContactInfo(entity);
                            }
                        });
                    });
                };
            }, 100);
        });
        
        // Clean up existing socket listeners
        function cleanupSocketListeners() {
            socket.off('new_message');
            socket.off('message_sent');
            socket.off('notification');
            socket.off('user_status');
        }
        
        // Setup socket event listeners
        function setupSocketListeners() {
            // Clean up existing listeners first
            cleanupSocketListeners();
        
        // Handle notifications
        socket.on('notification', function(data) {
            console.log('Received notification:', data);
            
            if (data.type === 'contact_added') {
                showNotification(data.message, 'success');
                loadContacts();
            }
            else if (data.type === 'added_to_group') {
                showNotification(data.message, 'success');
                loadContacts();
                
                if (document.querySelector('.nav-icon[data-target="groups"]').classList.contains('active')) {
                    loadGroups();
                }
            }
        });
        
            // Handle new message event
        socket.on('new_message', function(data) {
            console.log('Received new_message:', data);
            
            const currentChatId = window.currentChat?.id;
            const currentChatType = window.currentChat?.type;
            const isFromCurrentUser = data.sender_id.toString() === document.documentElement.getAttribute('data-user-id');
            const timestamp = data.timestamp || Date.now();
            const messageId = data.message_id || `msg_${timestamp}_${Math.random().toString(36).substring(2, 9)}`;
            
            // Check if this message already exists in the chat to prevent duplicates
            if (document.querySelector(`[data-message-id="${messageId}"]`)) {
                console.log('Preventing duplicate message:', messageId);
                return;
            }
            
            // Update contact list for the sender
            if (!isFromCurrentUser) {
                updateContactLastMessage(data.sender_id, data.message, timestamp);
            }
            
            // Handle message display in chat
            if (data.group_id) {
                console.log('Handling group message:', data.group_id, 'current chat:', currentChatId, currentChatType);
                
                // Update group list order and message preview
                updateGroupListOrder(data.group_id, data.message, data.sender_id, data.sender_username);
                
                if (currentChatType === 'group' && currentChatId == data.group_id) {
                    const chatBody = document.querySelector('.chat-body');
                    const messageElement = createMessageElement(
                        data.message,
                        isFromCurrentUser,
                        timestamp,
                        messageId
                    );
                    
                    if (!isFromCurrentUser) {
                        const senderName = document.createElement('div');
                        senderName.className = 'message-sender';
                        senderName.style.fontSize = '12px';
                        senderName.style.color = '#00a884';
                        senderName.style.marginBottom = '2px';
                        senderName.textContent = data.sender_username;
                        messageElement.insertBefore(senderName, messageElement.firstChild);
                    }
                    
                    chatBody.appendChild(messageElement);
                    chatBody.scrollTop = chatBody.scrollHeight;
                } else {
                    showNotification(`New message in group: ${data.message}`);
                }
            } else if (currentChatType === 'direct' && (currentChatId == data.sender_id || currentChatId == data.receiver_id)) {
                const chatBody = document.querySelector('.chat-body');
                const messageElement = createMessageElement(
                    data.message,
                    isFromCurrentUser,
                    timestamp,
                    messageId
                );
                
                chatBody.appendChild(messageElement);
                chatBody.scrollTop = chatBody.scrollHeight;
            }
        });

            // Handle message sent confirmation
            socket.on('message_sent', function(data) {
                console.log('Message sent confirmation:', data);
                const timestamp = data.timestamp || Date.now();
                
                // Update contact list for the receiver
                updateContactLastMessage(data.receiver_id, data.message, timestamp);
                
                // Store the last active chat
                storeLastActiveChat(data.receiver_id, 'direct', data.receiver_username);
            });

            // Add user_status event listener
            socket.on('user_status', function(data) {
                console.log('User status update:', data);
                if (data.status === 'online') {
                    window.onlineUsers.add(data.user_id);
                } else {
                    window.onlineUsers.delete(data.user_id);
                }
                updateUserStatus(data.user_id, data.status === 'online');
            });
        }
        
        // Socket connection events
        socket.on('connect', function() {
            console.log('Connected to server');
            
            const htmlElement = document.documentElement;
            const isAuthenticated = htmlElement.getAttribute('data-authenticated') === 'true';
            
            if (isAuthenticated) {
                const userId = htmlElement.getAttribute('data-user-id');
                socket.emit('join', { room: userId });
                console.log('Joined personal room:', userId);
                
                // Request current online users
                socket.emit('request_online_users');
                
                // Setup socket listeners and load contacts
                setupSocketListeners();
                loadContacts();
            } else {
                console.log('Not authenticated, no room to join');
            }
        });
        
        socket.on('disconnect', function() {
            console.log('Disconnected from server');
            cleanupSocketListeners();
        });
        
        // Function to load contacts and groups from the backend
        function loadContacts() {
            const sidebarContent = document.querySelector('.sidebar-content');
            if (!sidebarContent) return;

            // Set up the contacts container structure
            sidebarContent.innerHTML = `
                <div class="contacts-container">
                    <div class="sidebar-header">
                        <div class="app-name" data-i18n="chat.chats">Chats</div>
                    </div>
                    <div class="search-container">
                        <div class="search-bar">
                            <svg viewBox="0 0 24 24" width="24" height="24" class="search-icon">
                                <path fill="currentColor" d="M15.009 13.805h-.636l-.22-.219a5.184 5.184 0 0 0 1.256-3.386 5.207 5.207 0 1 0-5.207 5.208 5.183 5.183 0 0 0 3.385-1.255l.221.22v.635l4.004 3.999 1.194-1.195-3.997-4.007zm-4.808 0a3.605 3.605 0 1 1 0-7.21 3.605 3.605 0 0 1 0 7.21z"></path>
                            </svg>
                            <input type="text" id="contact-search" data-i18n-placeholder="chat.search" placeholder="Search contacts" onkeyup="filterContacts()">
                        </div>
                    </div>
                    <div class="contact-list">
                        <div class="loading-contacts">Loading contacts...</div>
                    </div>
                </div>
            `;

            // Fetch contacts from server
            console.log('Fetching contacts from server...');
            fetch('/chat/contacts')
                .then(response => {
                    console.log('Contacts API response status:', response.status);
                    if (!response.ok) {
                        throw new Error('Failed to load contacts');
                    }
                    return response.json();
                })
                .then(contacts => {
                    console.log('Received contacts:', contacts);
                    const contactList = document.querySelector('.contact-list');
                    
                    if (!contacts || contacts.length === 0) {
                        contactList.innerHTML = `
                            <div class="no-contacts">
                                <p>No contacts yet</p>
                                <p>Click the "+" button below to add contacts</p>
                            </div>
                        `;
                        return;
                    }

                    // Store contacts globally for search functionality
                    window.userContacts = contacts;
                    console.log('Stored contacts in window.userContacts:', window.userContacts);

                    // Clear loading message
                    contactList.innerHTML = '';

                    // Process and sort contacts
                    const processedContacts = contacts.map(contact => {
                        const [id, username, lastMessage, lastMessageTime] = contact;
                        return {
                            id,
                            username,
                            last_message: lastMessage || '',
                            last_message_timestamp: lastMessageTime ? new Date(lastMessageTime).getTime() : 0,
                            last_message_time: lastMessageTime ? 
                                new Date(lastMessageTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false}) : ''
                        };
                    });

                    // Sort contacts by last message timestamp
                    processedContacts.sort((a, b) => b.last_message_timestamp - a.last_message_timestamp);

                    // Create contact elements
                    processedContacts.forEach(contact => {
                        const contactElement = createContactElement([contact.id, contact.username], {
                            id: contact.id,
                            username: contact.username,
                            last_message: contact.last_message,
                            last_message_time: contact.last_message_time,
                            last_message_timestamp: contact.last_message_timestamp
                        });
                        contactList.appendChild(contactElement);
                    });

                    // Load last active chat
                    const lastChat = getLastActiveChat();
                    if (lastChat) {
                        const contact = processedContacts.find(c => c.id === lastChat.id);
                        if (contact) {
                            startChatWithContact(contact.id, contact.username);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading contacts:', error);
                    const contactList = document.querySelector('.contact-list');
                    contactList.innerHTML = `
                        <div class="no-contacts">
                            <p>Error loading contacts</p>
                            <p>Please try again later</p>
                        </div>
                    `;
                });
        }

        

        function filterContacts() {
            const searchInput = document.getElementById('contact-search');
            const filter = searchInput.value.toLowerCase();
            const contactItems = document.querySelectorAll('.contact-item');
            
            contactItems.forEach(item => {
                const name = item.querySelector('.contact-name').textContent.toLowerCase();
                if (name.includes(filter)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Modify the startChatWithContact function to include event listeners
        function startChatWithContact(contactId, displayName) {
            console.log('Starting chat with contact:', contactId, displayName);
            
            // Important: Completely reset the chat state first
            window.currentChat = null;
            
            // Leave any current chat room first
            if (window.currentChat) {
                if (window.currentChat.type === 'direct') {
                    socket.emit('leave', { room: window.currentChat.id });
                } else if (window.currentChat.type === 'group') {
                    socket.emit('leave', { room: `group_${window.currentChat.id}` });
                }
            }
            
            // Clear chat display
            const chatBody = document.querySelector('.chat-body');
            if (chatBody) {
                chatBody.innerHTML = '<div class="loading-message" style="align-self: center; padding: 10px;">Loading chat...</div>';
            }
            
            // Update current chat info with correct type
            window.currentChat = {
                id: Number(contactId),  // Ensure it's a number
                type: 'direct',
                name: displayName
            };
            
            console.log('Current chat set to:', window.currentChat);
            
            // Store the last active chat
            storeLastActiveChat(contactId, 'direct', displayName);
            
            // Update chat header using the new function
            updateChatHeader({
                id: contactId,
                username: displayName
            }, false);
            
            // Load chat messages
            loadChatMessages(contactId);
            
            // Show chat interface
            const chatInterface = document.querySelector('.chat-interface');
            if (chatInterface) {
                chatInterface.style.display = 'flex';
            }

            // Highlight the active contact in the list
            document.querySelectorAll('.contact').forEach(c => c.classList.remove('contact-active'));
            const contactElement = document.querySelector(`.contact[data-contact-id="${contactId}"]`);
            if (contactElement) {
                contactElement.classList.add('contact-active');
            }
        }

        // Helper function for Enter key press
        function handleEnterPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
        
        // Function to handle contact click
        function handleContactClick() {
            // Remove active class from all contacts
            document.querySelectorAll('.contact').forEach(c => c.classList.remove('contact-active'));
            // Add active class to clicked contact
            this.classList.add('contact-active');
            
            // Get contact details
            const contactName = this.querySelector('.contact-name').textContent;
            const contactId = this.getAttribute('data-user-id');
            
            console.log(`Loading chat with ${contactName}, ID: ${contactId}`);
            
            // Set the current chat info for message sending
            window.currentChat = {
                id: contactId,
                type: 'direct',
                name: contactName
            };
            
            // Update the chat header with the selected contact's info
            document.querySelector('.chat-header-name').textContent = contactName;
            
            // Clear the current chat
            const chatBody = document.querySelector('.chat-body');
            chatBody.innerHTML = '';
            
            // Show loading indicator
            const loadingElement = document.createElement('div');
            loadingElement.className = 'message';
            loadingElement.style.alignSelf = 'center';
            loadingElement.textContent = 'Loading messages...';
            chatBody.appendChild(loadingElement);
            
            // Fetch messages for this contact from the backend
            fetch(`/chat/get_messages/${contactId}`)
                .then(response => response.json())
                .then(messages => {
                    // Remove loading indicator
                    chatBody.innerHTML = '';
                    
                    // If no messages, show a welcome message
                    if (messages.length === 0) {
                        const welcomeElement = document.createElement('div');
                        welcomeElement.className = 'message';
                        welcomeElement.style.alignSelf = 'center';
                        welcomeElement.style.backgroundColor = '#202c33';
                        welcomeElement.style.padding = '10px 15px';
                        welcomeElement.style.borderRadius = '8px';
                        welcomeElement.style.color = '#e9edef';
                        welcomeElement.textContent = `Start chatting with ${contactName}`;
                        chatBody.appendChild(welcomeElement);
                    } else {
                        // Add messages to the chat
                        messages.forEach(msg => {
                            const [senderId, receiverId, msgContent, timestamp] = msg;
                            
                            // Check if this is a sent or received message
                            const isSent = senderId.toString() === document.documentElement.getAttribute('data-user-id');
                            
                            // Create message element
                            const messageElement = document.createElement('div');
                            messageElement.className = isSent ? 'message sent' : 'message received';
                            messageElement.innerHTML = `
                                <div class="message-content">${msgContent}</div>
                                <div class="message-meta">
                                    <span class="message-timestamp">${formatMessageTimestamp(timestamp, true)}</span>
                                </div>
                            `;
                            
                            chatBody.appendChild(messageElement);
                        });
                    }
                    
                    // Scroll to bottom
                    chatBody.scrollTop = chatBody.scrollHeight;
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                    chatBody.innerHTML = '';
                    
                    const errorElement = document.createElement('div');
                    errorElement.className = 'message';
                    errorElement.style.alignSelf = 'center';
                    errorElement.style.backgroundColor = '#8B0000';
                    errorElement.style.padding = '10px 15px';
                    errorElement.style.borderRadius = '8px';
                    errorElement.style.color = '#ffffff';
                    errorElement.textContent = 'Error loading messages. Please try again.';
                    chatBody.appendChild(errorElement);
                });
        }
        
        // Function to search contacts
        function searchContacts() {
            const searchInput = document.getElementById('search-input');
            const filter = searchInput.value.toLowerCase();
            const contacts = document.querySelectorAll('.contact');
            
            contacts.forEach(contact => {
                const name = contact.querySelector('.contact-name').textContent.toLowerCase();
                if (name.includes(filter)) {
                    contact.style.display = '';
                } else {
                    contact.style.display = 'none';
                }
            });
            
            // Show no results message if all contacts are hidden
            const visibleContacts = Array.from(contacts).filter(c => c.style.display !== 'none');
            const contactList = document.getElementById('contact-list');
            const noResultsMsg = contactList.querySelector('.no-results');
            
            if (visibleContacts.length === 0 && filter) {
                if (!noResultsMsg) {
                    const noResults = document.createElement('div');
                    noResults.className = 'no-results';
                    noResults.style.color = '#8696a0';
                    noResults.style.textAlign = 'center';
                    noResults.style.padding = '20px';
                    noResults.textContent = `No contacts found for "${filter}"`;
                    contactList.appendChild(noResults);
                }
            } else if (noResultsMsg) {
                noResultsMsg.remove();
            }
        }
        
        // Function to send a message
        function sendMessage() {
            // Get message from the input
            const messageInput = document.querySelector('.message-input');
            if (messageInput) {
                const message = messageInput.value.trim();
                
                // Don't send empty messages
                if (!message) return;
                
                // Clear input
                messageInput.value = '';
                
                // Create message ID and timestamp
                const messageId = Date.now().toString() + Math.floor(Math.random() * 1000);
                const timestamp = new Date().toISOString();
                
                // Create new message element
                const chatBody = document.querySelector('.chat-body');
                const messageElement = document.createElement('div');
                
                // Use 'sent' instead of 'my-message' for consistency with other parts of the code
                messageElement.className = 'message sent';
                messageElement.setAttribute('data-message-id', messageId);
                messageElement.setAttribute('data-timestamp', timestamp);
                
                // Define isSent variable to fix the reference error
                const isSent = true;
                
                messageElement.innerHTML = `
                    <div class="message-content">${message}</div>
                    <div class="message-meta">
                        <span class="message-timestamp">${formatMessageTimestamp(timestamp, true)}</span>
                    </div>
                `;
                
                chatBody.appendChild(messageElement);
                chatBody.scrollTop = chatBody.scrollHeight;

                // Emit direct message
                socket.emit('send_message', {
                    receiver_id: window.currentChat.id,
                    message: message,
                    timestamp: timestamp,
                    message_id: messageId
                });
            }
        }

        // Attach event listeners when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Send message on Enter key
            const messageInput = document.querySelector('.message-input');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault(); // Prevent default to avoid newline
                        sendMessage();
                    }
                });
            }

            // Send message on button click
            const sendButton = document.querySelector('.send-button');
            if (sendButton) {
                sendButton.addEventListener('click', sendMessage);
            }
        });
        
        // Bottom navigation functionality
        const navIcons = document.querySelectorAll('.nav-icon');
        navIcons.forEach(icon => {
            icon.addEventListener('click', function() {
                const target = this.getAttribute('data-target');
                const mainSidebarContent = document.querySelector('.sidebar-content');

                // Remove active class from all nav icons
                navIcons.forEach(i => i.classList.remove('active'));
                // Add active class to clicked icon
                this.classList.add('active');
                
                // Ensure main content area is visible for all views
                if (mainSidebarContent) {
                    mainSidebarContent.style.display = 'flex';
                    mainSidebarContent.style.flexDirection = 'column';
                }
                
                console.log(`Switching to ${target} view`);
                
                // Handle specific targets
                if (target === 'add') {
                    showAddContactModal();
                } else if (target === 'contacts') {
                    showMainSidebar();
                } else if (target === 'groups') {
                    showGroupsView();
                } else if (target === 'settings') {
                    showSettingsSidebar();
                }
            });
        });
        
        // Function to show settings sidebar
        function showSettingsSidebar() {
            // Get the sidebar content
            const sidebarContent = document.querySelector('.sidebar-content');
            
            // Set settings tab as active
            document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
            document.querySelector('.nav-icon[data-target="settings"]').classList.add('active');
            
            // Update sidebar content with settings view
            sidebarContent.innerHTML = `
                <div class="sidebar-header">
                    <div class="app-name" data-i18n="settings.title">Settings</div>
                    <div class="sidebar-header-icons">
                        <div class="close-settings" style="cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- Profile Section -->
                <div class="profile-section">
                    <div class="profile-header">
                        <div class="profile-avatar-container">
                            <div class="profile-avatar">
                                <img id="profile-avatar-img" src="/api/placeholder/100/100" alt="Profile">
                                <div class="avatar-edit">
                                    <i class="fa-solid fa-camera"></i>
                                </div>
                            </div>
                        </div>
                        <div class="profile-info">
                            <div class="profile-nickname" id="profile-nickname">Loading...</div>
                            <div class="profile-name">
                                <input type="text" id="profile-name-input" placeholder="Your Name">
                            </div>
                        </div>
                    </div>
                    <div class="profile-bio">
                        <textarea id="profile-bio-input" placeholder="Write something about yourself..."></textarea>
                    </div>
                </div>

                <!-- Settings Section -->
                <div class="settings-section">
                    <div class="settings-list">
                        <div class="settings-item" id="language-settings">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M12 22.0005C5.07 22.0005 1.5 18.5205 1.5 12.0005C1.5 5.48047 5.07 2.00047 12 2.00047C18.93 2.00047 22.5 5.48047 22.5 12.0005C22.5 18.5205 18.93 22.0005 12 22.0005ZM12 3.50047C5.82 3.50047 3 6.24047 3 12.0005C3 17.7605 5.82 20.5005 12 20.5005C18.18 20.5005 21 17.7605 21 12.0005C21 6.24047 18.18 3.50047 12 3.50047ZM15.53 13.8805C15.82 13.2405 16 12.9505 16 12.0005C16 11.0505 15.82 10.7605 15.53 10.1205C15.37 9.78047 15.1 9.50047 14.79 9.27047C14.43 9.00047 14.25 8.77047 14.25 7.75047V7.50047C14.25 6.94047 13.81 6.50047 13.25 6.50047H10.75C10.19 6.50047 9.75 6.94047 9.75 7.50047V7.72047C9.75 8.69047 9.59 8.87047 9.33 9.11047C9 9.42047 8.71 9.75047 8.5 10.1705C8.19 10.8005 8 11.1505 8 12.0005C8 12.8505 8.19 13.1905 8.48 13.7905C8.71 14.1905 9 14.5305 9.34 14.8505C9.58 15.0605 9.75 15.2805 9.75 16.2405V16.5005C9.75 17.0605 10.19 17.5005 10.75 17.5005H13.25C13.81 17.5005 14.25 17.0605 14.25 16.5005V16.2405C14.25 15.2805 14.41 15.0605 14.67 14.8305C15 14.5305 15.3 14.2005 15.53 13.8805ZM12 14.0005C10.9 14.0005 10 13.1005 10 12.0005C10 10.9005 10.9 10.0005 12 10.0005C13.1 10.0005 14 10.9005 14 12.0005C14 13.1005 13.1 14.0005 12 14.0005Z"></path>
                            </svg>
                            <span data-i18n="settings.language">Change Language</span>
                        </div>
                        <div class="settings-item" id="password-settings">
                            <i class="fa-solid fa-key"></i>
                            <span data-i18n="settings.password">Change Password</span>
                        </div>
                        <div class="settings-item" id="admin-panel">
                            <i class="fa-solid fa-user-shield"></i>
                            <span data-i18n="settings.admin">Admin Panel</span>
                        </div>
                        <div class="settings-item" id="logout-button">
                            <i class="fa-solid fa-right-from-bracket"></i>
                            <span data-i18n="settings.logout">Logout</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Make sure the sidebar content is visible
            sidebarContent.style.display = "flex";
            sidebarContent.style.flexDirection = "column";
            
            // Add event listeners
            const closeButton = sidebarContent.querySelector('.close-settings');
            const languageSettings = sidebarContent.querySelector('#language-settings');
            const passwordSettings = sidebarContent.querySelector('#password-settings');
            const adminPanel = sidebarContent.querySelector('#admin-panel');
            const logoutButton = sidebarContent.querySelector('#logout-button');
            const avatarEdit = sidebarContent.querySelector('.avatar-edit');
            
            if (closeButton) {
                closeButton.addEventListener("click", () => {
                    showMainSidebar();
                });
            }
            
            if (languageSettings) {
                languageSettings.addEventListener("click", showLanguageSettings);
            }
            
            if (passwordSettings) {
                passwordSettings.addEventListener("click", showPasswordSettings);
            }
            
            if (adminPanel) {
                adminPanel.addEventListener("click", () => {
                    loadAdminPanel();
                });
            }
            
            if (logoutButton) {
                logoutButton.addEventListener("click", () => {
                    showLogoutConfirmation();
                });
            }
            
            if (avatarEdit) {
                avatarEdit.addEventListener("click", () => {
                    openProfilePictureUpload();
                });
            }
            
            // Load user profile data
            loadProfileData();
        }
        
        // Function to show the add contact modal
        function showAddContactModal() {
            // Get the sidebar content
            const sidebarContent = document.querySelector('.sidebar-content');
            
            if (!sidebarContent) {
                console.error('Sidebar content not found');
                return;
            }
            
            // Make sure the sidebar content is visible and flex column
            sidebarContent.style.display = 'flex';
            sidebarContent.style.flexDirection = 'column';
            sidebarContent.style.height = '100%'; // Ensure full height
            
            // Save the current sidebar content (to restore on back button)
            // We need to capture this *before* overwriting innerHTML
            const originalContentState = sidebarContent.innerHTML;
            window.originalSidebarState = originalContentState; // Store globally or pass if needed
            
            // Create and show the add contact interface in the sidebar
            sidebarContent.innerHTML = `
                <div class="sidebar-header">
                    <div style="display: flex; align-items: center;">
                        <div id="back-to-contacts" style="margin-right: 15px; cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 11H7.83l4.88-4.88c.39-.39.39-1.03 0-1.42-.39-.39-1.02-.39-1.41 0l-6.59 6.59c-.39.39-.39 1.02 0 1.41l6.59 6.59c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L7.83 13H19c.55 0 1-.45 1-1s-.45-1-1-1z"></path>
                            </svg>
                        </div>
                        <div class="app-name">Add New Contact</div>
                    </div>
                </div>
                
                <div style="padding: 10px 15px; background-color: transparent;">
                    <div class="search-bar" style="border-radius: 20px 0 20px 20px;">
                        <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                            <path fill="currentColor" d="M15.009 13.805h-.636l-.22-.219a5.184 5.184 0 0 0 1.256-3.386 5.207 5.207 0 1 0-5.207 5.208 5.183 5.183 0 0 0 3.385-1.255l.221.22v.635l4.004 3.999 1.194-1.195-3.997-4.007zm-4.808 0a3.605 3.605 0 1 1 0-7.21 3.605 3.605 0 0 1 0 7.21z"></path>
                        </svg>
                        <input type="text" id="search-user" placeholder="Search by Username or Email">
                    </div>
                </div>
                
                <div id="all-users-list" style="overflow-y: auto; flex: 1; background-color: transparent;">
                    <!-- User list will be loaded here -->
                    <div class="loading-users" style="text-align: center; color: #333; padding: 20px;">
                        Loading users...
                    </div>
                </div>

                <div class="add-contact-footer">
                    <button id="add-selected-contact-btn" disabled>Add Selected Contact</button>
                </div>
            `;
            
            // Add event listeners
            document.getElementById('back-to-contacts').addEventListener('click', function() {
                // Restore original sidebar content using the stored state
                if (window.originalSidebarState) {
                    sidebarContent.innerHTML = window.originalSidebarState;
                    // Ensure display is correct after restoring
                    sidebarContent.style.display = 'flex'; 
                    sidebarContent.style.flexDirection = 'column';
                    // Reattach necessary listeners for the main view
                    reattachContactEventListeners(); // Make sure this function exists and works
                    loadContacts(); // Reload contacts/chats
                } else {
                    // Fallback if state wasn't saved
                    showMainSidebar(); 
                }
                
                // Set contacts tab as active
                document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
                const contactsIcon = document.querySelector('.nav-icon[data-target="contacts"]');
                if (contactsIcon) contactsIcon.classList.add('active');
            });
            
            const searchInput = document.getElementById('search-user');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.trim();
                    // Trigger search even if empty to potentially show all users again
                    searchUsers(searchTerm);
                });
                
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const searchTerm = this.value.trim();
                        searchUsers(searchTerm);
                    }
                });
            }

            // Add listener for the new bottom button
            document.getElementById('add-selected-contact-btn').addEventListener('click', function() {
                const usersListContainer = document.getElementById('all-users-list');
                const selectedUserId = usersListContainer.getAttribute('data-selected-user-id');
                
                if (selectedUserId) {
                    // --- Check if contact already exists --- 
                    let contactExists = false;
                    if (window.userContacts && Array.isArray(window.userContacts)) {
                        // Assuming window.userContacts is an array of arrays like [[id, name], ...]
                        // Or it might be an array of objects {id: ..., name: ...} - check loadContacts implementation
                        // Let's check based on the structure from loadContacts: [[id, name], ...]
                         contactExists = window.userContacts.some(contact => contact[0] == selectedUserId);
                         // If structure is {id: ..., ...}, use: window.userContacts.some(contact => contact.id == selectedUserId);
                    }
                    
                    if (contactExists) {
                        showNotification('This user is already in your contacts.', 'warning');
                        return; // Stop execution
                    }
                    // --- End check --- 

                    if (confirm('Add this user to your contacts?')) {
                        addContact(selectedUserId); 
                        // addContact handles success/error and navigation
                    }
                } else {
                    showNotification('Please select a user from the list first.', 'warning');
                }
            });

            // Load all users immediately
            loadAllUsers(); 
        }
        
        // Function to load all users (excluding self) into the add contact list
        function loadAllUsers() {
            const usersListContainer = document.getElementById('all-users-list');
            if (!usersListContainer) return; // Exit if container not found
            
            usersListContainer.innerHTML = '<div class="loading-users" style="text-align: center; color: #e9edef; padding: 20px;">Loading users...</div>';
            // Reset selection state
            usersListContainer.removeAttribute('data-selected-user-id');
            document.getElementById('add-selected-contact-btn').disabled = true;
            
            fetch('/chat/user_info') // Endpoint that gets all users except current
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(users => {
                    renderUserList(users, usersListContainer);
                })
                .catch(error => {
                    console.error('Error loading all users:', error);
                    usersListContainer.innerHTML = '<div style="text-align: center; color: #ff6b6b; padding: 20px;">Error loading users. Please try again.</div>';
                });
        }

        // Function to render a list of users (used by loadAllUsers and searchUsers)
        function renderUserList(users, container) {
            container.innerHTML = ''; // Clear previous content or loading message
            
            if (!users || users.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #333; padding: 20px;">No users found.</div>';
                // Ensure button is disabled if no users
                container.removeAttribute('data-selected-user-id');
                const addButton = document.getElementById('add-selected-contact-btn');
                if (addButton) addButton.disabled = true;
                return;
            }
            
            users.forEach(user => {
                // Skip if user object is somehow invalid
                if (!user || !user.id || !user.username) return;

                const userElement = document.createElement('div');
                userElement.className = 'user-item'; // Add a class for styling and selection
                userElement.setAttribute('data-user-id', user.id);
                userElement.style.padding = '10px 15px';
                userElement.style.display = 'flex';
                userElement.style.alignItems = 'center';
                userElement.style.justifyContent = 'space-between'; // Keep space for potential future icons
                userElement.style.borderBottom = 'none';
                userElement.style.cursor = 'pointer';
                userElement.style.backgroundColor = 'rgba(255, 255, 255, 0.6)';
                userElement.style.margin = '5px';
                userElement.style.borderRadius = '20px';
                
                // Highlight on hover
                userElement.addEventListener('mouseover', function() {
                    // Don't change background if it's selected
                    if (!this.classList.contains('user-selected')) {
                        this.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
                    }
                });
                userElement.addEventListener('mouseout', function() {
                    // Don't change background if it's selected
                    if (!this.classList.contains('user-selected')) {
                        this.style.backgroundColor = 'rgba(255, 255, 255, 0.6)';
                    }
                });
                
                const profilePic = user.profile_picture 
                    ? `/uploads/profile_photos/${user.profile_picture}` 
                    : 'Backend/static/images/contact_logo.png'; // Use placeholder API
                    
                userElement.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden; margin-right: 10px;">
                            <img src="${profilePic}" alt="${user.username}" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div>
                            <div style="color: #333; font-weight: bold;">${user.username}</div>
                            <div style="color: #333; font-size: 12px;">${user.email || user.name || ''}</div>
                        </div>
                    </div>
                    <!-- Removed individual add button -->
                `;
                
                // Add click listener for selection
                userElement.addEventListener('click', function() {
                    const clickedUserId = this.getAttribute('data-user-id');
                    const allUserItems = container.querySelectorAll('.user-item');
                    const addButton = document.getElementById('add-selected-contact-btn');
                    
                    // Deselect if clicking the already selected user
                    if (this.classList.contains('user-selected')) {
                        this.classList.remove('user-selected');
                        this.style.backgroundColor = 'rgba(255, 255, 255, 0.6)'; // Reset to normal background
                        container.removeAttribute('data-selected-user-id');
                        if (addButton) addButton.disabled = true;
                    } else {
                        // Remove selection from others
                        allUserItems.forEach(item => {
                            item.classList.remove('user-selected');
                            item.style.backgroundColor = 'rgba(255, 255, 255, 0.6)'; // Reset background for all
                        });
                        
                        // Select the clicked one
                        this.classList.add('user-selected');
                        this.style.backgroundColor = 'rgba(255, 255, 255, 0.8)'; // Set selected background
                        container.setAttribute('data-selected-user-id', clickedUserId);
                        if (addButton) addButton.disabled = false;
                    }
                });
                
                container.appendChild(userElement);
            });
        }

        // Function to search for users (MODIFIED)
        function searchUsers(searchTerm) {
            const resultsContainer = document.getElementById('all-users-list'); // Target the same list container
            if (!resultsContainer) return;

            // If search term is empty, load all users instead
            if (!searchTerm || searchTerm.trim() === '') {
                loadAllUsers();
                return;
            }

            resultsContainer.innerHTML = '<div style="text-align: center; color: #333; padding: 20px;">Searching...</div>';
            // Reset selection state during search
            resultsContainer.removeAttribute('data-selected-user-id');
            const addButton = document.getElementById('add-selected-contact-btn');
             if (addButton) addButton.disabled = true;
            
            fetch(`/chat/search_users?term=${encodeURIComponent(searchTerm)}`)
                .then(response => {
                     if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json()
                })
                .then(users => {
                    // Use the common render function
                    renderUserList(users, resultsContainer);
                })
                .catch(error => {
                    console.error('Error searching users:', error);
                    resultsContainer.innerHTML = '<div style="text-align: center; color: #ff6b6b; padding: 20px;">Error searching users</div>';
                });
        }
        
        // Function to add a contact
        function addContact(contactId) {
            fetch('/chat/add_contact', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ contact_id: contactId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === "Contact added") {
                    // Show success message
                    showNotification('Contact added successfully', 'success');
                    
                    // Reload contacts to show the new contact
                    if (document.querySelector('.nav-icon[data-target="contacts"]').classList.contains('active')) {
                        loadContacts();
                    }
                    
                    // Return to contacts view
                    const backButton = document.getElementById('back-to-contacts');
                    if (backButton) {
                        backButton.click();
                    }
                } else {
                    showNotification('Failed to add contact: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error adding contact:', error);
                showNotification('Failed to add contact. Please try again.', 'error');
            });
        }
        
        // Function to reattach event listeners to contacts after sidebar content is restored
        function reattachContactEventListeners() {
            // Reattach event listeners to search box
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('keyup', searchContacts);
            }
            
            // Reattach event listeners to contacts
            document.querySelectorAll('.contact').forEach(contact => {
                contact.addEventListener('click', handleContactClick);
            });
        }
        
        // Function to show notification
        function showNotification(message, type = 'info', duration = 5000) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'notification-toast';
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.right = '20px';
            
            // Set color based on notification type
            let backgroundColor;
            switch(type) {
                case 'success':
                    backgroundColor = '#00a884';
                    break;
                case 'error':
                    backgroundColor = '#f15c6d';
                    break;
                case 'warning':
                    backgroundColor = '#ffa000';
                    break;
                default: // info
                    backgroundColor = '#005c4b';
            }
            
            notification.style.backgroundColor = backgroundColor;
            notification.style.color = 'white';
            notification.style.padding = '12px 20px';
            notification.style.borderRadius = '8px';
            notification.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
            notification.style.zIndex = '9999';
            notification.style.maxWidth = '300px';
            notification.style.wordBreak = 'break-word';
            notification.innerText = message;
            
            // Add to document
            document.body.appendChild(notification);
            
            // Remove after specified duration
            setTimeout(function() {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s ease';
                setTimeout(function() {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 500);
            }, duration);
        }
        
        // Function to show groups view
        function showGroupsView() {
            // Get the sidebar content
            const sidebarContent = document.querySelector('.sidebar-content');
            
            // Save the current sidebar content
            const originalContent = sidebarContent.innerHTML;
            
            // Update sidebar content with groups view
            sidebarContent.innerHTML = `
                <div class="sidebar-header">
                    <div class="app-name">Groups</div>
                    <div class="sidebar-header-icons">
                        <div id="create-group-button" style="cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="search-container">
                    <div class="search-bar">
                        <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                            <path fill="currentColor" d="M15.009 13.805h-.636l-.22-.219a5.184 5.184 0 0 0 1.256-3.386 5.207 5.207 0 1 0-5.207 5.208 5.183 5.183 0 0 0 3.385-1.255l.221.22v.635l4.004 3.999 1.194-1.195-3.997-4.007zm-4.808 0a3.605 3.605 0 1 1 0-7.21 3.605 3.605 0 0 1 0 7.21z"></path>
                        </svg>
                        <input type="text" id="group-search-input" placeholder="Search groups" onkeyup="searchGroups()">
                    </div>
                </div>
                
                <div id="groups-list" class="contact-list">
                    <div class="loading-groups" style="color: #8696a0; text-align: center; padding: 20px;">
                        Loading groups...
                    </div>
                </div>
            `;
            
            // Add event listener for creating new group
            document.getElementById('create-group-button').addEventListener('click', showCreateGroupView);
            
            // Load the user's groups
            loadGroups();
        }
        
        // Function to show create group view
        function showCreateGroupView() {
            // Get the sidebar content
            const sidebarContent = document.querySelector('.sidebar-content');
            
            // Save the current sidebar content if it's not already saved
            if (!window.originalSidebarState) {
                window.originalSidebarState = sidebarContent.innerHTML;
            }
            
            // Create and show the first step (contact selection) interface
            sidebarContent.innerHTML = `
                <div class="sidebar-header" style="background-color: transparent;">
                    <div style="display: flex; align-items: center;">
                        <div id="back-to-groups" style="margin-right: 15px; cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 11H7.83l4.88-4.88c.39-.39.39-1.03 0-1.42-.39-.39-1.02-.39-1.41 0l-6.59 6.59c-.39.39-.39 1.02 0 1.41l6.59 6.59c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L7.83 13H19c.55 0 1-.45 1-1s-.45-1-1-1z"></path>
                            </svg>
                        </div>
                        <div class="app-name">Select Contacts</div>
                    </div>
                </div>
                
                <div style="padding: 15px; background-color: transparent;">
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; color: #333; margin-bottom: 5px;">Select Members</label>
                        <div style="display: flex;">
                            <input type="text" id="search-members" style="flex: 1; padding: 10px; background-color: #fff; border: 1px solid #333; color: #000; border-radius: 20px; outline: none; font-size: 15px;" placeholder="Search contacts" onfocus="this.style.borderColor='#00a884'" onblur="this.style.borderColor='#333'">
                        </div>
                    </div>
                </div>
                
                <div style="padding: 10px 15px; background-color: transparent; border-bottom: 1px solid rgba(0, 0, 0, 0.1);">
                    <div style="color: #333; font-size: 14px; margin-bottom: 5px;">Selected Contacts (<span id="selected-count">0</span>)</div>
                    <div id="selected-members" style="display: flex; flex-wrap: wrap; gap: 5px;"></div>
                </div>
                
                <div id="contact-selection-list" style="overflow-y: auto; flex: 1; background-color: transparent;">
                    <div style="text-align: center; color: #666; padding: 20px;">
                        Loading contacts...
                    </div>
                </div>
                
                <div style="padding: 15px; background-color: transparent; border-top: 1px solid rgba(0, 0, 0, 0.1);">
                    <button id="next-step-btn" style="width: 100%; padding: 12px; background-color: rgba(0, 168, 132, 0.8); color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 16px; font-weight: bold; opacity: 0.5;" disabled>
                        Next
                    </button>
                </div>
            `;
            
            // Add event listener to back button
            const backButton = document.getElementById('back-to-groups');
            if (backButton) {
                backButton.addEventListener('click', function() {
                    // Clear selected members when going back to groups list
                    selectedMembers.clear();
                    
                    // Restore original sidebar content
                    if (window.originalSidebarState) {
                        sidebarContent.innerHTML = window.originalSidebarState;
                        window.originalSidebarState = null; // Clear the saved state
                    }
                    
                    // Reattach event listener to create group button
                    const createGroupButton = document.getElementById('create-group-button');
                    if (createGroupButton) {
                        createGroupButton.addEventListener('click', showCreateGroupView);
                    }
                    
                    // Load the groups
                    loadGroups();
                });
            }
            
            // Add event listener for next step button
            const nextStepBtn = document.getElementById('next-step-btn');
            if (nextStepBtn) {
                nextStepBtn.addEventListener('click', function() {
                    showGroupDetailsStep();
                });
            }
            
            // Load contacts for selection
            loadContactsForGroupCreation();
        }
        
        // Function to show the second step (group details)
        function showGroupDetailsStep() {
            const sidebarContent = document.querySelector('.sidebar-content');
            
            sidebarContent.innerHTML = `
                <div class="sidebar-header" style="background-color: transparent;">
                    <div style="display: flex; align-items: center;">
                        <div id="back-to-contact-selection" style="margin-right: 15px; cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 11H7.83l4.88-4.88c.39-.39.39-1.03 0-1.42-.39-.39-1.02-.39-1.41 0l-6.59 6.59c-.39.39-.39 1.02 0 1.41l6.59 6.59c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L7.83 13H19c.55 0 1-.45 1-1s-.45-1-1-1z"></path>
                            </svg>
                        </div>
                        <div class="app-name">Group Details</div>
                    </div>
                </div>
                
                <div style="padding: 15px; background-color: transparent;">
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="group-name" style="display: block; color: #111; margin-bottom: 5px; font-weight: bold; font-size: 15px;">Group Name</label>
                        <input type="text" id="group-name" style="width: 100%; padding: 10px; background-color: #fff; border: 1px solid #333; color: #000; border-radius: 20px; outline: none; font-size: 15px;" placeholder="Enter group name" onfocus="this.style.borderColor='#00a884'" onblur="this.style.borderColor='#333'">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; color: #111; margin-bottom: 5px; font-weight: bold; font-size: 15px;">Group Avatar</label>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div id="group-avatar-preview" style="width: 80px; height: 80px; border-radius: 50%; overflow: hidden; background-color: #fff; border: 2px solid #333; display: flex; justify-content: center; align-items: center;">
                                <img src="Backend/static/images/group_logo.png" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                            <div style="flex: 1;">
                                <input type="file" id="group-avatar-input" accept="image/*" style="display: none;">
                                <button type="button" id="upload-avatar-btn" style="padding: 8px 15px; background-color: #fff; color: #000; border: 1px solid #333; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: bold;" onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='#fff'">
                                    Upload Avatar
                                </button>
                                <div style="color: #444; font-size: 12px; margin-top: 5px;">
                                    Recommended size: 200x200 pixels
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background-color: transparent; padding: 15px; border-radius: 20px;">
                        <div style="font-size: 15px; color: #111; margin-bottom: 10px; font-weight: bold;">Selected Members (${selectedMembers.size})</div>
                        <div id="selected-members-list" style="display: flex; flex-wrap: wrap; gap: 10px;">
                            ${Array.from(selectedMembers.values()).map(member => `
                                <div style="display: flex; align-items: center; background-color: transparent; padding: 5px 10px; border-radius: 15px;">
                                    <img src="${member.profilePic}" alt="${member.name}" style="width: 20px; height: 20px; border-radius: 50%; margin-right: 5px;">
                                    <span style="color: #333; font-size: 14px;">${member.name}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                <div style="padding: 15px; background-color: transparent; border-top: 1px solid rgba(0, 0, 0, 0.1);">
                    <button id="create-group-btn" style="width: 100%; padding: 12px; background-color: rgba(0, 168, 132, 0.8); color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 16px; font-weight: bold; opacity: 0.5;" disabled>
                        Create Group
                    </button>
                </div>
            `;
            
            // Add event listener for back button
            const backButton = document.getElementById('back-to-contact-selection');
            if (backButton) {
                backButton.addEventListener('click', function() {
                    showCreateGroupView();
                });
            }
            
            // Add event listeners for avatar upload
            const avatarInput = document.getElementById('group-avatar-input');
            const uploadButton = document.getElementById('upload-avatar-btn');
            const avatarPreview = document.getElementById('group-avatar-preview');
            
            if (uploadButton && avatarInput) {
                uploadButton.addEventListener('click', function() {
                    avatarInput.click();
                });
                
                avatarInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // Check if file is an image
                        if (!file.type.startsWith('image/')) {
                            showNotification('Please select an image file', 'error');
                            return;
                        }
                        
                        // Check file size (max 5MB)
                        if (file.size > 5 * 1024 * 1024) {
                            showNotification('Image size should be less than 5MB', 'error');
                            return;
                        }
                        
                        // Create preview
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            if (avatarPreview) {
                                avatarPreview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            
            // Add event listener for group name input
            const groupNameInput = document.getElementById('group-name');
            if (groupNameInput) {
                groupNameInput.addEventListener('input', function() {
                    updateCreateGroupButton();
                });
            }
            
            // Add event listener for create group button
            const createGroupBtn = document.getElementById('create-group-btn');
            if (createGroupBtn) {
                createGroupBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    createNewGroup();
                });
            }
        }
        
        // Function to load contacts for group creation
        
        
        // Selected members for group creation
        const selectedMembers = new Map();
        
        // Function to add a selected member
        function addSelectedMember(id, name, profilePic) {
            selectedMembers.set(id, { id, name, profilePic });
            updateSelectedMembersList();
            updateNextStepButton();
        }
        
        // Function to remove a selected member
        function removeSelectedMember(id) {
            selectedMembers.delete(id);
            updateSelectedMembersList();
            updateNextStepButton();
        }
        
        // Function to filter contacts for group creation
        function filterContactsForGroupCreation(searchTerm) {
            const contacts = document.querySelectorAll('.contact-selection-item');
            
            contacts.forEach(contact => {
                const name = contact.getAttribute('data-contact-name').toLowerCase();
                if (name.includes(searchTerm)) {
                    contact.style.display = '';
                } else {
                    contact.style.display = 'none';
                }
            });
        }
        
        // Function to update create group button state
        function updateCreateGroupButton() {
            const createButton = document.getElementById('create-group-btn');
            const groupName = document.getElementById('group-name').value.trim();
            
            // Enable button if there's a group name and at least 2 members selected
            if (groupName && selectedMembers.size >= 2) {
                createButton.style.opacity = '1';
                createButton.disabled = false;
            } else {
                createButton.style.opacity = '0.5';
                createButton.disabled = true;
            }
        }
        
        // Add event listener to group name input
        document.addEventListener('input', function(e) {
            if (e.target && e.target.id === 'group-name') {
                updateCreateGroupButton();
            }
        });
        
        // Function to create a new group
        function createNewGroup() {
            const groupName = document.getElementById('group-name').value.trim();
            const avatarFile = document.getElementById('group-avatar-input').files[0];
            
            // Validate inputs
            if (!groupName) {
                showNotification('Please enter a group name', 'error');
                return;
            }
            
            if (selectedMembers.size < 2) {
                showNotification('Please select at least 2 contacts', 'error');
                return;
            }
            
            // Disable button and show loading state
            const createButton = document.getElementById('create-group-btn');
            const originalButtonText = createButton.textContent;
            createButton.disabled = true;
            createButton.textContent = 'Creating...';
            
            // Prepare member IDs
            const memberIds = Array.from(selectedMembers.keys());
            
            // Create FormData for file upload
            const formData = new FormData();
            formData.append('group_name', groupName);
            
            // Add each member ID separately instead of as JSON string
            memberIds.forEach(id => {
                formData.append('member_ids', id);
            });
            
            if (avatarFile) {
                formData.append('group_picture', avatarFile);
            }
            
            // Send request to create group
            fetch('/chat/create_group', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === "Group created successfully") {
                    showNotification('Group created successfully', 'success');
                    
                    // Reset selectedMembers for next time
                    selectedMembers.clear();
                    
                    // Go back to groups view
                    if (window.originalSidebarState) {
                        const sidebarContent = document.querySelector('.sidebar-content');
                        sidebarContent.innerHTML = window.originalSidebarState;
                    }
                    
                    // Set groups tab as active and load groups
                    document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
                    document.querySelector('.nav-icon[data-target="groups"]').classList.add('active');
                    showGroupsView();
                } else {
                    showNotification('Failed to create group: ' + data.message, 'error');
                    // Reset button
                    createButton.disabled = false;
                    createButton.textContent = originalButtonText;
                }
            })
            .catch(error => {
                console.error('Error creating group:', error);
                showNotification('Failed to create group. Please try again.', 'error');
                
                // Reset button
                createButton.disabled = false;
                createButton.textContent = originalButtonText;
            });
        }
        
        // Function to load the user's groups
        function loadGroups() {
            const groupsList = document.getElementById('groups-list');
            
            fetch('/chat/groups')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load groups');
                    }
                    return response.json();
                })
                .then(groups => {
                    groupsList.innerHTML = '';
                    
                    if (groups.length === 0) {
                        groupsList.innerHTML = '<div class="no-groups" style="color: #8696a0; text-align: center; padding: 20px;">No groups found. Create a new group to get started.</div>';
                        return;
                    }
                    
                    // Sort groups by last message time (most recent first)
                    groups.sort((a, b) => {
                        if (!a.last_message_time && !b.last_message_time) return 0;
                        if (!a.last_message_time) return 1;
                        if (!b.last_message_time) return -1;
                        return new Date(b.last_message_time) - new Date(a.last_message_time);
                    });
                    
                    // Create group elements
                    groups.forEach(group => {
                        const groupElement = document.createElement('div');
                        groupElement.className = 'contact';
                        groupElement.setAttribute('data-group-id', group.id);
                        
                        // Format last message time if it exists
                        let lastMessageTime = '';
                        if (group.last_message_time) {
                            const date = new Date(group.last_message_time);
                            lastMessageTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});
                        }
                        
                        // Get last message preview
                        let lastMessagePreview = 'No messages yet';
                        if (group.last_message) {
                            const currentUserId = document.documentElement.getAttribute('data-user-id');
                            const isFromCurrentUser = group.last_message_sender_id == currentUserId;
                            lastMessagePreview = isFromCurrentUser ? 
                                `You: ${group.last_message}` : 
                                `${group.last_message_sender}: ${group.last_message}`;
                        }
                        
                        groupElement.innerHTML = `
                            <div class="contact-avatar">
                                <img src="${group.picture ? `/uploads/group_images/${group.picture}` : 'Backend/static/images/group_logo.png'}" alt="${group.name}">
                            </div>
                            <div class="contact-info">
                                <div class="contact-name">${group.name}</div>
                                <div class="contact-message-container">
                                    <div class="contact-status">${lastMessagePreview}</div>
                                </div>
                            </div>
                            <div class="contact-meta">
                                <div class="message-time">${lastMessageTime}</div>
                            </div>
                        `;
                        
                        // Add click event to load group chat
                        groupElement.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // Remove active class from all contacts
                            document.querySelectorAll('.contact').forEach(c => c.classList.remove('contact-active'));
                            // Add active class to this group
                            this.classList.add('contact-active');
                            
                            const groupId = this.getAttribute('data-group-id');
                            console.log('Group clicked - loading group chat with ID:', groupId);
                            
                            // Stop any ongoing processes
                            if (window.loadingChatPromise) {
                                window.loadingChatPromise.cancel = true;
                            }
                            
                            // Load the group chat with a new promise
                            loadGroupChat(groupId);
                        });
                        
                        groupsList.appendChild(groupElement);
                    });
                })
                .catch(error => {
                    console.error('Error loading groups:', error);
                    groupsList.innerHTML = '<div class="error" style="color: #8696a0; text-align: center; padding: 20px;">Failed to load groups. Please try again.</div>';
                });
        }
        
        // Function to search groups
        function searchGroups() {
            const searchInput = document.getElementById('group-search-input');
            const filter = searchInput.value.toLowerCase();
            const groups = document.querySelectorAll('#groups-list .contact');
            
            groups.forEach(group => {
                const name = group.querySelector('.contact-name').textContent.toLowerCase();
                if (name.includes(filter)) {
                    group.style.display = '';
                } else {
                    group.style.display = 'none';
                }
            });
            
            // Show no results message if all groups are hidden
            const visibleGroups = Array.from(groups).filter(g => g.style.display !== 'none');
            const groupsList = document.getElementById('groups-list');
            const noResultsMsg = groupsList.querySelector('.no-results');
            
            if (visibleGroups.length === 0 && filter) {
                if (!noResultsMsg) {
                    const noResults = document.createElement('div');
                    noResults.className = 'no-results';
                    noResults.style.color = '#8696a0';
                    noResults.style.textAlign = 'center';
                    noResults.style.padding = '20px';
                    noResults.textContent = `No groups found for "${filter}"`;
                    groupsList.appendChild(noResults);
                }
            } else if (noResultsMsg) {
                noResultsMsg.remove();
            }
        }
        
        // Function to load a group chat
        function loadGroupChat(groupId) {
            console.log('Loading group chat with ID:', groupId);
            
            // Important: Completely reset any ongoing chat first
            window.currentChat = null;
            
            // Leave any current chat room first
            if (window.currentChat) {
                if (window.currentChat.type === 'direct') {
                    socket.emit('leave', { room: window.currentChat.id });
                } else if (window.currentChat.type === 'group') {
                    socket.emit('leave', { room: `group_${window.currentChat.id}` });
                }
            }
            
            // Show chat interface
            const chatInterface = document.querySelector('.chat-interface');
            if (chatInterface) {
                chatInterface.style.display = 'flex';
            }
            
            // Clear chat display
            const chatBody = document.querySelector('.chat-body');
            if (chatBody) {
                chatBody.innerHTML = '<div class="loading-message" style="align-self: center; padding: 10px;">Loading group chat...</div>';
            }
            
            // First, get the group info
            fetch(`/chat/group/${groupId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load group info');
                    }
                    return response.json();
                })
                .then(group => {
                    console.log('Group info loaded:', group);
                    console.log('Group members array:', group.members);
                    console.log('Group members count:', group.member_count);
                    
                    // Check if members are available
                    if (group.members && group.members.length > 0) {
                        console.log('Found ' + group.members.length + ' members in the group data');
                        console.log('First few members:', group.members.slice(0, 3));
                    } else {
                        console.warn('No members array found in the group data, or it is empty');
                    }
                    
                    // IMPORTANT: Force set the chat type to group right here
                    window.currentChat = {
                        id: Number(groupId),  // Ensure it's a number
                        type: 'group',
                        name: group.name,
                        entity: group
                    };
                    
                    console.log('Current chat set to:', window.currentChat);
                    
                    // Test if members data is received correctly
                    if (group.members && group.members.length > 0) {
                        const memberNames = group.members.map(member => member.username).join(', ');
                        // showNotification(`Group members: ${memberNames}`, 'info', 5000); // Removed as per request
                    } else {
                        // showNotification(`Group has ${group.member_count} members, but member details are not available.`, 'warning', 5000); // Removed as per request
                    }
                    
                    // Store the last active chat
                    storeLastActiveChat(groupId, 'group', group.name);
                    
                    // Update the chat header with group info
                    updateChatHeader(group, true);
                    
                    // Force refresh header after a short delay to ensure members are shown
                    setTimeout(() => {
                        const chatHeader = document.querySelector('.chat-header');
                        if (chatHeader && group.members && group.members.length > 0) {
                            const memberNamesList = group.members.map(member => member.username).join(', ');
                            const statusElement = chatHeader.querySelector('.chat-header-status');
                            if (statusElement) {
                                statusElement.textContent = memberNamesList;
                                console.log('Directly updated header status with member names:', memberNamesList);
                            }
                        }
                    }, 3000);
                    
                    // Join the group's Socket.IO room
                    const roomName = `group_${groupId}`;
                    console.log('Joining room:', roomName);
                    socket.emit('join', { room: roomName });
                    
                    // Load group messages
                    return fetch(`/chat/get_group_messages/${groupId}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to load messages');
                            }
                            return response.json();
                        })
                        .then(messages => {
                            // Clear loading message
                            chatBody.innerHTML = '';
                            
                            // Display messages
                            messages.forEach(msg => {
                                const isFromCurrentUser = msg[0] == document.documentElement.getAttribute('data-user-id');
                                const messageElement = document.createElement('div');
                                messageElement.className = isFromCurrentUser ? 'message sent' : 'message received';
                                
                                const senderName = !isFromCurrentUser ? 
                                    `<div class="message-sender" style="font-size: 12px; color: #00a884; margin-bottom: 2px;">${msg[1]}</div>` : '';
                                
                                messageElement.innerHTML = `
                                    ${senderName}
                                    <div class="message-content">${msg[2]}</div>
                                    <div class="message-meta">
                                        <span class="message-timestamp">${formatMessageTimestamp(msg[3], true)}</span>
                                    </div>
                                `;
                                
                                chatBody.appendChild(messageElement);
                            });
                            
                            // Scroll to bottom
                            chatBody.scrollTop = chatBody.scrollHeight;
                        });
                })
                .then(() => {
                    // Set up message input event listeners
                    const messageInput = document.getElementById('message-input');
                    const sendButton = document.getElementById('send-message');
                    
                    if (messageInput) {
                        // Remove existing listeners first to avoid duplicates
                        messageInput.removeEventListener('keypress', handleEnterPress);
                        // Add new listener
                        messageInput.addEventListener('keypress', handleEnterPress);
                        // Clear any existing message
                        messageInput.value = '';
                        // Update placeholder
                        messageInput.placeholder = 'Type a message to the group...';
                    }
                    
                    if (sendButton) {
                        // Remove existing listener first to avoid duplicates
                        sendButton.removeEventListener('click', sendMessage);
                        // Add new listener
                        sendButton.addEventListener('click', sendMessage);
                    }
                    
                    // Highlight the active group in the list
                    document.querySelectorAll('.contact').forEach(c => c.classList.remove('contact-active'));
                    const groupElement = document.querySelector(`.contact[data-group-id="${groupId}"]`);
                    if (groupElement) {
                        groupElement.classList.add('contact-active');
                    }
                })
                .catch(error => {
                    console.error('Error loading group chat:', error);
                    showNotification('Failed to load group chat', 'error');
                    if (chatBody) {
                        chatBody.innerHTML = '<div class="error-message" style="color: #ff6b6b; text-align: center; padding: 20px;">Failed to load messages. Please try again.</div>';
                    }
                });
        }
        
        // Function to update the chat header with contact or group info
        function updateChatHeader(entity, isGroup = false) {
            const chatHeader = document.querySelector('.chat-header');
            if (!chatHeader) return;

            // Clear existing event listeners to prevent duplicates
            const oldProfileElements = [
                chatHeader.querySelector('.profile-pic'), 
                chatHeader.querySelector('.chat-header-info')
            ];
            
            oldProfileElements.forEach(element => {
                if (element) {
                    const clone = element.cloneNode(true);
                    if (element.parentNode) {
                        element.parentNode.replaceChild(clone, element);
                    }
                }
            });

            // Get profile picture URL
            let profilePic;
            if (isGroup) {
                profilePic = entity.picture ? `/uploads/group_images/${entity.picture}` : 'Backend/static/images/group_logo.png';
            } else {
                // For direct chats, use the same logic as contact list
                profilePic = entity.profile_picture ? `/uploads/profile_photos/${entity.profile_picture}` : '/static/images/contact_logo.png';
                
                // If no profile picture in entity, fetch it from the API
                if (!entity.profile_picture) {
                    fetch(`/api/user/${entity.id}/profile-picture`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.photo_url) {
                                const img = chatHeader.querySelector('.profile-pic img');
                                if (img) {
                                    img.src = data.photo_url;
                                }
                            }
                        })
                        .catch(error => console.error('Error fetching profile picture:', error));
                }
            }

            // For group chats, prepare member names
            let memberDisplay = '';
                    if (isGroup) {
                console.log('Group entity object:', entity);
                console.log('Group members array:', entity.members);
                if (entity.members && entity.members.length > 0) {
                    // Display member names instead of count
                    memberDisplay = entity.members.map(member => member.username).join(', ');
                    console.log('Member display string:', memberDisplay);
                    } else {
                    memberDisplay = `${entity.member_count} members`;
                    console.log('Fallback to member count:', memberDisplay);
                }
                        } else {
                memberDisplay = isUserOnline(entity.id || entity) ? 'online' : 'offline';
            }

            chatHeader.innerHTML = `
                <div class="profile-pic" style="cursor: pointer;">
                    <img src="${profilePic}" alt="${isGroup ? entity.name : (entity.username || entity)}" 
                         onerror="this.src='${isGroup ? '/static/images/group_logo.png' : '/static/images/contact_logo.png'}'">
                        </div>
                <div class="chat-header-info" style="cursor: pointer;">
                    <div class="chat-header-name">${isGroup ? entity.name : (entity.username || entity)}</div>
                    <div class="chat-header-status ${!isGroup && isUserOnline(entity.id || entity) ? 'online' : 'offline'}">
                        ${isGroup 
                            ? (entity.members && entity.members.length > 0 
                                ? entity.members.map(member => member.username).join(', ') 
                                : entity.member_count + ' members')
                            : (isUserOnline(entity.id || entity) ? 'online' : 'offline')}
                    </div>
                </div>
            `;
            
            // Add event listener for back button - ONLY if the element exists
            const backButton = document.getElementById('back-to-group-info');
            if (backButton) {
                backButton.addEventListener('click', function() {
                    if (window.originalSidebarState) {
                        sidebarContent.innerHTML = window.originalSidebarState;
                    } else {
                        showGroupsView();
                    }
                });
            }
            
            // Add event listener for add members button - ONLY if the element exists
            const addMembersButton = document.getElementById('add-selected-members');
            if (addMembersButton) {
                addMembersButton.addEventListener('click', function() {
                    if (selectedMembers.size > 0) {
                        const memberIds = Array.from(selectedMembers.keys());
                        
                        // Send request to add members
                        Promise.all(memberIds.map(userId => 
                            fetch('/chat/add_to_group', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    group_id: groupId,
                                    user_id: userId
                                })
                            })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                return response.json();
                            })
                        ))
                        .then(() => {
                            showNotification('Members added successfully', 'success');
                            // Close the add members view
                            if (window.originalSidebarState) {
                                sidebarContent.innerHTML = window.originalSidebarState;
                            } else {
                                showGroupsView();
                            }
                            // Refresh the group info
                            loadGroupChat(groupId);
                        })
                        .catch(error => {
                            showNotification('Error adding members: ' + error.message, 'error');
                            console.error('Error:', error);
                        });
                    } else {
                        showNotification('Please select at least one contact', 'warning');
                    }
                });
            }
            
            // Only load contacts for group creation if it's actually a group
            if (isGroup) {
                loadContactsForGroupCreation(entity.id);
            }
        }

        // Function to load contacts for group creation/member addition
        function loadContactsForGroupCreation(groupId) {
            // First get the current group members
            fetch(`/chat/group/${groupId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(groupInfo => {
                    // Get all users
                    return fetch('/chat/user_info')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(users => {
                            // Filter out existing members
                            const existingMemberIds = new Set(groupInfo.members.map(member => member.id));
                            return users.filter(user => !existingMemberIds.has(user.id));
                        });
                })
                .then(filteredUsers => {
                    const contactsList = document.getElementById('add-members-list') || document.getElementById('contact-selection-list');
                    contactsList.innerHTML = '';
                    
                    if (filteredUsers.length === 0) {
                        contactsList.innerHTML = `
                            <div style="color: #8696a0; text-align: center; padding: 20px;">
                                No contacts available to add
                            </div>
                        `;
                        return;
                    }
                    
                    filteredUsers.forEach(user => {
                        const contactElement = document.createElement('div');
                        contactElement.className = 'contact-selection-item';
                        contactElement.setAttribute('data-contact-id', user.id);
                        contactElement.setAttribute('data-contact-name', user.username);
                        
                        const profilePic = user.profile_picture ? 
                            `/uploads/profile_photos/${user.profile_picture}` : 
                            'Backend/static/images/contact_logo.png';
                        
                        contactElement.innerHTML = `
                            <div style="display: flex; align-items: center; padding: 10px; cursor: pointer;">
                                <div style="width: 40px; height: 40px; border-radius: 20px; overflow: hidden; margin-right: 15px;">
                                    <img src="${profilePic}" alt="${user.username}" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <div style="flex: 1;">
                                    <div style="color: #e9edef;">${user.username}</div>
                                    <div style="color: #8696a0; font-size: 13px;">${user.name || ''}</div>
                                </div>
                                <div class="contact-checkbox" style="width: 20px; height: 20px; border: 2px solid #8696a0; border-radius: 3px;"></div>
                            </div>
                        `;
                        
                        contactElement.addEventListener('click', function() {
                            const checkbox = this.querySelector('.contact-checkbox');
                            const userId = parseInt(this.getAttribute('data-contact-id'));
                            
                            if (selectedMembers.has(userId)) {
                                selectedMembers.delete(userId);
                                checkbox.style.backgroundColor = '';
                                checkbox.innerHTML = '';
                            } else {
                                selectedMembers.set(userId, {
                                    name: this.getAttribute('data-contact-name'),
                                    profilePic: profilePic
                                });
                                checkbox.style.backgroundColor = '#00a884';
                                checkbox.innerHTML = `
                                    <svg viewBox="0 0 24 24" width="16" height="16" style="fill: white; margin: 0 auto;">
                                        <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"></path>
                                    </svg>
                                `;
                            }
                            
                            // Update add members button state
                            const addButton = document.getElementById('add-selected-members');
                            if (addButton) {
                                addButton.disabled = selectedMembers.size === 0;
                                addButton.style.opacity = selectedMembers.size === 0 ? '0.5' : '1';
                            }
                        });
                        
                        contactsList.appendChild(contactElement);
                    });
                })
                .catch(error => {
                    console.error('Error loading contacts:', error);
                    const contactsList = document.getElementById('add-members-list') || document.getElementById('contact-selection-list');
                    contactsList.innerHTML = `
                        <div style="color: #ff6b6b; text-align: center; padding: 20px;">
                            Error loading contacts. Please try again.
                        </div>
                    `;
                });
        }

        // Function to show language settings
        function showLanguageSettings() {
            // Create a simple notification since this feature is not fully implemented
            showNotification('Language settings feature is coming soon!', 'info');
        }

        // Function to show password change settings
        function showPasswordSettings() {
            // Create a simple notification since this feature is not fully implemented
            showNotification('Password change feature is coming soon!', 'info');
        }

        function showMainSidebar() {
            // Set contacts tab as active
            document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
            document.querySelector('.nav-icon[data-target="contacts"]').classList.add('active');
            
            // Show contacts view
            const sidebarContent = document.querySelector('.sidebar-content');
            sidebarContent.style.display = "none";
            sidebarContent.innerHTML = `
                <div class="sidebar-header">
                    <div class="app-name">TogolohChat</div>
                    <div class="sidebar-header-icons">
                        <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                            <path fill="currentColor" d="M12 20.664a8.664 8.664 0 0 1-8.664-8.664A8.664 8.664 0 0 1 12 3.336a8.664 8.664 0 0 1 8.664 8.664A8.664 8.664 0 0 1 12 20.664zm0-17.328a8.664 8.664 0 0 0-8.664 8.664A8.664 8.664 0 0 0 12 20.664a8.664 8.664 0 0 0 8.664-8.664A8.664 8.664 0 0 0 12 3.336z"></path>
                            <path fill="currentColor" d="M12 14.504c-1.104 0-2-.896-2-2s.896-2 2-2 2 .896 2 2-.896 2-2 2zm0-5c-1.657 0-3 1.343-3 3s1.343 3 3 3 3-1.343 3-3-1.343-3-3-3z"></path>
                        </svg>
                    </div>
                </div>
                
                <div class="search-container">
                    <div class="search-bar">
                        <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                            <path fill="currentColor" d="M15.009 13.805h-.636l-.22-.219a5.184 5.184 0 0 0 1.256-3.386 5.207 5.207 0 1 0-5.207 5.208 5.183 5.183 0 0 0 3.385-1.255l.221.22v.635l4.004 3.999 1.194-1.195-3.997-4.007zm-4.808 0a3.605 3.605 0 1 1 0-7.21 3.605 3.605 0 0 1 0 7.21z"></path>
                        </svg>
                        <input type="text" id="search-input" placeholder="Іздеу же жаңы чат баштоо..." onkeyup="searchContacts()">
                    </div>
                </div>
                
                <div class="contact-list" id="contact-list">
                    <div class="loading-contacts" style="color: #8696a0; text-align: center; padding: 20px;">
                        Loading contacts...
                    </div>
                </div>
            `;
            sidebarContent.style.display = "block";
            
            // Reattach event listeners and load contacts
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('keyup', searchContacts);
            }
            
            // Refresh contacts
            loadContacts();
        }

        // Function to load and show admin panel
        function loadAdminPanel() {
            showAdminPasswordPrompt();
        }

        // Function to show admin password prompt
        function showAdminPasswordPrompt() {
            // Remove any existing modals first
            const existingModals = document.querySelectorAll('.modal');
            existingModals.forEach(modal => {
                document.body.removeChild(modal);
            });

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '1000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';

            const panel = document.createElement('div');
            panel.style.backgroundColor = '#1f2c33';
            panel.style.padding = '20px';
            panel.style.borderRadius = '8px';
            panel.style.width = '400px';
            panel.style.maxWidth = '90%';

            panel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #e9edef; margin: 0;">Admin Authentication</h2>
                    <div class="close-button" style="cursor: pointer;">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                        </svg>
                    </div>
                </div>
                <div style="color: #e9edef;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">Enter Admin Password</label>
                        <input type="password" id="admin-password" style="width: 100%; padding: 8px; background-color: #2a3942; color: #e9edef; border: 1px solid #374045; border-radius: 4px;">
                    </div>
                    <button id="verify-admin" style="width: 100%; padding: 10px; background-color: #00a884; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Verify
                    </button>
                </div>
            `;

            modal.appendChild(panel);
            document.body.appendChild(modal);

            // Add event listeners
            const closeButton = panel.querySelector('.close-button');
            const verifyButton = panel.querySelector('#verify-admin');
            const passwordInput = panel.querySelector('#admin-password');

            closeButton.addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            // Add enter key support
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    verifyPassword();
                }
            });

            verifyButton.addEventListener('click', verifyPassword);

            function verifyPassword() {
                const password = passwordInput.value;
                if (password === '1234') {
                    // Set session storage to indicate admin access
                    sessionStorage.setItem('adminAccess', 'true');
                    document.body.removeChild(modal);
                    showActualAdminPanel();
                } else {
                    showNotification('Incorrect admin password', 'error');
                }
            }
        }

        // Function to check if user has admin access
        function hasAdminAccess() {
            return sessionStorage.getItem('adminAccess') === 'true';
        }

        // Function to show actual admin panel with user list
        function showActualAdminPanel() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '1000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            
            const panel = document.createElement('div');
            panel.style.backgroundColor = '#1f2c33';
            panel.style.padding = '20px';
            panel.style.borderRadius = '8px';
            panel.style.width = '600px';
            panel.style.maxWidth = '90%';
            panel.style.maxHeight = '80vh';
            panel.style.overflowY = 'auto';
            
            panel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #e9edef; margin: 0;">Admin Panel - Users</h2>
                    <div class="close-button" style="cursor: pointer;">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                        </svg>
                    </div>
                </div>
                <div style="margin-bottom: 20px; position: relative;">
                    <input type="text" id="admin-search" placeholder="Search users..." 
                        style="width: 100%; padding: 8px 32px 8px 8px; background-color: #2a3942; color: #e9edef; 
                        border: 1px solid #374045; border-radius: 4px; font-size: 14px;">
                    <svg viewBox="0 0 24 24" width="20" height="20" 
                        style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: #8696a0;">
                        <path fill="currentColor" d="M15.009 13.805h-.636l-.22-.219a5.184 5.184 0 0 0 1.256-3.386 5.207 5.207 0 1 0-5.207 5.208 5.183 5.183 0 0 0 3.385-1.255l.221.22v.635l4.004 3.999 1.194-1.195-3.997-4.007zm-4.808 0a3.605 3.605 0 1 1 0-7.21 3.605 3.605 0 0 1 0 7.21z"></path>
                    </svg>
                </div>
                <div class="user-list" style="display: flex; flex-direction: column; gap: 10px;">
                    Loading users...
                </div>
            `;
            
            modal.appendChild(panel);
            document.body.appendChild(modal);
            
            // Add close button event listener
            const closeButton = panel.querySelector('.close-button');
            closeButton.addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // Add search functionality
            const searchInput = panel.querySelector('#admin-search');
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const userCards = panel.querySelectorAll('.user-list > div');
                userCards.forEach(card => {
                    const username = card.querySelector('div[style*="font-weight: bold"]')?.textContent.toLowerCase() || '';
                    const email = card.querySelector('div[style*="font-size: 14px"]')?.textContent.toLowerCase() || '';
                    if (username.includes(searchTerm) || email.includes(searchTerm)) {
                        card.style.display = 'flex';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
            
            // Load users
            fetch('/api/users')
                .then(response => response.json())
                .then(data => {
                    const userList = panel.querySelector('.user-list');
                    userList.innerHTML = ''; // Clear loading message

                    data.users.forEach(user => {
                        const userCard = document.createElement('div');
                        userCard.style.backgroundColor = '#2a3942';
                        userCard.style.padding = '15px';
                        userCard.style.borderRadius = '8px';
                        userCard.style.cursor = 'pointer';
                        userCard.style.display = 'flex';
                        userCard.style.alignItems = 'center';
                        userCard.style.gap = '15px';

                        userCard.innerHTML = `
                            <div class="user-avatar" style="width: 50px; height: 50px; border-radius: 50%; overflow: hidden; background-color: #374045;">
                                <img src="${user.profile_picture}" alt="${user.username}" 
                                     style="width: 100%; height: 100%; object-fit: cover;"
                                     onerror="this.src='/static/images/contact_logo.png'">
                            </div>
                            <div style="flex: 1;">
                                <div style="color: #e9edef; font-weight: bold;">${user.username}</div>
                                <div style="color: #8696a0; font-size: 14px;">${user.email}</div>
                            </div>
                        `;

                        userCard.addEventListener('click', () => showUserDetailsModal(user.id));
                        userList.appendChild(userCard);
                    });
                })
                .catch(error => {
                    console.error('Error loading users:', error);
                    panel.querySelector('.user-list').innerHTML = 'Error loading users';
                });
        }

        function showUserDetailsModal(userId) {
            // Check if user has admin access
            if (!hasAdminAccess()) {
                showAdminPasswordPrompt();
                return;
            }

            fetch(`/api/users/${userId}/details`)
                .then(response => response.json())
                .then(user => {
                    const modal = document.createElement('div');
                    modal.className = 'modal';
                    modal.style.position = 'fixed';
                    modal.style.top = '0';
                    modal.style.left = '0';
                    modal.style.width = '100%';
                    modal.style.height = '100%';
                    modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                    modal.style.zIndex = '1001';
                    modal.style.display = 'flex';
                    modal.style.justifyContent = 'center';
                    modal.style.alignItems = 'center';

                    const panel = document.createElement('div');
                    panel.style.backgroundColor = '#1f2c33';
                    panel.style.padding = '20px';
                    panel.style.borderRadius = '8px';
                    panel.style.width = '400px';
                    panel.style.maxWidth = '90%';

                    panel.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: #e9edef; margin: 0;">User Details</h2>
                            <div class="close-button" style="cursor: pointer;">
                                <svg viewBox="0 0 24 24" width="24" height="24">
                                    <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                                </svg>
                            </div>
                        </div>
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="width: 120px; height: 120px; border-radius: 50%; overflow: hidden; margin: 0 auto 15px;">
                                <img src="${user.profile_picture}" alt="${user.username}" 
                                     style="width: 100%; height: 100%; object-fit: cover;"
                                     onerror="this.src='/static/images/contact_logo.png'">
                            </div>
                            <div style="color: #e9edef; font-size: 20px; font-weight: bold;">${user.username}</div>
                            <div style="color: #8696a0;">${user.name || 'No name set'}</div>
                        </div>
                        <div style="background-color: #2a3942; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="color: #8696a0; margin-bottom: 5px;">Bio</div>
                            <div style="color: #e9edef;">${user.bio || 'No bio set'}</div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                            <div style="background-color: #2a3942; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #8696a0;">Groups</div>
                                <div style="color: #e9edef; font-size: 18px;">${user.group_count || 0}</div>
                </div>
                            <div style="background-color: #2a3942; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #8696a0;">Complaints</div>
                                <div style="color: #e9edef; font-size: 18px;">${user.complaint_count || 0}</div>
                    </div>
                </div>
                        <div style="background-color: #2a3942; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="color: #8696a0;">Registration Date</div>
                            <div style="color: #e9edef;">${new Date(user.registration_date).toLocaleDateString()}</div>
                        </div>
                        <button onclick="deleteUser(${user.id})" 
                                style="width: 100%; padding: 12px; background-color: #dc3545; color: white; border: none; 
                                       border-radius: 8px; cursor: pointer; font-size: 16px;">
                            Delete Account
                        </button>
                    `;

                    modal.appendChild(panel);
                    document.body.appendChild(modal);

                    // Add close button event listener
                    const closeButton = panel.querySelector('.close-button');
                    closeButton.addEventListener('click', () => {
                        document.body.removeChild(modal);
                    });

                    // Close when clicking outside
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            document.body.removeChild(modal);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading user details:', error);
                    showNotification('Error loading user details', 'error');
                });
        }

        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                fetch(`/api/users/${userId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    showNotification('User deleted successfully', 'success');
                    // Refresh admin panel
                    document.body.removeChild(document.querySelector('.modal'));
                    showActualAdminPanel();
                })
                .catch(error => {
                    console.error('Error deleting user:', error);
                    showNotification('Error deleting user', 'error');
                });
            }
        }

        // Function to show language settings modal
        function showLanguageSettings() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '1000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';

            const panel = document.createElement('div');
            panel.style.backgroundColor = '#1f2c33';
            panel.style.padding = '20px';
            panel.style.borderRadius = '8px';
            panel.style.width = '400px';
            panel.style.maxWidth = '90%';

            panel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #e9edef; margin: 0;" data-i18n="settings.language">Language Settings</h2>
                    <div class="close-button" style="cursor: pointer;">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                        </svg>
                    </div>
                </div>
                <div style="color: #e9edef;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;" data-i18n="settings.language">Select Language</label>
                        <select id="language-select" style="width: 100%; padding: 8px; background-color: #2a3942; color: #e9edef; border: 1px solid #374045; border-radius: 4px;">
                            <option value="en" data-i18n="languages.en">English</option>
                            <option value="ky" data-i18n="languages.ky">Кыргызча</option>
                            <option value="ru" data-i18n="languages.ru">Русский</option>
                        </select>
                    </div>
                    <button id="save-language" style="width: 100%; padding: 10px; background-color: #00a884; color: white; border: none; border-radius: 4px; cursor: pointer;" data-i18n="settings.save">
                        Save Changes
                    </button>
                </div>
            `;

            modal.appendChild(panel);
            document.body.appendChild(modal);
            
            // Set the current language in the dropdown
            const languageSelect = panel.querySelector('#language-select');
            languageSelect.value = window.languageManager.currentLanguage;

            // Apply translations to the modal
            window.languageManager.applyTranslations();

            // Add event listeners
            const closeButton = panel.querySelector('.close-button');
            const saveButton = panel.querySelector('#save-language');

            closeButton.addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            saveButton.addEventListener('click', async () => {
                const selectedLanguage = panel.querySelector('#language-select').value;
                // Change the language using the language manager
                const success = await window.languageManager.changeLanguage(selectedLanguage);
                
                if (success) {
                    showNotification(window.languageManager.translate('settings.languageSaved'), 'success');
                } else {
                    showNotification('Error changing language', 'error');
                }
                
                document.body.removeChild(modal);
            });
        }

        // Function to show password change modal
        function showPasswordSettings() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '1000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';

            const panel = document.createElement('div');
            panel.style.backgroundColor = '#1f2c33';
            panel.style.padding = '20px';
            panel.style.borderRadius = '8px';
            panel.style.width = '400px';
            panel.style.maxWidth = '90%';

            panel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #e9edef; margin: 0;">Change Password</h2>
                    <div class="close-button" style="cursor: pointer;">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                        </svg>
                    </div>
                </div>
                <div style="color: #e9edef;">
                    <div style="margin-bottom: 15px; position: relative;">
                        <label style="display: block; margin-bottom: 5px;">Current Password</label>
                        <div style="position: relative;">
                            <input type="password" id="current-password" style="width: 100%; padding: 8px; background-color: #2a3942; color: #e9edef; border: 1px solid #374045; border-radius: 4px; padding-right: 35px;">
                            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('current-password')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #8696a0;">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div style="margin-bottom: 15px; position: relative;">
                        <label style="display: block; margin-bottom: 5px;">New Password</label>
                        <div style="position: relative;">
                            <input type="password" id="new-password" style="width: 100%; padding: 8px; background-color: #2a3942; color: #e9edef; border: 1px solid #374045; border-radius: 4px; padding-right: 35px;">
                            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('new-password')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #8696a0;">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div style="margin-bottom: 15px; position: relative;">
                        <label style="display: block; margin-bottom: 5px;">Confirm New Password</label>
                        <div style="position: relative;">
                            <input type="password" id="confirm-password" style="width: 100%; padding: 8px; background-color: #2a3942; color: #e9edef; border: 1px solid #374045; border-radius: 4px; padding-right: 35px;">
                            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('confirm-password')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #8696a0;">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <button id="save-password" style="width: 100%; padding: 10px; background-color: #00a884; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Change Password
                    </button>
                </div>
            `;

            modal.appendChild(panel);
            document.body.appendChild(modal);

            // Add event listeners
            const closeButton = panel.querySelector('.close-button');
            const saveButton = panel.querySelector('#save-password');

            closeButton.addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            saveButton.addEventListener('click', () => {
                const currentPassword = panel.querySelector('#current-password').value;
                const newPassword = panel.querySelector('#new-password').value;
                const confirmPassword = panel.querySelector('#confirm-password').value;

                if (!currentPassword || !newPassword || !confirmPassword) {
                    showNotification('Please fill in all fields', 'error');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    showNotification('New passwords do not match', 'error');
                    return;
                }

                if (newPassword.length < 6) {
                    showNotification('New password must be at least 6 characters long', 'error');
                     return;
                }

                // Make API call to change password
                fetch('/api/change_password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        old_password: currentPassword,
                        new_password: newPassword
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.message || 'Failed to change password');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                        showNotification('Password changed successfully!', 'success');
                        document.body.removeChild(modal);
                })
                .catch(error => {
                    console.error('Error changing password:', error);
                    showNotification(error.message || 'Error changing password', 'error');
                });
            });
        }

        // Add this after the existing socket connection code but before other functions

        // Function to load chat messages for a contact
        function loadChatMessages(contactId) {
            const chatBody = document.querySelector('.chat-body');
            if (!chatBody) return;
            
            chatBody.innerHTML = '<div class="loading-messages">Loading messages...</div>';
            
            // Load existing messages
            fetch(`/chat/get_messages/${contactId}`)
                .then(response => response.json())
                .then(messages => {
                    chatBody.innerHTML = ''; // Clear loading message
                    
                    let lastMessageDate = null;
                    
                    // Display each message
                    messages.forEach(msg => {
                        const [senderId, receiverId, messageText, timestamp] = msg;
                        const isSent = senderId == document.documentElement.getAttribute('data-user-id');
                        const messageDate = new Date(timestamp);
                        
                        // Add date separator if this is a new day
                        if (!lastMessageDate || lastMessageDate.toDateString() !== messageDate.toDateString()) {
                            const dateSeparator = document.createElement('div');
                            dateSeparator.className = 'date-separator';
                            dateSeparator.textContent = formatDateSeparator(messageDate, true);
                            chatBody.appendChild(dateSeparator);
                            lastMessageDate = messageDate;
                        }
                        
                        // Generate a stable message ID based on content and timestamp
                        const messageId = `history_${senderId}_${receiverId}_${timestamp.replace(/[^0-9]/g, '')}_${messageText.substring(0, 10).replace(/\s/g, '')}`;
                        
                        const messageElement = document.createElement('div');
                        messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
                        messageElement.setAttribute('data-message-id', messageId);
                        messageElement.setAttribute('data-timestamp', timestamp);
                        messageElement.innerHTML = `
                            <div class="message-content">${messageText}</div>
                            <div class="message-meta">
                                <span class="message-timestamp">${formatMessageTimestamp(timestamp, true)}</span>
                            </div>
                        `;
                        
                        chatBody.appendChild(messageElement);
                    });
                    
                    // Scroll to bottom
                    chatBody.scrollTop = chatBody.scrollHeight;
                    
                    // Update the message input placeholder for direct messages
                    document.querySelector('.message-input').placeholder = 'Type a message...';
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                    chatBody.innerHTML = '<div class="error-message">Failed to load messages</div>';
                });
        }

        // Function to format timestamp
        function formatMessageTimestamp(timestamp, isNewMessage = false) {
            const messageDate = new Date(timestamp);
            const now = new Date();
            
            // Format time in 24-hour format
            const time = messageDate.toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
            
            return time;
        }

        function formatDateSeparator(date) {
            const messageDate = new Date(date);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            // If the message is from today
            if (messageDate.toDateString() === today.toDateString()) {
                return 'Today';
            }
            
            // If the message is from yesterday
            if (messageDate.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            }
            
            // If the message is from this year
            if (messageDate.getFullYear() === today.getFullYear()) {
                return messageDate.toLocaleDateString([], {
                    month: 'long',
                    day: 'numeric'
                });
            }
            
            // If the message is from a different year
            return messageDate.toLocaleDateString([], {
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });
        }

        // Function to add or update date separator
        function addOrUpdateDateSeparator(chatBody, messageDate) {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            // Find existing date separators
            const dateSeparators = chatBody.querySelectorAll('.date-separator');
            let needNewSeparator = true;
            
            // Check if we already have a separator for this date
            for (const separator of dateSeparators) {
                const separatorDate = new Date(separator.getAttribute('data-date'));
                if (separatorDate.toDateString() === messageDate.toDateString()) {
                    needNewSeparator = false;
                    break;
                }
            }
            
            if (needNewSeparator) {
                const dateSeparator = document.createElement('div');
                dateSeparator.className = 'date-separator';
                dateSeparator.setAttribute('data-date', messageDate.toISOString());
                dateSeparator.textContent = formatDateSeparator(messageDate);
                
                // Find the right position to insert the separator
                let insertPosition = null;
                const messages = chatBody.querySelectorAll('.message');
                
                for (const message of messages) {
                    const msgDate = new Date(message.getAttribute('data-timestamp'));
                    if (msgDate > messageDate) {
                        insertPosition = message;
                        break;
                    }
                }
                
                if (insertPosition) {
                    chatBody.insertBefore(dateSeparator, insertPosition);
                } else {
                    chatBody.appendChild(dateSeparator);
                }
                
                return dateSeparator;
            }
            
            return null;
        }

        // Update the addMessageToChat function to use the new date separator logic
        function addMessageToChat(messageData, isGroup = false) {
            const chatBody = document.querySelector('.chat-body');
            if (!chatBody) return;

            const timestamp = messageData.timestamp || Date.now();
            const messageDate = new Date(timestamp);
            
            // Add or update date separator
            addOrUpdateDateSeparator(chatBody, messageDate);
            
            const isFromCurrentUser = messageData.sender_id.toString() === document.documentElement.getAttribute('data-user-id');
            const formattedTime = formatMessageTimestamp(timestamp);
            
            // Generate message ID
            const messageId = isGroup ? 
                `group_${messageData.group_id}_${messageData.sender_id}_${timestamp}_${messageData.message.substring(0, 10).replace(/\s/g, '')}` :
                `direct_${messageData.sender_id}_${timestamp}_${messageData.message.substring(0, 10).replace(/\s/g, '')}`;
            
            const messageElement = document.createElement('div');
            messageElement.className = isFromCurrentUser ? 'message sent' : 'message received';
            messageElement.setAttribute('data-message-id', messageId);
            messageElement.setAttribute('data-timestamp', timestamp);
            
            if (isGroup && !isFromCurrentUser) {
                const profilePicUrl = messageData.sender_profile_picture || '/api/placeholder/32/32';
                messageElement.innerHTML = `
                    <div class="message-avatar">
                        <img src="${profilePicUrl}" alt="${messageData.sender_username}" width="32" height="32">
                    </div>
                    <div class="message-bubble">
                        <div class="message-sender" style="font-size: 12px; color: #00a884; margin-bottom: 2px;">${messageData.sender_username}</div>
                        <div class="message-content">${messageData.message}</div>
                        <div class="message-meta">
                            <span class="message-timestamp">${formattedTime}</span>
                        </div>
                    </div>
                `;
            } else {
                messageElement.innerHTML = `
                    <div class="message-content">${messageData.message}</div>
                    <div class="message-meta">
                        <span class="message-timestamp">${formattedTime}</span>
                    </div>
                `;
            }
            
            chatBody.appendChild(messageElement);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        // Update the loadGroupMessages function to use the new date separator logic
        function loadGroupMessages(groupId) {
            const chatBody = document.querySelector('.chat-body');
            chatBody.innerHTML = '';
            
            // Show loading indicator
            const loadingElement = document.createElement('div');
            loadingElement.className = 'message';
            loadingElement.style.alignSelf = 'center';
            loadingElement.textContent = 'Loading messages...';
            chatBody.appendChild(loadingElement);
            
            // Fetch messages for this group
            fetch(`/chat/get_group_messages/${groupId}`)
                .then(response => response.json())
                .then(messages => {
                    // Remove loading indicator
                    chatBody.innerHTML = '';
                    
                    if (messages.length === 0) {
                        const welcomeElement = document.createElement('div');
                        welcomeElement.className = 'message';
                        welcomeElement.style.alignSelf = 'center';
                        welcomeElement.style.backgroundColor = '#202c33';
                        welcomeElement.style.padding = '10px 15px';
                        welcomeElement.style.borderRadius = '8px';
                        welcomeElement.style.color = '#e9edef';
                        welcomeElement.textContent = `No messages yet in this group. Be the first to say hello!`;
                        chatBody.appendChild(welcomeElement);
                        return;
                    }
                    
                    // Display each message
                    messages.forEach(msg => {
                        const [senderId, senderUsername, msgContent, timestamp, profilePic] = msg;
                        const messageDate = new Date(timestamp);
                        
                        // Add or update date separator
                        addOrUpdateDateSeparator(chatBody, messageDate);
                        
                        // Format the timestamp for the message
                        const formattedTime = formatMessageTimestamp(timestamp);
                        
                        // Check if this is a sent or received message
                        const currentUserId = document.documentElement.getAttribute('data-user-id');
                        const isSent = senderId.toString() === currentUserId;
                        
                        // Get profile picture URL
                        const profilePicUrl = profilePic ? `/uploads/profile_photos/${profilePic}` : '/api/placeholder/32/32';
                        
                        // Generate a stable message ID
                        const messageId = `group_${groupId}_${senderId}_${timestamp.replace(/[^0-9]/g, '')}_${msgContent.substring(0, 10).replace(/\s/g, '')}`;
                        
                        // Create message element
                        const messageElement = document.createElement('div');
                        messageElement.className = isSent ? 'message sent' : 'message received';
                        messageElement.setAttribute('data-message-id', messageId);
                        messageElement.setAttribute('data-timestamp', timestamp);
                        
                        if (isSent) {
                            messageElement.innerHTML = `
                                <div class="message-content">${msgContent}</div>
                                <div class="message-meta">
                                    <span class="message-timestamp">${formattedTime}</span>
                                </div>
                            `;
                        } else {
                            messageElement.innerHTML = `
                                <div class="message-avatar">
                                    <img src="${profilePicUrl}" alt="${senderUsername}" width="32" height="32">
                                </div>
                                <div class="message-bubble">
                                    <div class="message-sender" style="font-size: 12px; color: #00a884; margin-bottom: 2px;">${senderUsername}</div>
                                    <div class="message-content">${msgContent}</div>
                                    <div class="message-meta">
                                        <span class="message-timestamp">${formattedTime}</span>
                                    </div>
                                </div>
                            `;
                        }
                        
                        chatBody.appendChild(messageElement);
                    });
                    
                    // Scroll to bottom
                    chatBody.scrollTop = chatBody.scrollHeight;
                    
                    // Update the message input placeholder
                    document.querySelector('.message-input').placeholder = 'Type a message to the group...';
                })
                .catch(error => {
                    console.error('Error loading group messages:', error);
                    chatBody.innerHTML = '';
                    
                    const errorElement = document.createElement('div');
                    errorElement.className = 'message';
                    errorElement.style.alignSelf = 'center';
                    errorElement.style.backgroundColor = '#8B0000';
                    errorElement.style.padding = '10px 15px';
                    errorElement.style.borderRadius = '8px';
                    errorElement.style.color = '#ffffff';
                    errorElement.textContent = 'Error loading messages. Please try again.';
                    chatBody.appendChild(errorElement);
                });
        }

        // Function to update a contact's last message and timestamp
        function updateContactLastMessage(contactId, message, timestamp) {
            const contact = document.querySelector(`.contact[data-contact-id="${contactId}"]`);
            if (contact) {
                const messagePreview = contact.querySelector('.contact-message');
                const timeElement = contact.querySelector('.message-time');
                if (messagePreview) {
                    messagePreview.textContent = message;
                }
                if (timeElement) {
                    timeElement.textContent = formatMessageTimestamp(timestamp);
                }

                // Update the contact's timestamp in the global contacts array
                if (window.userContacts) {
                    const contactData = window.userContacts.find(c => c[0] == contactId);
                    if (contactData) {
                        contactData.last_message = message;
                        contactData.last_message_timestamp = timestamp;
                        contactData.last_message_time = formatMessageTimestamp(timestamp);
                    }
                }

                // Move contact to top of list
                const contactList = contact.parentElement;
                contactList.insertBefore(contact, contactList.firstChild);
            }
        }

        // Handle receiving messages
        socket.on('new_message', function(data) {
            // Only show message if we're in the correct chat
            if (window.currentChat && (
                (data.sender_id == window.currentChat.id) || 
                (data.receiver_id == window.currentChat.id)
            )) {
                const chatBody = document.querySelector('.chat-body');
                
                // Define isSent before using it
                const isSent = data.sender_id == document.documentElement.getAttribute('data-user-id');
                
                const messageElement = document.createElement('div');
                messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
                messageElement.setAttribute('data-message-id', data.message_id);
                messageElement.setAttribute('data-timestamp', data.timestamp);
                
                messageElement.innerHTML = `
                    <div class="message-content">${data.message}</div>
                    <div class="message-meta">
                        <span class="message-timestamp">${formatMessageTimestamp(new Date(data.timestamp), true)}</span>
                    </div>
                `;
                chatBody.appendChild(messageElement);
                chatBody.scrollTop = chatBody.scrollHeight;
                
                // Send read receipt
                socket.emit('update_message_status', {
                    message_id: data.message_id,
                    status: 'read',
                    chat_id: data.sender_id,
                    chat_type: 'direct'
                });
            } else {
                // Show notification for messages from other chats
                showNotification(`New message from ${data.sender_username}: ${data.message}`);
            }
        });

        // Add a map to track online users
        window.onlineUsers = new Set();
        
        // Function to update user status in chat header
        function updateUserStatus(userId, isOnline) {
            // Only update if we're in a direct chat with this user
            if (window.currentChat && 
                window.currentChat.type === 'direct' && 
                window.currentChat.id == userId) {
                
                const statusElement = document.querySelector('.chat-header-status');
                if (statusElement) {
                    statusElement.textContent = isOnline ? 'online' : 'offline';
                    statusElement.className = 'chat-header-status ' + (isOnline ? 'online' : 'offline');
                }
            }
        }

        
        

        // Function to check if a user is online
        function isUserOnline(userId) {
            return window.onlineUsers.has(userId);
        }

        // When connecting, request current online users
        socket.on('connect', function() {
            console.log('Connected to server');
            
            const htmlElement = document.documentElement;
            const isAuthenticated = htmlElement.getAttribute('data-authenticated') === 'true';
            
            if (isAuthenticated) {
                const userId = htmlElement.getAttribute('data-user-id');
                socket.emit('join', { room: userId });
                console.log('Joined personal room:', userId);
                
                // Request current online users
                socket.emit('request_online_users');
                
                // Setup socket listeners and load contacts
                setupSocketListeners();
                
            } else {
                console.log('Not authenticated, no room to join');
            }
        });

        // Function to store the last active chat
        function storeLastActiveChat(chatId, chatType, chatName) {
            localStorage.setItem('lastActiveChat', JSON.stringify({
                id: chatId,
                type: chatType,
                name: chatName,
                timestamp: new Date().getTime()
            }));
        }

        // Function to retrieve the last active chat
        function getLastActiveChat() {
            const lastChat = localStorage.getItem('lastActiveChat');
            if (lastChat) {
                return JSON.parse(lastChat);
            }
            return null;
        }

        // Function to load the last active chat
        function loadLastActiveChat() {
            const lastChat = getLastActiveChat();
            console.log('Loading last active chat:', lastChat);
            
            if (lastChat) {
                console.log('Last active chat type:', lastChat.type, 'id:', lastChat.id, 'name:', lastChat.name);
                
                // Clear any existing chat content first
                const chatBody = document.querySelector('.chat-body');
                if (chatBody) {
                    chatBody.innerHTML = '';
                }
                
                if (lastChat.type === 'direct') {
                    console.log('Starting direct chat with contact:', lastChat.id, lastChat.name);
                    startChatWithContact(lastChat.id, lastChat.name);
                } else if (lastChat.type === 'group') {
                    console.log('Loading group chat:', lastChat.id);
                    loadGroupChat(lastChat.id);
                }
            }
        }

        // Initialize the chat system
        document.addEventListener('DOMContentLoaded', function() {
            // Load the last active chat
            setTimeout(loadLastActiveChat, 500); // Add a small delay to ensure other elements are loaded
        });

        // ... existing code ...
        // Function to sort contacts by last message timestamp
        function sortContactsByTimestamp(contacts) {
            return contacts.sort((a, b) => {
                const timestampA = a.last_message_timestamp || 0;
                const timestampB = b.last_message_timestamp || 0;
                return timestampB - timestampA;
            });
        }

        // Function to render contacts with sorting
        function renderContacts(contacts) {
            const contactList = document.querySelector('.contact-list');
            if (!contactList) return;

            // Sort contacts by last message timestamp
            const sortedContacts = sortContactsByTimestamp(contacts);

            contactList.innerHTML = sortedContacts.map(contact => `
                <div class="contact" data-contact-id="${contact.id}" onclick="startChatWithContact(${contact.id}, '${contact.username}')">
                    <div class="profile-pic">
                        <img src="${contact.profile_pic || '/static/images/contact_logo.png'}" alt="${contact.username}">
                    </div>
                    <div class="contact-info">
                        <div class="contact-name">${contact.username}</div>
                        <div class="contact-message">${contact.last_message || ''}</div>
                    </div>
                    <div class="contact-meta">
                        <div class="message-time">${contact.last_message_time || ''}</div>
                    </div>
                </div>
            `).join('');
        }

        // Function to update contact's last message timestamp
        function updateContactTimestamp(contactId, timestamp) {
            const contacts = window.contacts || [];
            const contactIndex = contacts.findIndex(c => c.id === contactId);
            
            if (contactIndex !== -1) {
                contacts[contactIndex].last_message_timestamp = timestamp;
                contacts[contactIndex].last_message_time = new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});
                window.contacts = contacts;
                renderContacts(contacts);
            }
        }

        // ... existing code ...
        // Function to update a contact's last message and timestamp
        function updateContactLastMessage(contactId, message, timestamp) {
            const contact = document.querySelector(`.contact[data-contact-id="${contactId}"]`);
            if (contact) {
                const messagePreview = contact.querySelector('.contact-message');
                const timeElement = contact.querySelector('.message-time');
                if (messagePreview) {
                    messagePreview.textContent = message;
                }
                if (timeElement) {
                    timeElement.textContent = formatMessageTimestamp(timestamp);
                }

                // Update the contact's timestamp in the global contacts array
                if (window.userContacts) {
                    const contactData = window.userContacts.find(c => c[0] == contactId);
                    if (contactData) {
                        contactData.last_message = message;
                        contactData.last_message_timestamp = timestamp;
                        contactData.last_message_time = formatMessageTimestamp(timestamp);
                    }
                }

                // Move contact to top of list
                const contactList = contact.parentElement;
                contactList.insertBefore(contact, contactList.firstChild);
            }
        }

        // Update WebSocket event handlers
        socket.on('new_message', function(data) {
            console.log('Received new_message:', data);
            
            const currentChatId = window.currentChat?.id;
            const currentChatType = window.currentChat?.type;
            const isFromCurrentUser = data.sender_id.toString() === document.documentElement.getAttribute('data-user-id');
            const timestamp = data.timestamp || Date.now();
            const messageId = data.message_id || `msg_${timestamp}_${Math.random().toString(36).substring(2, 9)}`;
            
            // Check if this message already exists in the chat to prevent duplicates
            if (document.querySelector(`[data-message-id="${messageId}"]`)) {
                console.log('Preventing duplicate message:', messageId);
                return;
            }
            
            // Handle message display in chat
            if (data.group_id) {
                console.log('Handling group message:', data.group_id, 'current chat:', currentChatId, currentChatType);
                
                // Update group list order and message preview
                updateGroupListOrder(data.group_id, data.message, data.sender_id, data.sender_username);
                
                if (currentChatType === 'group' && currentChatId == data.group_id) {
                    const chatBody = document.querySelector('.chat-body');
                    const messageElement = createMessageElement(
                        data.message,
                        isFromCurrentUser,
                        timestamp,
                        messageId
                    );
                    
                    if (!isFromCurrentUser) {
                        const senderName = document.createElement('div');
                        senderName.className = 'message-sender';
                        senderName.style.fontSize = '12px';
                        senderName.style.color = '#00a884';
                        senderName.style.marginBottom = '2px';
                        senderName.textContent = data.sender_username;
                        messageElement.insertBefore(senderName, messageElement.firstChild);
                    }
                    
                    chatBody.appendChild(messageElement);
                    chatBody.scrollTop = chatBody.scrollHeight;
                }
            } else if (currentChatType === 'direct' && (currentChatId == data.sender_id || currentChatId == data.receiver_id)) {
                const chatBody = document.querySelector('.chat-body');
                const messageElement = createMessageElement(
                    data.message,
                    isFromCurrentUser,
                    timestamp,
                    messageId
                );
                
                chatBody.appendChild(messageElement);
                chatBody.scrollTop = chatBody.scrollHeight;
            }
        });

        socket.on('message_sent', function(data) {
            console.log('Message sent confirmation:', data);
            const timestamp = data.timestamp || Date.now();
            
            // Update contact list for the receiver
            updateContactLastMessage(data.receiver_id, data.message, timestamp);
            
            // Store the last active chat
            storeLastActiveChat(data.receiver_id, 'direct', data.receiver_username);
            
            // Move the contact to the top of the list
            const contact = document.querySelector(`.contact[data-contact-id="${data.receiver_id}"]`);
            if (contact) {
                const contactList = contact.parentElement;
                contactList.insertBefore(contact, contactList.firstChild);
            }
        });

        // Function to create contact element (update the existing function)
        function createContactElement(contact, userDetail = null) {
            const contactId = contact[0];
            const contactElement = document.createElement('div');
            contactElement.className = 'contact';
            contactElement.setAttribute('data-contact-id', contactId);
            
            let displayName = userDetail?.username || contact[1] || 'Unknown User';
            let lastMessage = userDetail?.last_message || '';
            let lastMessageTime = userDetail?.last_message_time || '';
            
            // Use data URI for default avatar
            const defaultAvatar = '/static/images/contact_logo.png';
            
            // Fix avatar path handling
            let profilePic;
            if (userDetail?.profile_picture) {
                profilePic = `/uploads/profile_photos/${userDetail.profile_picture}`;
            } else {
                // Try to get profile picture from profile_photos table
                fetch(`/api/user/${contactId}/profile-picture`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.photo_url) {
                            const img = contactElement.querySelector('.profile-pic img');
                            if (img) {
                                img.src = data.photo_url;
                            }
                        }
                    })
                    .catch(error => console.error('Error fetching profile picture:', error));
                profilePic = defaultAvatar;
            }

            contactElement.innerHTML = `
                <div class="profile-pic">
                    <img src="${profilePic}" alt="${displayName}" onerror="this.src='${defaultAvatar}'">
                </div>
                <div class="contact-info">
                    <div class="contact-name">${displayName}</div>
                    <div class="contact-message-container">
                        <div class="contact-message">${lastMessage}</div>
                    </div>
                </div>
                <div class="contact-meta">
                    <div class="message-time">${lastMessageTime}</div>
                </div>
            `;

            contactElement.onclick = () => startChatWithContact(contactId, displayName);
            return contactElement;
        }

        // Profile functionality
        function loadProfileData() {
            fetch('/api/user/profile')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('profile-nickname').textContent = data.username;
                    document.getElementById('profile-name-input').value = data.name || '';
                    document.getElementById('profile-bio-input').value = data.bio || '';
                    if (data.profile_picture) {
                        document.getElementById('profile-avatar-img').src = `/uploads/profile_photos/${data.profile_picture}`;
                    }
                })
                .catch(error => console.error('Error loading profile:', error));
        }

        // Handle profile name updates
        const nameInput = document.getElementById('profile-name-input');
        let nameTimeout;
        if (nameInput) {
            nameInput.addEventListener('input', () => {
                clearTimeout(nameTimeout);
                nameTimeout = setTimeout(() => {
                    const newName = nameInput.value;
                    fetch('/api/user/update-profile', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ name: newName })
                    })
                    .catch(error => console.error('Error updating name:', error));
                }, 500);
            });
        }

        // Handle profile bio updates
        const bioInput = document.getElementById('profile-bio-input');
        let bioTimeout;
        if (bioInput) {
            bioInput.addEventListener('input', () => {
                clearTimeout(bioTimeout);
                bioTimeout = setTimeout(() => {
                    const newBio = bioInput.value;
                    fetch('/api/user/update-profile', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ bio: newBio })
                    })
                    .catch(error => console.error('Error updating bio:', error));
                }, 500);
            });
        }

        // Handle profile picture updates
        const avatarEdit = document.querySelector('.avatar-edit');
        if (avatarEdit) {
            avatarEdit.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const formData = new FormData();
                        formData.append('profile_picture', file);
                        
                        fetch('/api/user/update-profile-picture', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                document.getElementById('profile-avatar-img').src = `/uploads/profile_photos/${data.filename}`;
                            }
                        })
                        .catch(error => console.error('Error updating profile picture:', error));
                    }
                };
                input.click();
            });
        }

        // Handle logout
        const logoutButton = document.getElementById('logout-button');
        if (logoutButton) {
            logoutButton.addEventListener('click', () => {
                // Create and show logout confirmation modal
                const modal = document.createElement('div');
                modal.className = 'logout-modal';
                modal.style.display = 'flex';
                
                modal.innerHTML = `
                    <div class="logout-modal-content">
                        <div class="logout-modal-title">Are you sure you want to logout?</div>
                        <div class="logout-modal-buttons">
                            <button class="logout-modal-button logout-modal-cancel">Cancel</button>
                            <button class="logout-modal-button logout-modal-confirm">Logout</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Handle cancel button
                modal.querySelector('.logout-modal-cancel').addEventListener('click', () => {
                    modal.remove();
                });
                
                // Handle confirm button
                modal.querySelector('.logout-modal-confirm').addEventListener('click', () => {
                    fetch('/auth/logout', {
                        method: 'POST'
                    })
                    .then(response => {
                        if (response.ok) {
                            window.location.href = '/';
                        }
                    })
                    .catch(error => console.error('Error logging out:', error));
                });
            });
        }

        // Load profile data when settings sidebar is opened
        // The observer below is no longer needed since we now call loadProfileData directly in showSettingsSidebar
        /* 
        const settingsSidebar = document.querySelector('.settings-sidebar');
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'style') {
                    if (settingsSidebar.style.display !== 'none') {
                        loadProfileData();
                    }
                }
            });
        });

        observer.observe(settingsSidebar, {
            attributes: true
        });
        */

        // Function to show contact info sidebar
        function showContactInfo(contact) {
            // Create a modal to display contact info
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '1000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'flex-end'; // Align to right side
            modal.style.alignItems = 'stretch';
            
            // Fetch contact details
            fetch(`/chat/user_info/${contact.id}`)
                .then(response => response.json())
                .then(contactData => {
                    // Contact profile picture
                    const profilePic = contactData.profile_picture ? `/uploads/profile_photos/${contactData.profile_picture}` : 'Backend/static/images/contact_logo.png';
                    
                    // Create side panel
                    const panel = document.createElement('div');
                    panel.className = 'contact-info-panel';
                    panel.style.background = 'rgba(255, 255, 255, 0.85)'; // semi-transparent white
                    panel.style.width = '350px';
                    panel.style.maxWidth = '100%';
                    panel.style.position = 'fixed';
                    panel.style.right = '0';
                    panel.style.left = 'unset';
                    panel.style.top = '60px'; // height of .chat-header
                    panel.style.bottom = '60px'; // height of .chat-footer
                    panel.style.height = 'unset';
                    panel.style.overflowY = 'auto';
                    panel.style.transition = 'transform 0.3s ease';
                    panel.style.transform = 'translateX(100%)'; // Start offscreen
                    panel.style.borderRadius = '20px 0 0 20px';
                    panel.style.boxShadow = 'none';
                    panel.style.zIndex = '1100';
                    
                    panel.innerHTML = `
                        <div style="display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #2a3942;">
                            <div id="close-contact-info" style="cursor: pointer; margin-right: 15px;">
                                <svg viewBox="0 0 24 24" width="24" height="24">
                                    <path fill="currentColor" d="M19.8 11H7.5l5.6-5.6L11.7 4l-8 8 8 8 1.4-1.4L7.5 13h12.3v-2z"></path>
                                </svg>
                            </div>
                            <h2 style="color: black; margin: 0; font-weight: bold;">Contact Info</h2>
                        </div>
                        
                        <div style="padding: 20px; text-align: center; border-bottom: 1px solid #2a3942;">
                            <div style="width: 150px; height: 150px; border-radius: 75px; overflow: hidden; margin: 0 auto 15px;">
                                <img src="${profilePic}" alt="${contactData.name || contactData.username}" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                            <h2 style="color: black; margin-bottom: 5px; font-weight: bold;">${contactData.name || contactData.username}</h2>
                            <p style="color: #1a2a3a; margin-bottom: 0;">@${contactData.username}</p>
                        </div>
                        
                        ${contactData.bio ? `
                        <div style="padding: 15px; border-bottom: 1px solid #2a3942;">
                            <h3 style="color: black; margin-bottom: 10px; font-size: 16px; font-weight: bold;">Bio</h3>
                            <p style="color: black; margin: 0;">${contactData.bio}</p>
                        </div>
                        ` : ''}
                        
                        <div style="padding: 15px; border-bottom: 1px solid #2a3942;">
                            <h3 style="color: black; margin-bottom: 10px; font-size: 16px; font-weight: bold;">Media, Links, and Docs</h3>
                            <div style="display: flex; justify-content: center; align-items: center; height: 100px; color: black;">
                                No media shared yet
                            </div>
                        </div>
                        
                        <div style="padding: 15px;">
                            <button id="report-contact-btn" class="action-button" style="width: 160px; padding: 10px 0; background-color: #f15c6d; color: #fff; border: none; border-radius: 18px; cursor: pointer; font-size: 15px; font-weight: bold; margin: 0 auto; display: block;">Report Contact</button>
                        </div>
                    `;
                    
                    modal.appendChild(panel);
                    document.body.appendChild(modal);
                    
                    // Add a slight delay for animation effect
                    setTimeout(() => {
                        panel.style.transform = 'translateX(0)';
                    }, 10);
                    
                    // Close panel when button is clicked
                    document.getElementById('close-contact-info').addEventListener('click', function() {
                        panel.style.transform = 'translateX(100%)';
                        setTimeout(() => {
                            document.body.removeChild(modal);
                        }, 300);
                    });
                    
                    // Close panel when clicking outside
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            panel.style.transform = 'translateX(100%)';
                            setTimeout(() => {
                                document.body.removeChild(modal);
                            }, 300);
                        }
                    });
                    
                    // Handle report contact action
                    document.getElementById('report-contact-btn').addEventListener('click', function() {
                        if (confirm('Are you sure you want to report this contact?')) {
                            fetch(`/api/users/${contact.id}/report`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.message) {
                                    showNotification(data.message, data.message.includes('already') ? 'warning' : 'success');
                                    // Close the contact info panel
                                    panel.style.transform = 'translateX(100%)';
                                    setTimeout(() => {
                                        document.body.removeChild(modal);
                                    }, 300);
                                }
                            })
                            .catch(error => {
                                console.error('Error reporting user:', error);
                                showNotification('Error reporting user', 'error');
                            });
                        }
                    });
                })
                .catch(error => {
                    console.error('Error fetching contact info:', error);
                    showNotification('Error loading contact information', 'error');
                });
        }

        // ... existing code ...

        // Update the delete group functionality to properly handle cleanup
        function deleteGroup(groupId) {
            if (confirm('Are you sure you want to delete this group? This action cannot be undone.')) {
                fetch('/chat/delete_group', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        group_id: groupId
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    showNotification(data.message, 'success');
                    
                    // Close the group info panel if it's open
                    const modal = document.querySelector('.modal');
                    if (modal) {
                        modal.remove();
                    }
                    
                    // Clear the chat area
                    const chatBody = document.querySelector('.chat-body');
                    if (chatBody) {
                        chatBody.innerHTML = `
                            <div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #8696a0;">
                                Select a chat to start messaging
                            </div>
                        `;
                    }
                    
                    // Clear the chat header
                    const chatHeader = document.querySelector('.chat-header');
                    if (chatHeader) {
                        chatHeader.innerHTML = '';
                    }
                    
                    // Clear any stored active chat info
                    currentChat = null;
                    
                    // Refresh the groups list and switch to groups view
                    loadGroups();
                    showGroupsView();
                })
                .catch(error => {
                    showNotification('Error deleting group: ' + error.message, 'error');
                    console.error('Error:', error);
                });
            }
        }

        // Update the loadContactsForGroupCreation function to handle errors better
        function loadContactsForGroupCreation(groupId) {
            const contactsList = document.getElementById('add-members-list') || document.getElementById('contact-selection-list');
            
            // Show loading state
            contactsList.innerHTML = `
                <div class="loading-contacts" style="color: #8696a0; text-align: center; padding: 20px;">
                    Loading contacts...
                </div>
            `;

            // Get all users first
            fetch('/chat/user_info')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(users => {
                    if (groupId) {
                        // If we have a groupId, get group members to filter them out
                        return fetch(`/chat/group/${groupId}`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                return response.json();
                            })
                            .then(groupInfo => {
                                const existingMemberIds = new Set(groupInfo.members.map(member => member.id));
                                return users.filter(user => !existingMemberIds.has(user.id));
                            })
                            .catch(error => {
                                console.error('Error fetching group info:', error);
                                return users;
                            });
                    } else {
                        return users;
                    }
                })
                .then(filteredUsers => {
                    contactsList.innerHTML = '';
                    
                    if (filteredUsers.length === 0) {
                        contactsList.innerHTML = `
                            <div style="color: #8696a0; text-align: center; padding: 20px;">
                                No contacts available to add
                            </div>
                        `;
                        return;
                    }
                    
                    filteredUsers.forEach(user => {
                        const contactElement = document.createElement('div');
                        contactElement.className = 'contact-selection-item';
                        contactElement.setAttribute('data-contact-id', user.id);
                        contactElement.setAttribute('data-contact-name', user.username);
                        
                        const profilePic = user.profile_picture ? 
                            `/uploads/profile_photos/${user.profile_picture}` : 
                            'Backend/static/images/contact_logo.png';
                        
                        contactElement.innerHTML = `
                            <div style="display: flex; align-items: center; padding: 10px; cursor: pointer;">
                                <div style="width: 40px; height: 40px; border-radius: 20px; overflow: hidden; margin-right: 15px;">
                                    <img src="${profilePic}" alt="${user.username}" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <div style="flex: 1;">
                                    <div style="color: #e9edef;">${user.username}</div>
                                    <div style="color: #8696a0; font-size: 13px;">${user.name || ''}</div>
                                </div>
                                <div class="contact-checkbox" style="width: 20px; height: 20px; border: 2px solid #8696a0; border-radius: 3px;"></div>
                            </div>
                        `;
                        
                        contactElement.addEventListener('click', function() {
                            const checkbox = this.querySelector('.contact-checkbox');
                            const userId = parseInt(this.getAttribute('data-contact-id'));
                            
                            if (selectedMembers.has(userId)) {
                                selectedMembers.delete(userId);
                                checkbox.style.backgroundColor = '';
                                checkbox.innerHTML = '';
                            } else {
                                selectedMembers.set(userId, {
                                    name: this.getAttribute('data-contact-name'),
                                    profilePic: profilePic
                                });
                                checkbox.style.backgroundColor = '#00a884';
                                checkbox.innerHTML = `
                                    <svg viewBox="0 0 24 24" width="16" height="16" style="fill: white; margin: 0 auto;">
                                        <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"></path>
                                    </svg>
                                `;
                            }
                            
                            // Update add members button state
                            const addButton = document.getElementById('add-selected-members');
                            if (addButton) {
                                addButton.disabled = selectedMembers.size === 0;
                                addButton.style.opacity = selectedMembers.size === 0 ? '0.5' : '1';
                            }
                        });
                        
                        contactsList.appendChild(contactElement);
                    });
                })
                .catch(error => {
                    console.error('Error loading contacts:', error);
                    const contactsList = document.getElementById('add-members-list') || document.getElementById('contact-selection-list');
                    contactsList.innerHTML = `
                        <div style="color: #ff6b6b; text-align: center; padding: 20px;">
                            Error loading contacts. Please try again.
                        </div>
                    `;
                });
        }

        // ... existing code ...

        // Function to update group list order
        function updateGroupListOrder(groupId, message = null, senderId = null, senderName = null) {
            const groupElement = document.querySelector(`.contact[data-group-id="${groupId}"]`);
            if (!groupElement) return;
            
            const currentUserId = document.documentElement.getAttribute('data-user-id');
            const isFromCurrentUser = senderId == currentUserId;
            
            // Update message preview if provided
            if (message) {
                const statusElement = groupElement.querySelector('.contact-status');
                if (statusElement) {
                    statusElement.textContent = isFromCurrentUser ? `You: ${message}` : `${senderName}: ${message}`;
                }
            }
            
            // Update timestamp
            const timeElement = groupElement.querySelector('.message-time');
            if (timeElement) {
                const now = new Date();
                timeElement.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});
            }
            
            // Move group to top of list
            const groupsList = groupElement.parentElement;
            if (groupsList && groupsList.firstChild) {
                groupsList.insertBefore(groupElement, groupsList.firstChild);
            }
        }

        // ... existing code ...
        // Function to update next step button state
        function updateNextStepButton() {
            const nextButton = document.getElementById('next-step-btn');
            if (selectedMembers.size >= 2) {
                nextButton.style.opacity = '1';
                nextButton.disabled = false;
            } else {
                nextButton.style.opacity = '0.5';
                nextButton.disabled = true;
            }
        }

        // Function to update create group button state
        function updateCreateGroupButton() {
            const createButton = document.getElementById('create-group-btn');
            const groupName = document.getElementById('group-name').value.trim();
            
            // Enable button if there's a group name and at least 2 members selected
            if (groupName && selectedMembers.size >= 2) {
                createButton.style.opacity = '1';
                createButton.disabled = false;
            } else {
                createButton.style.opacity = '0.5';
                createButton.disabled = true;
            }
        }

        // Function to add a selected member
        function addSelectedMember(id, name, profilePic) {
            selectedMembers.set(id, { id, name, profilePic });
            updateSelectedMembersList();
            updateNextStepButton();
        }

        // Function to remove a selected member
        function removeSelectedMember(id) {
            selectedMembers.delete(id);
            updateSelectedMembersList();
            updateNextStepButton();
        }

        // Function to update the selected members list
        function updateSelectedMembersList() {
            const selectedCount = document.getElementById('selected-count');
            const selectedMembersContainer = document.getElementById('selected-members');
            
            if (selectedCount) {
                selectedCount.textContent = selectedMembers.size;
            }
            
            if (selectedMembersContainer) {
                selectedMembersContainer.innerHTML = '';
                
                selectedMembers.forEach((member, id) => {
                    const memberElement = document.createElement('div');
                    memberElement.style.display = 'flex';
                    memberElement.style.alignItems = 'center';
                    memberElement.style.background = '#2a3942';
                    memberElement.style.padding = '5px 10px';
                    memberElement.style.borderRadius = '15px';
                    memberElement.style.marginRight = '5px';
                    memberElement.style.marginBottom = '5px';
                    
                    memberElement.innerHTML = `
                        <img src="${member.profilePic}" alt="${member.name}" style="width: 20px; height: 20px; border-radius: 50%; margin-right: 5px;">
                        <span style="color: #e9edef; font-size: 14px;">${member.name}</span>
                        <div class="remove-member" style="margin-left: 5px; cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="16" height="16" style="color: #8696a0;">
                                <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                            </svg>
                        </div>
                    `;
                    
                    memberElement.querySelector('.remove-member').addEventListener('click', function(e) {
                        e.stopPropagation();
                        removeSelectedMember(id);
                        updateContactCheckbox(id, false);
                    });
                    
                    selectedMembersContainer.appendChild(memberElement);
                });
            }
        }

        // Function to update contact checkbox state
        function updateContactCheckbox(contactId, isSelected) {
            const contactElement = document.querySelector(`.contact-selection-item[data-contact-id="${contactId}"]`);
            if (contactElement) {
                const checkbox = contactElement.querySelector('.contact-checkbox');
                const checkmark = checkbox.querySelector('svg');
                checkbox.style.borderColor = isSelected ? '#00a884' : '#8696a0';
                checkmark.style.display = isSelected ? 'block' : 'none';
            }
        }

        // Function to filter contacts for group creation
        function filterContactsForGroupCreation(searchTerm) {
            const contacts = document.querySelectorAll('.contact-selection-item');
            
            contacts.forEach(contact => {
                const name = contact.getAttribute('data-contact-name').toLowerCase();
                if (name.includes(searchTerm)) {
                    contact.style.display = '';
                } else {
                    contact.style.display = 'none';
                }
            });
        }

        // Add event listener for contact search
        document.addEventListener('input', function(e) {
            if (e.target && e.target.id === 'search-members') {
                filterContactsForGroupCreation(e.target.value.toLowerCase());
            }
        });

        // Function to load contacts for group creation
        function loadContactsForGroupCreation() {
            const contactsList = document.getElementById('contact-selection-list');
            
            fetch('/chat/contacts')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load contacts');
                    }
                    return response.json();
                })
                .then(contacts => {
                    contactsList.innerHTML = '';
                    
                    if (contacts.length === 0) {
                        contactsList.innerHTML = '<div style="text-align: center; color: #8696a0; padding: 20px;">No contacts found. Add contacts first to create a group.</div>';
                        return;
                    }
                    
                    // Create contact elements for selection
                    contacts.forEach(contact => {
                        let contactId, contactName, profilePic;
                        
                        // Handle different contact data formats
                        if (Array.isArray(contact)) {
                            contactId = contact[0];
                            contactName = contact[1];
                            profilePic = 'Backend/static/images/contact_logo.png'; // Default placeholder
                        } else {
                            contactId = contact.id;
                            contactName = contact.username || contact.name;
                            profilePic = contact.profile_picture ? `/uploads/profile_photos/${contact.profile_picture}` : 'Backend/static/images/contact_logo.png';
                        }
                        
                        const contactElement = document.createElement('div');
                        contactElement.className = 'contact-selection-item';
                        contactElement.setAttribute('data-contact-id', contactId);
                        contactElement.setAttribute('data-contact-name', contactName);
                        
                        // Check if this contact is already selected
                        const isSelected = selectedMembers.has(contactId);
                        
                        contactElement.innerHTML = `
                            <div style="display: flex; align-items: center; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #222d34; transition: background-color 0.2s;">
                                <div style="width: 45px; height: 45px; border-radius: 50%; margin-right: 15px; overflow: hidden;">
                                    <img src="${profilePic}" alt="${contactName}" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                                <div style="flex: 1;">
                                    <div style="color: #e9edef; font-size: 16px;">${contactName}</div>
                                </div>
                                <div class="contact-checkbox" style="width: 24px; height: 24px; border: 2px solid ${isSelected ? '#00a884' : '#8696a0'}; border-radius: 50%; display: flex; justify-content: center; align-items: center;">
                                    <svg viewBox="0 0 24 24" width="18" height="18" style="display: ${isSelected ? 'block' : 'none'};">
                                        <path fill="#00a884" d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"></path>
                                    </svg>
                                </div>
                            </div>
                        `;
                        
                        contactElement.addEventListener('click', function() {
                            const contactId = this.getAttribute('data-contact-id');
                            const contactName = this.getAttribute('data-contact-name');
                            const isSelected = selectedMembers.has(contactId);
                            
                            if (isSelected) {
                                removeSelectedMember(contactId);
                                updateContactCheckbox(contactId, false);
                            } else {
                                addSelectedMember(contactId, contactName, profilePic);
                                updateContactCheckbox(contactId, true);
                            }
                        });
                        
                        contactsList.appendChild(contactElement);
                    });
                })
                .catch(error => {
                    console.error('Error loading contacts:', error);
                    contactsList.innerHTML = '<div style="text-align: center; color: #ff6b6b; padding: 20px;">Failed to load contacts. Please try again.</div>';
                });
        }
// ... rest of the code ...

        // Add this after the socket initialization
        const EDIT_TIME_LIMIT = 5 * 60 * 1000; // 5 minutes in milliseconds
        
        function canEditMessage(timestamp) {
            const messageTime = new Date(timestamp);
            const currentTime = new Date();
            return (currentTime - messageTime) < EDIT_TIME_LIMIT;
        }
        
        function setupMessageOptions(messageElement) {
            console.log('Setting up message options for element:', messageElement);
            const messageContent = messageElement.querySelector('.message-content');
            const timestamp = messageElement.getAttribute('data-timestamp');
            const isSent = messageElement.classList.contains('sent');
            
            console.log('Message details:', {
                hasContent: !!messageContent,
                timestamp: timestamp,
                isSent: isSent
            });
            
            if (!isSent) {
                console.log('Message is not sent by current user, skipping options setup');
                return;
            }
            
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'message-options';
            
            const editButton = document.createElement('div');
            editButton.className = 'message-option edit';
            editButton.innerHTML = '<i class="fas fa-edit"></i>';
            editButton.title = 'Edit message';
            
            const deleteButton = document.createElement('div');
            deleteButton.className = 'message-option delete';
            deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
            deleteButton.title = 'Delete message';
            
            optionsDiv.appendChild(editButton);
            optionsDiv.appendChild(deleteButton);
            messageElement.appendChild(optionsDiv);
            
            // Handle double click
            messageElement.addEventListener('dblclick', (e) => {
                console.log('Double click event triggered');
                e.preventDefault();
                e.stopPropagation();
                
                console.log('Message double-clicked:', {
                    messageId: messageElement.getAttribute('data-message-id'),
                    content: messageContent.textContent,
                    timestamp: messageElement.getAttribute('data-timestamp'),
                    isSent: messageElement.classList.contains('sent')
                });
                
                // Hide any other visible options
                document.querySelectorAll('.message-options.visible').forEach(el => {
                    if (el !== optionsDiv) {
                        el.classList.remove('visible');
                    }
                });
                
                // Toggle current options
                optionsDiv.classList.toggle('visible');
                console.log('Options visibility toggled:', optionsDiv.classList.contains('visible'));
            });
            
            // Hide options when clicking outside
            document.addEventListener('click', (e) => {
                if (!messageElement.contains(e.target)) {
                    optionsDiv.classList.remove('visible');
                }
            });
            
            // Handle edit
            editButton.addEventListener('click', (e) => {
                console.log('Edit button clicked');
                e.stopPropagation();
                if (!canEditMessage(timestamp)) {
                    alert('Message can only be edited within 5 minutes of sending');
                    return;
                }
                
                const messageInput = document.getElementById('message-input');
                messageInput.value = messageContent.textContent;
                messageInput.focus();
                
                // Store the message ID for editing
                messageInput.setAttribute('data-editing-message-id', messageElement.getAttribute('data-message-id'));
                optionsDiv.classList.remove('visible');
            });
            
            // Handle delete
            deleteButton.addEventListener('click', (e) => {
                console.log('Delete button clicked');
                e.stopPropagation();
                messageContent.textContent = 'This message was deleted';
                messageElement.classList.add('deleted');
                optionsDiv.remove();
                
                // Emit delete event to server
                socket.emit('delete_message', {
                    message_id: messageElement.getAttribute('data-message-id')
                });
            });
        }
        
        // Modify the message creation code to include timestamp
        function createMessageElement(message, isSent, timestamp, messageId) {
            console.log('Creating message element:', { message, isSent, timestamp, messageId });
            const messageElement = document.createElement('div');
            messageElement.className = isSent ? 'message sent' : 'message received';
            messageElement.setAttribute('data-message-id', messageId);
            messageElement.setAttribute('data-timestamp', timestamp);
            
            messageElement.innerHTML = `
                <div class="message-content">${message}</div>
                <div class="message-meta">
                    <span class="message-timestamp">${formatMessageTimestamp(timestamp, true)}</span>
                </div>
            `;
            
            if (isSent) {
                console.log('Setting up options for sent message');
                setupMessageOptions(messageElement);
            }
            
            return messageElement;
        }
        
        // Modify the send message handler to handle editing
        function handleSendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            const editingMessageId = messageInput.getAttribute('data-editing-message-id');
            
            if (!message) return;
            
            const timestamp = Date.now();
            const messageId = editingMessageId || `msg_${timestamp}_${Math.random().toString(36).substring(2, 9)}`;
            
            // Clear input
            messageInput.value = '';
            messageInput.removeAttribute('data-editing-message-id');
            
            if (window.currentChat.type === 'group') {
                // ... existing group message code ...
                
                // If editing, update the existing message
                if (editingMessageId) {
                    const existingMessage = document.querySelector(`[data-message-id="${editingMessageId}"]`);
                    if (existingMessage) {
                        const contentDiv = existingMessage.querySelector('.message-content');
                        contentDiv.textContent = message;
                        
                        // Add edited indicator if not already present
                        if (!existingMessage.querySelector('.edited-indicator')) {
                            const editedSpan = document.createElement('span');
                            editedSpan.className = 'edited-indicator';
                            editedSpan.textContent = 'edited';
                            existingMessage.querySelector('.message-timestamp').after(editedSpan);
                        }
                    }
                } else {
                    // ... existing new message code ...
                }
                
                socket.emit('send_message', {
                    group_id: window.currentChat.id,
                    message: message,
                    timestamp: timestamp,
                    message_id: messageId,
                    is_edit: !!editingMessageId,
                    original_message_id: editingMessageId
                });
            } else if (window.currentChat.type === 'direct') {
                // ... existing direct message code ...
                
                // If editing, update the existing message
                if (editingMessageId) {
                    const existingMessage = document.querySelector(`[data-message-id="${editingMessageId}"]`);
                    if (existingMessage) {
                        const contentDiv = existingMessage.querySelector('.message-content');
                        contentDiv.textContent = message;
                        
                        // Add edited indicator if not already present
                        if (!existingMessage.querySelector('.edited-indicator')) {
                            const editedSpan = document.createElement('span');
                            editedSpan.className = 'edited-indicator';
                            editedSpan.textContent = 'edited';
                            existingMessage.querySelector('.message-timestamp').after(editedSpan);
                        }
                    }
                } else {
                    // ... existing new message code ...
                }
                
                socket.emit('send_message', {
                    receiver_id: window.currentChat.id,
                    message: message,
                    timestamp: timestamp,
                    message_id: messageId,
                    is_edit: !!editingMessageId,
                    original_message_id: editingMessageId
                });
            }
        }

        // Add a diagnostic function to the debugging menu
        
        // ... existing code ...
        // Function to show group info
        function showGroupInfo(group) {
            // Create a modal to display group info
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '1000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'flex-end'; // Align to right side
            modal.style.alignItems = 'stretch';
            
            // Group profile picture
            const profilePic = group.picture ? `/uploads/group_images/${group.picture}` : 'Backend/static/images/group_logo.png';
            
            // Create side panel
            const panel = document.createElement('div');
            panel.className = 'group-info-panel';
            panel.style.background = 'rgba(255, 255, 255, 0.85)'; // semi-transparent white
            panel.style.width = '350px';
            panel.style.maxWidth = '100%';
            panel.style.position = 'fixed';
            panel.style.right = '0';
            panel.style.left = 'unset';
            panel.style.top = '60px'; // height of .chat-header
            panel.style.bottom = '60px'; // height of .chat-footer
            panel.style.height = 'unset';
            panel.style.overflowY = 'auto';
            panel.style.transition = 'transform 0.3s ease';
            panel.style.transform = 'translateX(100%)'; // Start offscreen
            panel.style.borderRadius = '20px 0 0 20px';
            panel.style.boxShadow = 'none';
            panel.style.zIndex = '1100';
            
            // Check if user is admin
            const isAdmin = group.is_admin || group.admin_id === parseInt(document.documentElement.getAttribute('data-user-id'));

            panel.innerHTML = `
                <div style="display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #2a3942;">
                    <div id="close-group-info" style="cursor: pointer; margin-right: 15px;">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor" d="M19.8 11H7.5l5.6-5.6L11.7 4l-8 8 8 8 1.4-1.4L7.5 13h12.3v-2z"></path>
                        </svg>
                    </div>
                    <h2 style="color: black; margin: 0; font-weight: bold;">Group Info</h2>
                </div>
                
                <div style="padding: 20px; text-align: center; border-bottom: 1px solid #2a3942;">
                    <div style="width: 150px; height: 150px; border-radius: 75px; overflow: hidden; margin: 0 auto 15px;">
                        <img src="${profilePic}" alt="${group.name}" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <h2 style="color: black; margin-bottom: 5px; font-weight: bold;">${group.name}</h2>
                    <p style="color: #1a2a3a; margin-bottom: 0;">Group · ${group.member_count} members</p>
                </div>
                
                ${group.description ? `
                <div style="padding: 15px; border-bottom: 1px solid #2a3942;">
                    <h3 style="color: black; margin-bottom: 10px; font-size: 16px; font-weight: bold;">Description</h3>
                    <p style="color: black; margin: 0;">${group.description}</p>
                </div>
                ` : ''}
                
                ${isAdmin ? `
                <div style="padding: 15px; border-bottom: 1px solid #2a3942;">
                    <button id="add-members-btn" class="action-button" style="width: 160px; padding: 10px 0; background-color: #00a884; color: #fff; border: none; border-radius: 18px; cursor: pointer; font-size: 15px; font-weight: bold; margin: 0 auto 10px auto; display: block;">Add Members</button>
                </div>
                ` : ''}
                
                <div style="padding: 15px; border-bottom: 1px solid #2a3942;">
                    <h3 style="color: black; margin-bottom: 10px; font-size: 16px; font-weight: bold;">Members</h3>
                    <div id="group-members-list">
                        ${group.members && group.members.length > 0 ? group.members.map(member => `
                            <div class="group-member" data-user-id="${member.id}" style="display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #2a3942; cursor: pointer;">
                                <div style="width: 40px; height: 40px; border-radius: 20px; overflow: hidden; margin-right: 15px;">
                                    <img src="${member.profile_picture ? `/uploads/profile_photos/${member.profile_picture}` : 'Backend/static/images/contact_logo.png'}" alt="${member.username}" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <div style="flex: 1;">
                                    <div style="color: black; font-weight: 500;">${member.username}</div>
                                    ${member.is_admin ? `<div style="color: #00a884; font-size: 12px; font-weight: bold;">Group Admin</div>` : ''}
                                </div>
                            </div>
                        `).join('') : '<div style="text-align: center; color: #1a2a3a; padding: 10px;">No members found</div>'}
                    </div>
                </div>
                
                <div style="padding: 15px;">
                    <div style="display: flex; justify-content: center; gap: 15px;">
                        <button id="leave-group-btn" class="action-button" style="width: 140px; padding: 10px 0; background-color: #f15c6d; color: #fff; border: none; border-radius: 18px; cursor: pointer; font-size: 15px; font-weight: bold;">Leave Group</button>
                        ${isAdmin ? `
                        <button id="delete-group-btn" class="action-button" style="width: 140px; padding: 10px 0; background-color: #f15c6d; color: #fff; border: none; border-radius: 18px; cursor: pointer; font-size: 15px; font-weight: bold;">Delete Group</button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            modal.appendChild(panel);
            document.body.appendChild(modal);
            
            // Add a slight delay for animation effect
            setTimeout(() => {
                panel.style.transform = 'translateX(0)';
            }, 10);
            
            // Close panel when button is clicked
            document.getElementById('close-group-info').addEventListener('click', function() {
                panel.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(modal);
                }, 300);
            });
            
            // Close panel when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    panel.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        document.body.removeChild(modal);
                    }, 300);
                }
            });
            
            // Add click event to members to view their profile
            const memberElements = document.querySelectorAll('.group-member');
            memberElements.forEach(element => {
                element.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    const member = group.members.find(m => m.id == userId);
                    
                    if (member) {
                        // Close current panel first
                        panel.style.transform = 'translateX(100%)';
                        setTimeout(() => {
                            document.body.removeChild(modal);
                            // Show user profile
                            showContactInfo(member);
                        }, 300);
                    }
                });
            });
            
            // Handle leave group action
            document.getElementById('leave-group-btn').addEventListener('click', function() {
                leaveGroup(group.id);
            });

            // Handle delete group action for admin
            if (isAdmin && document.getElementById('delete-group-btn')) {
                document.getElementById('delete-group-btn').addEventListener('click', function() {
                    deleteGroup(group.id);
                });
            }

            // Add members functionality (if admin)
            const addMembersBtn = document.getElementById('add-members-btn');
            if (addMembersBtn) {
                addMembersBtn.addEventListener('click', function() {
                    // Close the current panel
                    panel.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        document.body.removeChild(modal);
                        // Show add members view
                        showAddGroupMembersView(group.id);
                    }, 300);
                });
            }
        }
// ... existing code ...

        
// ... existing code ...

        // Function to handle leaving a group
        function leaveGroup(groupId) {
            if (confirm('Are you sure you want to leave this group?')) {
                fetch('/chat/leave_group', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        group_id: groupId
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    showNotification(data.message, 'success');
                    
                    // Close the group info panel if it's open
                    const modal = document.querySelector('.modal');
                    if (modal) {
                        modal.remove();
                    }
                    
                    // Clear the chat area
                    const chatBody = document.querySelector('.chat-body');
                    if (chatBody) {
                        chatBody.innerHTML = `
                            <div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #8696a0;">
                                Select a chat to start messaging
                            </div>
                        `;
                    }
                    
                    // Clear the chat header
                    const chatHeader = document.querySelector('.chat-header');
                    if (chatHeader) {
                        chatHeader.innerHTML = '';
                    }
                    
                    // Clear any stored active chat info
                    currentChat = null;
                    
                    // Refresh the groups list and switch to groups view
                    loadGroups();
                    showGroupsView();
                })
                .catch(error => {
                    showNotification('Error leaving group: ' + error.message, 'error');
                    console.error('Error:', error);
                });
            }
        }

        // ... existing code ...

        // Function to show logout confirmation
        function showLogoutConfirmation() {
            // Create and show logout confirmation modal
            const modal = document.createElement('div');
            modal.className = 'logout-modal';
            modal.style.display = 'flex';
            
            modal.innerHTML = `
                <div class="logout-modal-content">
                    <div class="logout-modal-title">Are you sure you want to logout?</div>
                    <div class="logout-modal-buttons">
                        <button class="logout-modal-button logout-modal-cancel">Cancel</button>
                        <button class="logout-modal-button logout-modal-confirm">Logout</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle cancel button
            modal.querySelector('.logout-modal-cancel').addEventListener('click', () => {
                modal.remove();
            });
            
            // Handle confirm button
            modal.querySelector('.logout-modal-confirm').addEventListener('click', () => {
                fetch('/auth/logout', {
                    method: 'POST'
                })
                .then(response => {
                    if (response.ok) {
                        window.location.href = '/';
                    }
                })
                .catch(error => console.error('Error logging out:', error));
            });
        }

        // ... existing code ...

        // Function to load group messages
        function loadGroupMessages(groupId) {
            const chatBody = document.querySelector('.chat-body');
            chatBody.innerHTML = '';
            
            // Show loading indicator
            const loadingElement = document.createElement('div');
            loadingElement.className = 'message';
            loadingElement.style.alignSelf = 'center';
            loadingElement.textContent = 'Loading messages...';
            chatBody.appendChild(loadingElement);
            
            // Fetch messages for this group
            fetch(`/chat/get_group_messages/${groupId}`)
                .then(response => response.json())
                .then(messages => {
                    // Remove loading indicator
                    chatBody.innerHTML = '';
                    
                    if (messages.length === 0) {
                        const welcomeElement = document.createElement('div');
                        welcomeElement.className = 'message';
                        welcomeElement.style.alignSelf = 'center';
                        welcomeElement.style.backgroundColor = '#202c33';
                        welcomeElement.style.padding = '10px 15px';
                        welcomeElement.style.borderRadius = '8px';
                        welcomeElement.style.color = '#e9edef';
                        welcomeElement.textContent = `No messages yet in this group. Be the first to say hello!`;
                        chatBody.appendChild(welcomeElement);
                        return;
                    }

                    let lastMessageDate = null;
                    
                    // Display each message
                    messages.forEach(msg => {
                        // In group messages, we get [sender_id, sender_username, message, time, profile_picture]
                        const [senderId, senderUsername, msgContent, timestamp, profilePic] = msg;
                        
                        const messageDate = new Date(timestamp);
                        
                        // Add date separator if this is a new day
                        if (!lastMessageDate || lastMessageDate.toDateString() !== messageDate.toDateString()) {
                            const dateSeparator = document.createElement('div');
                            dateSeparator.className = 'date-separator';
                            dateSeparator.textContent = formatDateSeparator(messageDate);
                            chatBody.appendChild(dateSeparator);
                            lastMessageDate = messageDate;
                        }
                        
                        // Format the timestamp for the message
                        const formattedTime = formatMessageTimestamp(timestamp);
                        
                        // Check if this is a sent or received message
                        const currentUserId = document.documentElement.getAttribute('data-user-id');
                        const isSent = senderId.toString() === currentUserId;
                        
                        // Get profile picture URL
                        const profilePicUrl = profilePic ? `/uploads/profile_photos/${profilePic}` : '/api/placeholder/32/32';
                        
                        // Generate a stable message ID
                        const messageId = `group_${groupId}_${senderId}_${timestamp.replace(/[^0-9]/g, '')}_${msgContent.substring(0, 10).replace(/\s/g, '')}`;
                        
                        // Create message element
                        const messageElement = document.createElement('div');
                        messageElement.className = isSent ? 'message sent' : 'message received';
                        messageElement.setAttribute('data-message-id', messageId);
                        messageElement.setAttribute('data-timestamp', timestamp);
                        
                        if (isSent) {
                            messageElement.innerHTML = `
                                <div class="message-content">${msgContent}</div>
                                <div class="message-meta">
                                    <span class="message-timestamp">${formattedTime}</span>
                                </div>
                            `;
                        } else {
                            messageElement.innerHTML = `
                                <div class="message-avatar">
                                    <img src="${profilePicUrl}" alt="${senderUsername}" width="32" height="32">
                                </div>
                                <div class="message-bubble">
                                    <div class="message-sender" style="font-size: 12px; color: #00a884; margin-bottom: 2px;">${senderUsername}</div>
                                    <div class="message-content">${msgContent}</div>
                                    <div class="message-meta">
                                        <span class="message-timestamp">${formattedTime}</span>
                                    </div>
                                </div>
                            `;
                        }
                        
                        chatBody.appendChild(messageElement);
                    });
                    
                    // Scroll to bottom
                    chatBody.scrollTop = chatBody.scrollHeight;
                    
                    // Update the message input placeholder
                    document.querySelector('.message-input').placeholder = 'Type a message to the group...';
                })
                .catch(error => {
                    console.error('Error loading group messages:', error);
                    chatBody.innerHTML = '';
                    
                    const errorElement = document.createElement('div');
                    errorElement.className = 'message';
                    errorElement.style.alignSelf = 'center';
                    errorElement.style.backgroundColor = '#8B0000';
                    errorElement.style.padding = '10px 15px';
                    errorElement.style.borderRadius = '8px';
                    errorElement.style.color = '#ffffff';
                    errorElement.textContent = 'Error loading messages. Please try again.';
                    chatBody.appendChild(errorElement);
                });
        }

        // Function to add a new message to the chat (used for both direct and group messages)
        function addMessageToChat(messageData, isGroup = false) {
            const chatBody = document.querySelector('.chat-body');
            if (!chatBody) return;

            const timestamp = messageData.timestamp || Date.now();
            const messageDate = new Date(timestamp);
            
            // Check if we need to add a new date separator
            const lastDateSeparator = chatBody.querySelector('.date-separator:last-child');
            const lastMessageDate = lastDateSeparator ? new Date(lastDateSeparator.getAttribute('data-date')) : null;
            
            if (!lastMessageDate || lastMessageDate.toDateString() !== messageDate.toDateString()) {
                const dateSeparator = document.createElement('div');
                dateSeparator.className = 'date-separator';
                dateSeparator.setAttribute('data-date', messageDate.toISOString());
                dateSeparator.textContent = formatDateSeparator(messageDate);
                chatBody.appendChild(dateSeparator);
            }
            
            const isFromCurrentUser = messageData.sender_id.toString() === document.documentElement.getAttribute('data-user-id');
            const formattedTime = formatMessageTimestamp(timestamp);
            
            // Generate message ID
            const messageId = isGroup ? 
                `group_${messageData.group_id}_${messageData.sender_id}_${timestamp}_${messageData.message.substring(0, 10).replace(/\s/g, '')}` :
                `direct_${messageData.sender_id}_${timestamp}_${messageData.message.substring(0, 10).replace(/\s/g, '')}`;
            
            const messageElement = document.createElement('div');
            messageElement.className = isFromCurrentUser ? 'message sent' : 'message received';
            messageElement.setAttribute('data-message-id', messageId);
            messageElement.setAttribute('data-timestamp', timestamp);
            
            if (isGroup && !isFromCurrentUser) {
                const profilePicUrl = messageData.sender_profile_picture || '/api/placeholder/32/32';
                messageElement.innerHTML = `
                    <div class="message-avatar">
                        <img src="${profilePicUrl}" alt="${messageData.sender_username}" width="32" height="32">
                    </div>
                    <div class="message-bubble">
                        <div class="message-sender" style="font-size: 12px; color: #00a884; margin-bottom: 2px;">${messageData.sender_username}</div>
                        <div class="message-content">${messageData.message}</div>
                        <div class="message-meta">
                            <span class="message-timestamp">${formattedTime}</span>
                        </div>
                    </div>
                `;
            } else {
                messageElement.innerHTML = `
                    <div class="message-content">${messageData.message}</div>
                    <div class="message-meta">
                        <span class="message-timestamp">${formattedTime}</span>
                    </div>
                `;
            }
            
            chatBody.appendChild(messageElement);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        // Update the socket.on('new_message') handler to use the new addMessageToChat function
        socket.on('new_message', function(data) {
            console.log('Received new_message:', data);
            
            const currentChatId = window.currentChat?.id;
            const currentChatType = window.currentChat?.type;
            const isFromCurrentUser = data.sender_id.toString() === document.documentElement.getAttribute('data-user-id');
            
            // Handle message display in chat
            if (data.group_id) {
                // Update group list order and message preview
                updateGroupListOrder(data.group_id, data.message, data.sender_id, data.sender_username);
                
                if (currentChatType === 'group' && currentChatId == data.group_id) {
                    addMessageToChat(data, true);
                } else if (!isFromCurrentUser) {
                    showNotification(`New message in ${data.group_name || 'group'}: ${data.message}`);
                }
            } else if (data.sender_id) {
                if (currentChatType === 'direct' && 
                    (currentChatId == data.sender_id || currentChatId == data.receiver_id)) {
                    addMessageToChat(data, false);
                } else if (!isFromCurrentUser) {
                    showNotification(`New message from ${data.sender_username}: ${data.message}`);
                }
            }
        });
    </script>
</body>
</html>

