<!DOCTYPE html>
<html lang="en" 
    {% if session and session.user_id %}
    data-user-id="{{ session.user_id }}"
    data-authenticated="true"
    {% else %}
    data-authenticated="false"
    {% endif %}
>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TogolohChat</title>
    <!-- Include Socket.IO client library -->
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        body {
            background-color: #111b21;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .chat-container {
            display: flex;
            height: 100vh;
            width: 100%;
        }
        
        .sidebar {
            width: 30%;
            height: 100vh;
            background-color: #111b21;
            border-right: 1px solid #222d34;
            display: flex;
            flex-direction: column;
            position: relative; /* Add this */
        }
        
        .sidebar-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding-bottom: 60px; /* Add padding at bottom to ensure content doesn't go under the nav bar */
        }
        
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            height: 60px;
            background-color: #202c33;
        }
        
        .app-name {
            color: #e9edef;
            font-size: 16px;
            font-weight: bold;
        }
        
        .sidebar-header-icons {
            display: flex;
            gap: 15px;
        }
        
        .search-container {
            padding: 8px;
            background-color: #111b21;
        }
        
        .search-bar {
            background-color: #202c33;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            align-items: center;
        }
        
        .search-bar input {
            background: transparent;
            border: none;
            color: #d1d7db;
            width: 100%;
            outline: none;
            margin-left: 10px;
            font-size: 15px;
        }
        
        .contact-list {
            overflow-y: auto;
            flex: 1;
        }
        
        /* Contact styles that were accidentally removed */
        .contact {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #222d34;
            cursor: pointer;
        }
        
        .contact:hover {
            background-color: #202c33;
        }
        
        .contact-active {
            background-color: #2a3942;
        }
        
        .profile-pic {
            width: 49px;
            height: 49px;
            border-radius: 50%;
            margin-right: 15px;
            overflow: hidden;
        }
        
        .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .contact-info {
            flex: 1;
        }
        
        .contact-name {
            color: #e9edef;
            font-size: 17px;
            margin-bottom: 3px;
        }
        
        .contact-message {
            color: #8696a0;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .contact-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            min-width: 45px;
        }
        
        .message-time {
            color: #8696a0;
            font-size: 12px;
            margin-bottom: 3px;
        }
        
        /* Sidebar Navigation */
        .sidebar-nav {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #202c33;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 1001; /* Ensure it stays above other content */
            height: 70px; /* Increased height */
        }
        
        .nav-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* Add this to center content vertically */
            color: #8696a0;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background-color 0.2s;
            min-width: 70px; /* Increased from 60px */
            height: 100%; /* Make it take full height */
        }
        
        .nav-icon:hover {
            background-color: #2a3942;
        }
        
        .nav-icon.active {
            color: #00a884;
        }
        
        .nav-icon svg {
            margin-bottom: 6px; /* Increased from 4px */
            width: 28px; /* Increased from 24px */
            height: 28px; /* Increased from 24px */
        }
        
        .nav-icon-label {
            font-size: 13px; /* Increased from 12px */
            font-weight: 500; /* Added font weight */
        }
        
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #0b141a;
            position: relative;
        }
        
        .chat-header {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            background-color: #202c33;
            height: 60px;
        }
        
        .chat-header-info {
            flex: 1;
            margin-left: 15px;
        }
        
        .chat-header-name {
            color: #e9edef;
            font-size: 16px;
        }
        
        .chat-header-status {
            font-size: 13px;
            color: #8696a0;
            margin-top: 2px;
        }
        
        .chat-header-status.online {
            color: #00a884;
        }
        
        .chat-header-status.offline {
            color: #8696a0;
        }
        
        .chat-header-icons {
            display: flex;
            gap: 20px;
            color: #aebac1;
        }
        
        .chat-body {
            flex: 1;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-size: contain;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .message {
            max-width: 65%;
            padding: 8px 10px;
            margin-bottom: 8px;
            border-radius: 7.5px;
            position: relative;
            word-wrap: break-word;
        }
        
        .received {
            background-color: #202c33;
            color: #e9edef;
            align-self: flex-start;
            border-top-left-radius: 0;
        }
        
        .sent {
            background-color: #005c4b;
            color: #e9edef;
            align-self: flex-end;
            border-top-right-radius: 0;
        }
        
        .message-content {
            font-size: 14px;
            margin-right: 80px;
        }
        
        .message-timestamp {
            position: absolute;
            bottom: 5px;
            right: 7px;
            color: #8696a0;
            font-size: 11px;
        }
        
        .chat-footer {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #202c33;
        }
        
        .chat-footer-icons {
            display: flex;
            gap: 15px;
            color: #8696a0;
            padding: 0 15px;
        }
        
        .message-input {
            flex: 1;
            background-color: #2a3942;
            border-radius: 8px;
            border: none;
            padding: 9px 12px;
            color: #d1d7db;
            outline: none;
            font-size: 15px;
        }
        
        .send-button {
            margin-left: 10px;
            color: #8696a0;
            cursor: pointer;
        }
        
        .icon {
            cursor: pointer;
        }
        
        /* Content Areas */
        .content-area {
            display: none;
            flex: 1;
            flex-direction: column;
        }
        
        .content-area.active {
            display: flex;
        }
        
        .contacts-area {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        /* Contacts screen */
        .contacts-header {
            padding: 16px;
            background-color: #1f2c33;
            color: #e9edef;
            font-size: 20px;
            font-weight: bold;
        }
        
        /* Utility Classes */
        .flex-center {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                display: none;
            }
            
            .main-chat {
                width: 100%;
            }
        }
        
        /* Settings Sidebar Styles */
        .settings-sidebar {
            width: 30%;
            height: 100%;
            background-color: #111b21;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .settings-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            margin-bottom: 60px; /* Add space for navigation */
        }

        /* Profile Section Styles */
        .profile-section {
            background-color: #202c33;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .profile-avatar-container {
            position: relative;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            position: relative;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-edit {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            text-align: center;
            padding: 5px;
            cursor: pointer;
        }

        .profile-info {
            flex: 1;
        }

        .profile-nickname {
            color: #e9edef;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .profile-name input {
            background-color: transparent;
            border: none;
            border-bottom: 1px solid #374045;
            color: #e9edef;
            font-size: 16px;
            padding: 5px 0;
            width: 100%;
            outline: none;
        }

        .profile-bio textarea {
            background-color: transparent;
            border: 1px solid #374045;
            border-radius: 5px;
            color: #e9edef;
            width: 100%;
            padding: 10px;
            resize: none;
            height: 100px;
            outline: none;
        }

        .profile-bio textarea:focus,
        .profile-name input:focus {
            border-color: #00a884;
        }

        /* Settings Section Styles */
        .settings-section {
            background-color: #202c33;
            border-radius: 10px;
            padding: 20px;
        }
        
        .settings-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .settings-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            color: #e9edef;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        
        .settings-item:hover {
            background-color: #374045;
        }
        
        .settings-item i,
        .settings-item svg {
            width: 24px;
            height: 24px;
            color: #8696a0;
        }
        
        .settings-item span {
            font-size: 16px;
        }

        #logout-button {
            color: #f15e6c;
        }

        #logout-button i {
            color: #f15e6c;
        }

        /* Added for user selection */
        .user-item.user-selected {
            background-color: #2a3942 !important; /* Force selection background */
        }

        .add-contact-footer {
            padding: 10px 15px;
            background-color: #111b21;
            border-top: 1px solid #222d34;
            margin-top: auto; /* Push to bottom */
        }

        .add-contact-footer button {
            width: 100%;
            padding: 12px;
            background-color: #00a884;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .add-contact-footer button:disabled {
            background-color: #2a3942;
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ... existing styles ... */

        .contacts-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background-color: #111b21;
        }

        .contact-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #222d34;
            transition: background-color 0.2s;
        }

        .contact-item:hover {
            background-color: #202c33;
        }

        .contact-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin-right: 15px;
            overflow: hidden;
        }

        .contact-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            color: #e9edef;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .contact-status {
            color: #8696a0;
            font-size: 13px;
        }

        .loading-contacts {
            text-align: center;
            padding: 20px;
            color: #8696a0;
        }

        .no-contacts {
            text-align: center;
            padding: 20px;
            color: #8696a0;
        }

        /* Removing the duplicate sidebar-nav definition */
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Sidebar will be handled by you -->
        <div class="sidebar">
            <div class="sidebar-content">
            <div class="sidebar-header">
                <div class="app-name">TogolohChat</div>
                <div class="sidebar-header-icons">
                    <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                        <path fill="currentColor" d="M12 20.664a8.664 8.664 0 0 1-8.664-8.664A8.664 8.664 0 0 1 12 3.336a8.664 8.664 0 0 1 8.664 8.664A8.664 8.664 0 0 1 12 20.664zm0-17.328a8.664 8.664 0 0 0-8.664 8.664A8.664 8.664 0 0 0 12 20.664a8.664 8.664 0 0 0 8.664-8.664A8.664 8.664 0 0 0 12 3.336z"></path>
                        <path fill="currentColor" d="M12 14.504c-1.104 0-2-.896-2-2s.896-2 2-2 2 .896 2 2-.896 2-2 2zm0-5c-1.657 0-3 1.343-3 3s1.343 3 3 3 3-1.343 3-3-1.343-3-3-3z"></path>
                    </svg>
                </div>
            </div>
            
            <div class="search-container">
                <div class="search-bar">
                    <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                        <path fill="currentColor" d="M15.009 13.805h-.636l-.22-.219a5.184 5.184 0 0 0 1.256-3.386 5.207 5.207 0 1 0-5.207 5.208 5.183 5.183 0 0 0 3.385-1.255l.221.22v.635l4.004 3.999 1.194-1.195-3.997-4.007zm-4.808 0a3.605 3.605 0 1 1 0-7.21 3.605 3.605 0 0 1 0 7.21z"></path>
                    </svg>
                    <input type="text" id="search-input" placeholder="Іздеу же жаңы чат баштоо..." onkeyup="searchContacts()">
                </div>
            </div>
            
            <div class="contact-list" id="contact-list">
                <!-- Contacts will be loaded dynamically -->
                <div class="loading-contacts" style="color: #8696a0; text-align: center; padding: 20px;">
                    Loading contacts...
                    </div>
                </div>
            </div>
            
            <!-- Sidebar Navigation (moved from bottom) -->
            <div class="sidebar-nav">
                <div class="nav-icon active" data-target="contacts">
                    <svg viewBox="0 0 24 24" width="28" height="28">
                        <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"></path>
                    </svg>
                    <span class="nav-icon-label">Contacts</span>
                </div>
                <div class="nav-icon" data-target="groups">
                    <svg viewBox="0 0 24 24" width="28" height="28">
                        <path fill="currentColor" d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5z"></path>
                    </svg>
                    <span class="nav-icon-label">Groups</span>
                </div>
                <div class="nav-icon" data-target="add">
                    <svg viewBox="0 0 24 24" width="28" height="28">
                        <path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path>
                    </svg>
                    <span class="nav-icon-label">Add</span>
                </div>
                <div class="nav-icon" data-target="settings">
                    <svg viewBox="0 0 24 24" width="28" height="28">
                        <path fill="currentColor" d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"></path>
                    </svg>
                    <span class="nav-icon-label">Settings</span>
                </div>
            </div>
        </div>
        
        <!-- Settings Sidebar -->
        <div class="settings-sidebar" style="display: none;">
            <div class="sidebar-header">
                <div class="sidebar-header-back">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path fill="currentColor" d="M19.8 11H7.5l5.6-5.6L11.7 4l-8 8 8 8 1.4-1.4L7.5 13h12.3v-2z"></path>
                    </svg>
                </div>
                <div class="app-name">Profile & Settings</div>
                <div class="close-settings">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                    </svg>
                </div>
            </div>
            
            <div class="settings-content">
                <!-- Profile Section -->
                <div class="profile-section">
                    <div class="profile-header">
                        <div class="profile-avatar-container">
                            <div class="profile-avatar">
                                <img id="profile-avatar-img" src="/api/placeholder/100/100" alt="Profile">
                                <div class="avatar-edit">
                                    <i class="fa-solid fa-camera"></i>
                                </div>
                            </div>
                        </div>
                        <div class="profile-info">
                            <div class="profile-nickname" id="profile-nickname">Loading...</div>
                            <div class="profile-name">
                                <input type="text" id="profile-name-input" placeholder="Your Name">
                            </div>
                        </div>
                    </div>
                    <div class="profile-bio">
                        <textarea id="profile-bio-input" placeholder="Write something about yourself..."></textarea>
                    </div>
                </div>

                <!-- Settings Section -->
                <div class="settings-section">
            <div class="settings-list">
                <div class="settings-item" id="language-settings">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor" d="M12 22.0005C5.07 22.0005 1.5 18.5205 1.5 12.0005C1.5 5.48047 5.07 2.00047 12 2.00047C18.93 2.00047 22.5 5.48047 22.5 12.0005C22.5 18.5205 18.93 22.0005 12 22.0005ZM12 3.50047C5.82 3.50047 3 6.24047 3 12.0005C3 17.7605 5.82 20.5005 12 20.5005C18.18 20.5005 21 17.7605 21 12.0005C21 6.24047 18.18 3.50047 12 3.50047ZM15.53 13.8805C15.82 13.2405 16 12.9505 16 12.0005C16 11.0505 15.82 10.7605 15.53 10.1205C15.37 9.78047 15.1 9.50047 14.79 9.27047C14.43 9.00047 14.25 8.77047 14.25 7.75047V7.50047C14.25 6.94047 13.81 6.50047 13.25 6.50047H10.75C10.19 6.50047 9.75 6.94047 9.75 7.50047V7.72047C9.75 8.69047 9.59 8.87047 9.33 9.11047C9 9.42047 8.71 9.75047 8.5 10.1705C8.19 10.8005 8 11.1505 8 12.0005C8 12.8505 8.19 13.1905 8.48 13.7905C8.71 14.1905 9 14.5305 9.34 14.8505C9.58 15.0605 9.75 15.2805 9.75 16.2405V16.5005C9.75 17.0605 10.19 17.5005 10.75 17.5005H13.25C13.81 17.5005 14.25 17.0605 14.25 16.5005V16.2405C14.25 15.2805 14.41 15.0605 14.67 14.8305C15 14.5305 15.3 14.2005 15.53 13.8805ZM12 14.0005C10.9 14.0005 10 13.1005 10 12.0005C10 10.9005 10.9 10.0005 12 10.0005C13.1 10.0005 14 10.9005 14 12.0005C14 13.1005 13.1 14.0005 12 14.0005Z"></path>
                        </svg>
                    <span>Change Language</span>
                    </div>
                <div class="settings-item" id="password-settings">
                    <i class="fa-solid fa-key"></i>
                    <span>Change Password</span>
                </div>
                <div class="settings-item" id="admin-panel">
                    <i class="fa-solid fa-user-shield"></i>
                    <span>Admin Panel</span>
                        </div>
                        <div class="settings-item" id="logout-button">
                            <i class="fa-solid fa-right-from-bracket"></i>
                            <span>Logout</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="main-chat">
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="profile-pic">
                    <img src="/api/placeholder/49/49" alt="Profile">
                </div>
                <div class="chat-header-info">
                    <!-- there should be name and status of the user -->
                </div>
                <div class="chat-header-icons">
                    <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                        <path fill="currentColor" d="M15.9 14.3H15l-.3-.3c1-1.1 1.6-2.7 1.6-4.3 0-3.7-3-6.7-6.7-6.7S3 6 3 9.7s3 6.7 6.7 6.7c1.6 0 3.2-.6 4.3-1.6l.3.3v.8l5.1 5.1 1.5-1.5-5-5.2zm-6.2 0c-2.6 0-4.6-2.1-4.6-4.6s2.1-4.6 4.6-4.6 4.6 2.1 4.6 4.6-2 4.6-4.6 4.6z"></path>
                    </svg>
                    <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                        <path fill="currentColor" d="M12 7a2 2 0 1 0-.001-4.001A2 2 0 0 0 12 7zm0 2a2 2 0 1 0-.001 3.999A2 2 0 0 0 12 9zm0 6a2 2 0 1 0-.001 3.999A2 2 0 0 0 12 15z"></path>
                    </svg>
                </div>
            </div>
            
            <!-- Chat Body -->
            <div class="chat-body">
                <!-- there should be messages between users   -->
                 
            </div>
            
            <!-- Chat Footer -->
            <div class="chat-footer">
                <div class="chat-footer-icons">
                    <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                        <path fill="currentColor" d="M9.153 11.603c.795 0 1.439-.879 1.439-1.962s-.644-1.962-1.439-1.962-1.439.879-1.439 1.962.644 1.962 1.439 1.962zm-3.204 1.362c-.026-.307-.131 5.218 6.063 5.551 6.066-.25 6.066-5.551 6.066-5.551-6.078 1.416-12.129 0-12.129 0zm11.363 1.108s-.669 1.959-5.051 1.959c-3.505 0-5.388-1.164-5.607-1.959 0 0 5.912 1.055 10.658 0zM11.804 1.011C5.609 1.011.978 6.033.978 12.228s4.826 10.761 11.021 10.761S23.02 18.423 23.02 12.228c.001-6.195-5.021-11.217-11.216-11.217zM12 21.354c-5.273 0-9.381-3.886-9.381-9.159s3.942-9.548 9.215-9.548 9.548 4.275 9.548 9.548c-.001 5.272-4.109 9.159-9.382 9.159zm3.108-9.751c.795 0 1.439-.879 1.439-1.962s-.644-1.962-1.439-1.962-1.439.879-1.439 1.962.644 1.962 1.439 1.962z"></path>
                    </svg>
                    <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                        <path fill="currentColor" d="M1.816 15.556v.002c0 1.502.584 2.912 1.646 3.972s2.472 1.647 3.974 1.647a5.58 5.58 0 0 0 3.972-1.645l9.547-9.548c.769-.768 1.147-1.767 1.058-2.817-.079-.968-.548-1.927-1.319-2.698-1.594-1.592-4.068-1.711-5.517-.262l-7.916 7.915c-.881.881-.792 2.25.214 3.261.959.958 2.423 1.053 3.263.215l5.511-5.512c.28-.28.267-.722.053-.936l-.244-.244c-.191-.191-.567-.349-.957.04l-5.506 5.506c-.18.18-.635.127-.976-.214-.098-.097-.576-.613-.213-.973l7.915-7.917c.818-.817 2.267-.699 3.23.262.5.501.802 1.1.849 1.685.051.573-.156 1.111-.589 1.543l-9.547 9.549a3.97 3.97 0 0 1-2.829 1.171 3.975 3.975 0 0 1-2.83-1.173 3.973 3.973 0 0 1-1.172-2.828c0-1.071.415-2.076 1.172-2.83l7.209-7.211c.157-.157.264-.579.028-.814L11.5 4.36a.572.572 0 0 0-.834.018l-7.205 7.207a5.577 5.577 0 0 0-1.645 3.971z"></path>
                    </svg>
                </div>
                
                <input type="text" class="message-input" placeholder="Қабарыңызды жазыңыз">
                
                <div class="send-button">
                    <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                        <path fill="currentColor" d="M1.101 21.757L23.8 12.028 1.101 2.3l.011 7.912 13.623 1.816-13.623 1.817-.011 7.912z"></path>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Socket.IO connection with reconnection options
        const socket = io({
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            reconnectionAttempts: 5
        });
        
        // Initialize current chat variable
        window.currentChat = null;

        // Override function to ensure the right function is used for group header updates
        window.addEventListener('DOMContentLoaded', function() {
            // This will ensure our code runs after all definitions
            setTimeout(function() {
                // Store a reference to the old function with different parameters
                const updateChatHeaderSimple = window.updateChatHeader;
                
                // Make sure the full function with group support is always used
                window.updateChatHeader = function(entity, isGroup) {
                    console.log("Using enhanced updateChatHeader function");
                    
                    // Call the correct implementation that handles group chats
                    const chatHeader = document.querySelector('.chat-header');
                    
                    console.log("Updating chat header for:", isGroup ? "group" : "direct chat", entity);
                    
                    // Store entity for later reference
                    window.currentChat = {
                        id: Number(entity.id || entity),  // Handle both entity object and simple ID
                        type: isGroup ? 'group' : 'direct',
                        name: isGroup ? entity.name : (entity.username || entity),
                        entity: entity // Store the full entity for info panel
                    };
                    
                    console.log("Current chat updated to:", window.currentChat);
                    
                    // Get profile picture
                    const profilePic = isGroup
                        ? (entity.picture ? `/uploads/group_images/${entity.picture}` : '/api/placeholder/49/49')
                        : (entity.profile_picture ? `/uploads/profile_photos/${entity.profile_picture}` : '/api/placeholder/49/49');
                    
                    // Update header content
                    chatHeader.innerHTML = `
                        <div class="profile-pic" style="cursor: pointer;">
                            <img src="${profilePic}" alt="${isGroup ? entity.name : (entity.username || entity)}">
                        </div>
                        <div class="chat-header-info" style="cursor: pointer;">
                            <div class="chat-header-name">${isGroup ? entity.name : (entity.username || entity)}</div>
                            <div class="chat-header-status ${isUserOnline(entity.id || entity) ? 'online' : 'offline'}">${isGroup ? (entity.member_count + ' members') : (isUserOnline(entity.id || entity) ? 'online' : 'offline')}</div>
                        </div>
                        <div class="chat-header-icons">
                            <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                                <path fill="currentColor" d="M15.9 14.3H15l-.3-.3c1-1.1 1.6-2.7 1.6-4.3 0-3.7-3-6.7-6.7-6.7S3 6 3 9.7s3 6.7 6.7 6.7c1.6 0 3.2-.6 4.3-1.6l.3.3v.8l5.1 5.1 1.5-1.5-5-5.2zm-6.2 0c-2.6 0-4.6-2.1-4.6-4.6s2.1-4.6 4.6-4.6 4.6 2.1 4.6 4.6-2 4.6-4.6 4.6z"></path>
                            </svg>
                            <div class="info-button" style="cursor: pointer;">
                                <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                                    <path fill="currentColor" d="M12 7a2 2 0 1 0-.001-4.001A2 2 0 0 0 12 7zm0 2a2 2 0 1 0-.001 3.999A2 2 0 0 0 12 9zm0 6a2 2 0 1 0-.001 3.999A2 2 0 0 0 12 15z"></path>
                                </svg>
                            </div>
                        </div>
                    `;
                    
                    // Add event listener for profile click (both image and name/status area)
                    const profileElements = [
                        chatHeader.querySelector('.profile-pic'), 
                        chatHeader.querySelector('.chat-header-info')
                    ];
                    
                    profileElements.forEach(element => {
                        element.addEventListener('click', function() {
                            if (isGroup) {
                                showGroupInfo(entity);
                            } else {
                                showContactInfo(entity);
                            }
                        });
                    });
                    
                    // Add event listener for info button
                    chatHeader.querySelector('.info-button').addEventListener('click', function() {
                        if (isGroup) {
                            showGroupInfo(entity);
                        } else {
                            showContactInfo(entity);
                        }
                    });
                };
            }, 100);
        });
        
        // Clean up existing socket listeners
        function cleanupSocketListeners() {
            socket.off('new_message');
            socket.off('message_sent');
            socket.off('notification');
            socket.off('user_status');
        }
        
        // Setup socket event listeners
        function setupSocketListeners() {
            // Clean up existing listeners first
            cleanupSocketListeners();
        
        // Handle notifications
        socket.on('notification', function(data) {
            console.log('Received notification:', data);
            
            if (data.type === 'contact_added') {
                showNotification(data.message, 'success');
                loadContacts();
            }
            else if (data.type === 'added_to_group') {
                showNotification(data.message, 'success');
                loadContacts();
                
                if (document.querySelector('.nav-icon[data-target="groups"]').classList.contains('active')) {
                    loadGroups();
                }
            }
        });
        
            // Handle new message event
        socket.on('new_message', function(data) {
                console.log('Received new_message:', data);
            
            const currentChatId = window.currentChat?.id;
            const currentChatType = window.currentChat?.type;
            const isFromCurrentUser = data.sender_id == document.documentElement.getAttribute('data-user-id');
            const timestamp = data.timestamp || Date.now();
            const messageId = data.message_id || `msg_${timestamp}_${Math.random().toString(36).substring(2, 9)}`;
            
            // Check if this message already exists in the chat to prevent duplicates
            if (document.querySelector(`[data-message-id="${messageId}"]`)) {
                console.log('Preventing duplicate message:', messageId);
                return;
            }
            
            // Update contact list for the sender
            if (!isFromCurrentUser) {
                updateContactLastMessage(data.sender_id, data.message, timestamp);
            }
            
            // Handle message display in chat
            if (data.group_id) {
                console.log('Handling group message:', data.group_id, 'current chat:', currentChatId, currentChatType);
                
                if (currentChatType === 'group' && currentChatId == data.group_id) {
                    const chatBody = document.querySelector('.chat-body');
                    const messageElement = document.createElement('div');
                    messageElement.className = isFromCurrentUser ? 'message sent' : 'message received';
                    messageElement.setAttribute('data-message-id', messageId);
                        
                    const senderName = !isFromCurrentUser ? `<div class="message-sender" style="font-size: 12px; color: #00a884; margin-bottom: 2px;">${data.sender_username}</div>` : '';
                    
                    messageElement.innerHTML = `
                        ${senderName}
                        <div class="message-content">${data.message}</div>
                        <span class="message-timestamp">${new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    `;
                    
                    chatBody.appendChild(messageElement);
                    chatBody.scrollTop = chatBody.scrollHeight;
                } else {
                    showNotification(`New message in group: ${data.message}`);
                }
            } else {
                    if (currentChatType === 'direct' && (currentChatId == data.sender_id || currentChatId == data.receiver_id)) {
                    const chatBody = document.querySelector('.chat-body');
                    const messageElement = document.createElement('div');
                    messageElement.className = isFromCurrentUser ? 'message sent' : 'message received';
                    messageElement.setAttribute('data-message-id', messageId);
                    
                    messageElement.innerHTML = `
                        <div class="message-content">${data.message}</div>
                        <span class="message-timestamp">${new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    `;
                    
                    chatBody.appendChild(messageElement);
                    chatBody.scrollTop = chatBody.scrollHeight;
                    
                        // Send read receipt
                    socket.emit('update_message_status', {
                        message_id: data.message_id,
                        status: 'read',
                        chat_id: data.sender_id,
                        chat_type: 'direct'
                    });
                } else {
                    showNotification(`${data.sender_username}: ${data.message}`);
                }
            }
            });

            // Handle message sent confirmation
            socket.on('message_sent', function(data) {
                console.log('Message sent confirmation:', data);
                const timestamp = data.timestamp || Date.now();
                
                // Update contact list for the receiver
                updateContactLastMessage(data.receiver_id, data.message, timestamp);
                
                // Store the last active chat
                storeLastActiveChat(data.receiver_id, 'direct', data.receiver_username);
            });

            // Add user_status event listener
            socket.on('user_status', function(data) {
                console.log('User status update:', data);
                if (data.status === 'online') {
                    window.onlineUsers.add(data.user_id);
                } else {
                    window.onlineUsers.delete(data.user_id);
                }
                updateUserStatus(data.user_id, data.status === 'online');
            });
        }
        
        // Socket connection events
        socket.on('connect', function() {
            console.log('Connected to server');
            
            const htmlElement = document.documentElement;
            const isAuthenticated = htmlElement.getAttribute('data-authenticated') === 'true';
            
            if (isAuthenticated) {
                const userId = htmlElement.getAttribute('data-user-id');
                socket.emit('join', { room: userId });
                console.log('Joined personal room:', userId);
                
                // Request current online users
                socket.emit('request_online_users');
                
                // Setup socket listeners and load contacts
                setupSocketListeners();
                loadContacts();
            } else {
                console.log('Not authenticated, no room to join');
            }
        });
        
        socket.on('disconnect', function() {
            console.log('Disconnected from server');
            cleanupSocketListeners();
        });
        
        // Function to load contacts and groups from the backend
        function loadContacts() {
            const sidebarContent = document.querySelector('.sidebar-content');
            if (!sidebarContent) return;

            // Set up the contacts container structure
            sidebarContent.innerHTML = `
                <div class="contacts-container">
                    <div class="sidebar-header">
                        <div class="app-name">Contacts</div>
                    </div>
                    <div class="search-container">
                        <div class="search-bar">
                            <svg viewBox="0 0 24 24" width="24" height="24" class="search-icon">
                                <path fill="currentColor" d="M15.009 13.805h-.636l-.22-.219a5.184 5.184 0 0 0 1.256-3.386 5.207 5.207 0 1 0-5.207 5.208 5.183 5.183 0 0 0 3.385-1.255l.221.22v.635l4.004 3.999 1.194-1.195-3.997-4.007zm-4.808 0a3.605 3.605 0 1 1 0-7.21 3.605 3.605 0 0 1 0 7.21z"></path>
                            </svg>
                            <input type="text" id="contact-search" placeholder="Search contacts" onkeyup="filterContacts()">
                        </div>
                    </div>
                    <div class="contact-list">
                        <div class="loading-contacts">Loading contacts...</div>
                    </div>
                </div>
            `;

            // Fetch contacts from server
            console.log('Fetching contacts from server...');
            fetch('/chat/contacts')
                .then(response => {
                    console.log('Contacts API response status:', response.status);
                    if (!response.ok) {
                        throw new Error('Failed to load contacts');
                    }
                    return response.json();
                })
                .then(contacts => {
                    console.log('Received contacts:', contacts);
                    const contactList = document.querySelector('.contact-list');
                    
                    if (!contacts || contacts.length === 0) {
                        contactList.innerHTML = `
                            <div class="no-contacts">
                                <p>No contacts yet</p>
                                <p>Click the "+" button below to add contacts</p>
                            </div>
                        `;
                        return;
                    }

                    // Store contacts globally for search functionality
                    window.userContacts = contacts;
                    console.log('Stored contacts in window.userContacts:', window.userContacts);

                    // Clear loading message
                    contactList.innerHTML = '';

                    // Process and sort contacts
                    const processedContacts = contacts.map(contact => {
                        const [id, username, lastMessage, lastMessageTime] = contact;
                        return {
                            id,
                            username,
                            last_message: lastMessage || '',
                            last_message_timestamp: lastMessageTime ? new Date(lastMessageTime).getTime() : 0,
                            last_message_time: lastMessageTime ? 
                                new Date(lastMessageTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : ''
                        };
                    });

                    // Sort contacts by last message timestamp
                    processedContacts.sort((a, b) => b.last_message_timestamp - a.last_message_timestamp);

                    // Create contact elements
                    processedContacts.forEach(contact => {
                        const contactElement = createContactElement([contact.id, contact.username], {
                            id: contact.id,
                            username: contact.username,
                            last_message: contact.last_message,
                            last_message_time: contact.last_message_time,
                            last_message_timestamp: contact.last_message_timestamp
                        });
                        contactList.appendChild(contactElement);
                    });

                    // Load last active chat
                    const lastChat = getLastActiveChat();
                    if (lastChat) {
                        const contact = processedContacts.find(c => c.id === lastChat.id);
                        if (contact) {
                            startChatWithContact(contact.id, contact.username);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading contacts:', error);
                    const contactList = document.querySelector('.contact-list');
                    contactList.innerHTML = `
                        <div class="no-contacts">
                            <p>Error loading contacts</p>
                            <p>Please try again later</p>
                        </div>
                    `;
                });
        }

        function createContactElement(contact, userDetail = null) {
            const contactId = contact[0];
            const contactElement = document.createElement('div');
            contactElement.className = 'contact';
            contactElement.setAttribute('data-contact-id', contactId);
            
            let displayName = userDetail?.username || contact[1] || 'Unknown User';
            let lastMessage = userDetail?.last_message || '';
            let lastMessageTime = userDetail?.last_message_time || '';
            
            // Use data URI for default avatar
            const defaultAvatar = '/Backend/static/images/contact_logo.png'';
            
            // Fix avatar path handling
            let profilePic;
            if (userDetail?.profile_picture) {
                profilePic = `/uploads/profile_photos/${userDetail.profile_picture}`;
            } else {
                profilePic = defaultAvatar;
            }

            contactElement.innerHTML = `
                <div class="profile-pic">
                    <img src="${profilePic}" alt="${displayName}" onerror="this.src='${defaultAvatar}'">
                </div>
                <div class="contact-info">
                    <div class="contact-name">${displayName}</div>
                    <div class="contact-message">${lastMessage}</div>
                </div>
                <div class="contact-meta">
                    <div class="message-time">${lastMessageTime}</div>
                </div>
            `;

            contactElement.onclick = () => startChatWithContact(contactId, displayName);
            return contactElement;
        }

        function filterContacts() {
            const searchInput = document.getElementById('contact-search');
            const filter = searchInput.value.toLowerCase();
            const contactItems = document.querySelectorAll('.contact-item');
            
            contactItems.forEach(item => {
                const name = item.querySelector('.contact-name').textContent.toLowerCase();
                if (name.includes(filter)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Modify the startChatWithContact function to include event listeners
        function startChatWithContact(contactId, displayName) {
            console.log('Starting chat with contact:', contactId, displayName);
            
            // Important: Completely reset the chat state first
            window.currentChat = null;
            
            // Leave any current chat room first
            if (window.currentChat) {
                if (window.currentChat.type === 'direct') {
                    socket.emit('leave', { room: window.currentChat.id });
                } else if (window.currentChat.type === 'group') {
                    socket.emit('leave', { room: `group_${window.currentChat.id}` });
                }
            }
            
            // Clear chat display
            const chatBody = document.querySelector('.chat-body');
            if (chatBody) {
                chatBody.innerHTML = '<div class="loading-message" style="align-self: center; padding: 10px;">Loading chat...</div>';
            }
            
            // Update current chat info with correct type
            window.currentChat = {
                id: Number(contactId),  // Ensure it's a number
                type: 'direct',
                name: displayName
            };
            
            console.log('Current chat set to:', window.currentChat);
            
            // Store the last active chat
            storeLastActiveChat(contactId, 'direct', displayName);
            
            // Update chat header
            const chatHeader = document.querySelector('.chat-header-info');
            if (chatHeader) {
                chatHeader.innerHTML = `
                    <div class="chat-header-name">${displayName}</div>
                    <div class="chat-header-status ${isUserOnline(contactId) ? 'online' : 'offline'}">${isUserOnline(contactId) ? 'online' : 'offline'}</div>
                `;
            }
            
            // Load chat messages
            loadChatMessages(contactId);
            
            // Show chat interface
            const chatInterface = document.querySelector('.chat-interface');
            if (chatInterface) {
                chatInterface.style.display = 'flex';
            }

            // Set up message input event listeners
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-message');

            if (messageInput) {
                // Remove existing listeners first to avoid duplicates
                messageInput.removeEventListener('keypress', handleEnterPress);
                // Add new listener
                messageInput.addEventListener('keypress', handleEnterPress);
                // Clear any existing message
                messageInput.value = '';
                // Update placeholder
                messageInput.placeholder = 'Type a message...';
            }

            if (sendButton) {
                // Remove existing listener first to avoid duplicates
                sendButton.removeEventListener('click', sendMessage);
                // Add new listener
                sendButton.addEventListener('click', sendMessage);
            }
            
            // Highlight the active contact in the list
            document.querySelectorAll('.contact').forEach(c => c.classList.remove('contact-active'));
            const contactElement = document.querySelector(`.contact[data-contact-id="${contactId}"]`);
            if (contactElement) {
                contactElement.classList.add('contact-active');
            }
        }

        // Helper function for Enter key press
        function handleEnterPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
        
        // Function to handle contact click
        function handleContactClick() {
            // Remove active class from all contacts
            document.querySelectorAll('.contact').forEach(c => c.classList.remove('contact-active'));
            // Add active class to clicked contact
            this.classList.add('contact-active');
            
            // Get contact details
            const contactName = this.querySelector('.contact-name').textContent;
            const contactId = this.getAttribute('data-user-id');
            
            console.log(`Loading chat with ${contactName}, ID: ${contactId}`);
            
            // Set the current chat info for message sending
            window.currentChat = {
                id: contactId,
                type: 'direct',
                name: contactName
            };
            
            // Update the chat header with the selected contact's info
            document.querySelector('.chat-header-name').textContent = contactName;
            
            // Clear the current chat
            const chatBody = document.querySelector('.chat-body');
            chatBody.innerHTML = '';
            
            // Show loading indicator
            const loadingElement = document.createElement('div');
            loadingElement.className = 'message';
            loadingElement.style.alignSelf = 'center';
            loadingElement.textContent = 'Loading messages...';
            chatBody.appendChild(loadingElement);
            
            // Fetch messages for this contact from the backend
            fetch(`/chat/get_messages/${contactId}`)
                .then(response => response.json())
                .then(messages => {
                    // Remove loading indicator
                    chatBody.innerHTML = '';
                    
                    // If no messages, show a welcome message
                    if (messages.length === 0) {
                        const welcomeElement = document.createElement('div');
                        welcomeElement.className = 'message';
                        welcomeElement.style.alignSelf = 'center';
                        welcomeElement.style.backgroundColor = '#202c33';
                        welcomeElement.style.padding = '10px 15px';
                        welcomeElement.style.borderRadius = '8px';
                        welcomeElement.style.color = '#e9edef';
                        welcomeElement.textContent = `Start chatting with ${contactName}`;
                        chatBody.appendChild(welcomeElement);
                    } else {
                        // Add messages to the chat
                        messages.forEach(msg => {
                            const [senderId, receiverId, msgContent, timestamp] = msg;
                            
                            // Check if this is a sent or received message
                            const isSent = senderId.toString() === document.documentElement.getAttribute('data-user-id');
                            
                            // Create message element
                            const messageElement = document.createElement('div');
                            messageElement.className = isSent ? 'message sent' : 'message received';
                            messageElement.innerHTML = `
                                <div class="message-content">${msgContent}</div>
                                <span class="message-timestamp">${new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                            `;
                            
                            chatBody.appendChild(messageElement);
                        });
                    }
                    
                    // Scroll to bottom
                    chatBody.scrollTop = chatBody.scrollHeight;
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                    chatBody.innerHTML = '';
                    
                    const errorElement = document.createElement('div');
                    errorElement.className = 'message';
                    errorElement.style.alignSelf = 'center';
                    errorElement.style.backgroundColor = '#8B0000';
                    errorElement.style.padding = '10px 15px';
                    errorElement.style.borderRadius = '8px';
                    errorElement.style.color = '#ffffff';
                    errorElement.textContent = 'Error loading messages. Please try again.';
                    chatBody.appendChild(errorElement);
                });
        }
        
        // Function to search contacts
        function searchContacts() {
            const searchInput = document.getElementById('search-input');
            const filter = searchInput.value.toLowerCase();
            const contacts = document.querySelectorAll('.contact');
            
            contacts.forEach(contact => {
                const name = contact.querySelector('.contact-name').textContent.toLowerCase();
                if (name.includes(filter)) {
                    contact.style.display = '';
                } else {
                    contact.style.display = 'none';
                }
            });
            
            // Show no results message if all contacts are hidden
            const visibleContacts = Array.from(contacts).filter(c => c.style.display !== 'none');
            const contactList = document.getElementById('contact-list');
            const noResultsMsg = contactList.querySelector('.no-results');
            
            if (visibleContacts.length === 0 && filter) {
                if (!noResultsMsg) {
                    const noResults = document.createElement('div');
                    noResults.className = 'no-results';
                    noResults.style.color = '#8696a0';
                    noResults.style.textAlign = 'center';
                    noResults.style.padding = '20px';
                    noResults.textContent = `No contacts found for "${filter}"`;
                    contactList.appendChild(noResults);
                }
            } else if (noResultsMsg) {
                noResultsMsg.remove();
            }
        }
        
        // Function to send a message
        function sendMessage() {
            const messageInput = document.querySelector('.message-input');
            if (!messageInput) {
                console.error('Message input not found');
                return;
            }

            const message = messageInput.value.trim();
            
            if (!message || !window.currentChat) {
                if (!window.currentChat) {
                    showNotification('Please select a contact or group first', 'error');
                }
                return;
            }

            // Generate a unique message ID
            const messageId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const timestamp = Date.now();
            const time = new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            // Add message to UI immediately
            const chatBody = document.querySelector('.chat-body');
            if (!chatBody) {
                console.error('Chat body not found');
                return;
            }

            const messageElement = document.createElement('div');
            messageElement.className = 'message sent';
            messageElement.setAttribute('data-message-id', messageId); // Add message ID attribute
            messageElement.innerHTML = `
                <div class="message-content">${message}</div>
                <span class="message-timestamp">${time}</span>
            `;
            chatBody.appendChild(messageElement);
            chatBody.scrollTop = chatBody.scrollHeight;

            // Clear input
            messageInput.value = '';

            console.log("Sending message in chat type:", window.currentChat.type);
            console.log("Current chat ID:", window.currentChat.id);
            console.log("Current chat name:", window.currentChat.name);

            // Debug extra information
            console.log("Full current chat object:", JSON.stringify(window.currentChat));

            // Handle based on chat type
            if (window.currentChat.type === 'direct') {
                console.log("Sending direct message to user ID:", window.currentChat.id);
                
                // Update contact's last message in the database for direct messages
            fetch('/chat/update_last_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contact_id: window.currentChat.id,
                    message: message,
                    timestamp: timestamp
                })
            });

                // Emit direct message
            socket.emit('send_message', {
                receiver_id: window.currentChat.id,
                message: message,
                timestamp: timestamp,
                message_id: messageId
            });
            } else if (window.currentChat.type === 'group') {
                console.log("Sending group message to group ID:", window.currentChat.id);
                
                // Emit group message with the correct group_id parameter
                socket.emit('send_message', {
                    group_id: window.currentChat.id,
                message: message,
                timestamp: timestamp,
                message_id: messageId
            });
            }
        }

        // Attach event listeners when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Send message on Enter key
            const messageInput = document.querySelector('.message-input');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault(); // Prevent default to avoid newline
                        sendMessage();
                    }
                });
            }

            // Send message on button click
            const sendButton = document.querySelector('.send-button');
            if (sendButton) {
                sendButton.addEventListener('click', sendMessage);
            }
        });
        
        // Bottom navigation functionality
        const navIcons = document.querySelectorAll('.nav-icon');
        navIcons.forEach(icon => {
            icon.addEventListener('click', function() {
                const target = this.getAttribute('data-target');
                const settingsSidebar = document.querySelector('.settings-sidebar');
                const mainSidebarContent = document.querySelector('.sidebar-content');

                // Remove active class from all nav icons
                navIcons.forEach(i => i.classList.remove('active'));
                // Add active class to clicked icon
                this.classList.add('active');
                
                // --- Start Fix: Hide settings sidebar if visible when switching views ---
                if (settingsSidebar && settingsSidebar.style.display !== 'none') {
                    settingsSidebar.style.display = 'none';
                }
                // --- End Fix ---

                // Ensure main content area is visible for contacts/groups
                if (mainSidebarContent && (target === 'contacts' || target === 'groups')) {
                    mainSidebarContent.style.display = 'flex'; // Or 'block' if that was the default
                }
                
                console.log(`Switching to ${target} view`);
                
                // Handle specific targets
                if (target === 'add') {
                    // Show main content for add contact view
                    if (mainSidebarContent) {
                        mainSidebarContent.style.display = 'flex';
                        mainSidebarContent.style.flexDirection = 'column';
                    }
                    showAddContactModal();
                } else if (target === 'contacts') {
                    showMainSidebar(); // Use showMainSidebar to rebuild the contacts view
                } else if (target === 'groups') {
                    showGroupsView();
                } else if (target === 'settings') {
                    // showSettingsSidebar handles hiding main content
                    showSettingsSidebar();
                }
            });
        });
        
        // Function to show settings sidebar
        function showSettingsSidebar() {
            const settingsSidebar = document.querySelector('.settings-sidebar');
            if (!settingsSidebar) {
                console.error('Settings sidebar element not found');
                return;
            }
            
            // Hide main sidebar content but keep navigation
            const sidebarContent = document.querySelector('.sidebar-content');
            if (sidebarContent) {
                sidebarContent.style.display = "none";
            }
            
            // Show settings sidebar
            settingsSidebar.style.display = "flex";
            
            // Make sure navigation stays visible
            const sidebarNav = document.querySelector('.sidebar-nav');
            if (sidebarNav) {
                sidebarNav.style.display = "flex";
                // Set settings icon as active
                document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
                document.querySelector('.nav-icon[data-target="settings"]').classList.add('active');
            }
            
            // Add event listeners
            const backButton = settingsSidebar.querySelector('.sidebar-header-back');
            const closeButton = settingsSidebar.querySelector('.close-settings');
            const languageSettings = settingsSidebar.querySelector('#language-settings');
            const passwordSettings = settingsSidebar.querySelector('#password-settings');
            const adminPanel = settingsSidebar.querySelector('#admin-panel');
            
            if (backButton) {
                backButton.addEventListener("click", () => {
                    settingsSidebar.style.display = "none";
                    showMainSidebar();
                });
            }
            
            if (closeButton) {
                closeButton.addEventListener("click", () => {
                    settingsSidebar.style.display = "none";
                    showMainSidebar();
                });
            }
            
            if (languageSettings) {
                languageSettings.addEventListener("click", showLanguageSettings);
            }
            
            if (passwordSettings) {
                passwordSettings.addEventListener("click", showPasswordSettings);
            }
            
            if (adminPanel) {
                adminPanel.addEventListener("click", () => {
                    loadAdminPanel();
                });
            }
        }
        
        // Function to show the add contact modal
        function showAddContactModal() {
            // Get the sidebar content
            const sidebarContent = document.querySelector('.sidebar-content');
            
            if (!sidebarContent) {
                console.error('Sidebar content not found');
                return;
            }
            
            // Make sure the sidebar content is visible and flex column
            sidebarContent.style.display = 'flex';
            sidebarContent.style.flexDirection = 'column';
            sidebarContent.style.height = '100%'; // Ensure full height
            
            // Save the current sidebar content (to restore on back button)
            // We need to capture this *before* overwriting innerHTML
            const originalContentState = sidebarContent.innerHTML;
            window.originalSidebarState = originalContentState; // Store globally or pass if needed
            
            // Create and show the add contact interface in the sidebar
            sidebarContent.innerHTML = `
                <div class="sidebar-header">
                    <div style="display: flex; align-items: center;">
                        <div id="back-to-contacts" style="margin-right: 15px; cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 11H7.83l4.88-4.88c.39-.39.39-1.03 0-1.42-.39-.39-1.02-.39-1.41 0l-6.59 6.59c-.39.39-.39 1.02 0 1.41l6.59 6.59c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L7.83 13H19c.55 0 1-.45 1-1s-.45-1-1-1z"></path>
                            </svg>
                        </div>
                        <div class="app-name">Add New Contact</div>
                    </div>
                </div>
                
                <div style="padding: 10px 15px; background-color: #111b21; border-bottom: 1px solid #222d34;">
                        <div style="display: flex;">
                        <input type="text" id="search-user" style="flex: 1; padding: 10px; background-color: #2a3942; border: none; color: #e9edef; border-radius: 5px 0 0 5px;" placeholder="Search by Username or Email">
                        <button id="search-user-btn" style="padding: 0 15px; background-color: #2a3942; color: #8696a0; border: none; border-left: 1px solid #111b21; border-radius: 0 5px 5px 0; cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="20" height="20">
                                    <path fill="currentColor" d="M15.009 13.805h-.636l-.22-.219a5.184 5.184 0 0 0 1.256-3.386 5.207 5.207 0 1 0-5.207 5.208 5.183 5.183 0 0 0 3.385-1.255l.221.22v.635l4.004 3.999 1.194-1.195-3.997-4.007zm-4.808 0a3.605 3.605 0 1 1 0-7.21 3.605 3.605 0 0 1 0 7.21z"></path>
                                </svg>
                            </button>
                    </div>
                </div>
                
                <div id="all-users-list" style="overflow-y: auto; flex: 1; background-color: #111b21;">
                    <!-- User list will be loaded here -->
                    <div class="loading-users" style="text-align: center; color: #8696a0; padding: 20px;">
                        Loading users...
                    </div>
                </div>

                <div class="add-contact-footer">
                    <button id="add-selected-contact-btn" disabled>Add Selected Contact</button>
                </div>
            `;
            
            // Add event listeners
            document.getElementById('back-to-contacts').addEventListener('click', function() {
                // Restore original sidebar content using the stored state
                if (window.originalSidebarState) {
                    sidebarContent.innerHTML = window.originalSidebarState;
                    // Ensure display is correct after restoring
                    sidebarContent.style.display = 'flex'; 
                    sidebarContent.style.flexDirection = 'column';
                    // Reattach necessary listeners for the main view
                    reattachContactEventListeners(); // Make sure this function exists and works
                    loadContacts(); // Reload contacts/chats
                } else {
                    // Fallback if state wasn't saved
                    showMainSidebar(); 
                }
                
                // Set contacts tab as active
                document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
                const contactsIcon = document.querySelector('.nav-icon[data-target="contacts"]');
                if (contactsIcon) contactsIcon.classList.add('active');
            });
            
            document.getElementById('search-user-btn').addEventListener('click', function() {
                const searchTerm = document.getElementById('search-user').value.trim();
                // Trigger search even if empty to potentially show all users again
                    searchUsers(searchTerm);
            });
            
            document.getElementById('search-user').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('search-user-btn').click();
                }
            });

            // Add listener for the new bottom button
            document.getElementById('add-selected-contact-btn').addEventListener('click', function() {
                const usersListContainer = document.getElementById('all-users-list');
                const selectedUserId = usersListContainer.getAttribute('data-selected-user-id');
                
                if (selectedUserId) {
                    // --- Check if contact already exists --- 
                    let contactExists = false;
                    if (window.userContacts && Array.isArray(window.userContacts)) {
                        // Assuming window.userContacts is an array of arrays like [[id, name], ...]
                        // Or it might be an array of objects {id: ..., name: ...} - check loadContacts implementation
                        // Let's check based on the structure from loadContacts: [[id, name], ...]
                         contactExists = window.userContacts.some(contact => contact[0] == selectedUserId);
                         // If structure is {id: ..., ...}, use: window.userContacts.some(contact => contact.id == selectedUserId);
                    }
                    
                    if (contactExists) {
                        showNotification('This user is already in your contacts.', 'warning');
                        return; // Stop execution
                    }
                    // --- End check --- 

                    if (confirm('Add this user to your contacts?')) {
                        addContact(selectedUserId); 
                        // addContact handles success/error and navigation
                    }
                } else {
                    showNotification('Please select a user from the list first.', 'warning');
                }
            });

            // Load all users immediately
            loadAllUsers(); 
        }
        
        // Function to load all users (excluding self) into the add contact list
        function loadAllUsers() {
            const usersListContainer = document.getElementById('all-users-list');
            if (!usersListContainer) return; // Exit if container not found
            
            usersListContainer.innerHTML = '<div class="loading-users" style="text-align: center; color: #e9edef; padding: 20px;">Loading users...</div>';
            // Reset selection state
            usersListContainer.removeAttribute('data-selected-user-id');
            document.getElementById('add-selected-contact-btn').disabled = true;
            
            fetch('/chat/user_info') // Endpoint that gets all users except current
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(users => {
                    renderUserList(users, usersListContainer);
                })
                .catch(error => {
                    console.error('Error loading all users:', error);
                    usersListContainer.innerHTML = '<div style="text-align: center; color: #ff6b6b; padding: 20px;">Error loading users. Please try again.</div>';
                });
        }

        // Function to render a list of users (used by loadAllUsers and searchUsers)
        function renderUserList(users, container) {
            container.innerHTML = ''; // Clear previous content or loading message
            
            if (!users || users.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #8696a0; padding: 20px;">No users found.</div>';
                // Ensure button is disabled if no users
                container.removeAttribute('data-selected-user-id');
                const addButton = document.getElementById('add-selected-contact-btn');
                if (addButton) addButton.disabled = true;
                        return;
                    }
                    
                    users.forEach(user => {
                // Skip if user object is somehow invalid
                if (!user || !user.id || !user.username) return;

                        const userElement = document.createElement('div');
                userElement.className = 'user-item'; // Add a class for styling and selection
                userElement.setAttribute('data-user-id', user.id);
                        userElement.style.padding = '10px 15px';
                        userElement.style.display = 'flex';
                        userElement.style.alignItems = 'center';
                userElement.style.justifyContent = 'space-between'; // Keep space for potential future icons
                        userElement.style.borderBottom = '1px solid #222d34';
                        userElement.style.cursor = 'pointer';
                        
                        // Highlight on hover
                        userElement.addEventListener('mouseover', function() {
                    // Don't change background if it's selected
                    if (!this.classList.contains('user-selected')) {
                            this.style.backgroundColor = '#202c33';
                    }
                        });
                        userElement.addEventListener('mouseout', function() {
                     // Don't change background if it's selected
                    if (!this.classList.contains('user-selected')) {
                            this.style.backgroundColor = 'transparent';
                    }
                        });
                        
                        const profilePic = user.profile_picture 
                            ? `/uploads/profile_photos/${user.profile_picture}` 
                    : '/api/placeholder/40/40'; // Use placeholder API
                            
                        userElement.innerHTML = `
                            <div style="display: flex; align-items: center;">
                                <div style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden; margin-right: 10px;">
                                    <img src="${profilePic}" alt="${user.username}" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <div>
                                    <div style="color: #e9edef; font-weight: bold;">${user.username}</div>
                            <div style="color: #8696a0; font-size: 12px;">${user.email || user.name || ''}</div>
                                </div>
                            </div>
                    <!-- Removed individual add button -->
                `;
                
                // Add click listener for selection
                userElement.addEventListener('click', function() {
                    const clickedUserId = this.getAttribute('data-user-id');
                    const allUserItems = container.querySelectorAll('.user-item');
                    const addButton = document.getElementById('add-selected-contact-btn');
                    
                    // Deselect if clicking the already selected user
                    if (this.classList.contains('user-selected')) {
                        this.classList.remove('user-selected');
                        this.style.backgroundColor = 'transparent'; // Remove selected background
                        container.removeAttribute('data-selected-user-id');
                        if (addButton) addButton.disabled = true;
                    } else {
                        // Remove selection from others
                        allUserItems.forEach(item => {
                            item.classList.remove('user-selected');
                            item.style.backgroundColor = 'transparent'; // Reset background for all
                        });
                        
                        // Select the clicked one
                        this.classList.add('user-selected');
                        this.style.backgroundColor = '#2a3942'; // Set selected background
                        container.setAttribute('data-selected-user-id', clickedUserId);
                        if (addButton) addButton.disabled = false;
                    }
                });
                
                container.appendChild(userElement);
            });
        }

        // Function to search for users (MODIFIED)
        function searchUsers(searchTerm) {
            const resultsContainer = document.getElementById('all-users-list'); // Target the same list container
            if (!resultsContainer) return;

            // If search term is empty, load all users instead
            if (!searchTerm || searchTerm.trim() === '') {
                loadAllUsers();
                return;
            }

            resultsContainer.innerHTML = '<div style="text-align: center; color: #e9edef; padding: 20px;">Searching...</div>';
            // Reset selection state during search
            resultsContainer.removeAttribute('data-selected-user-id');
            const addButton = document.getElementById('add-selected-contact-btn');
             if (addButton) addButton.disabled = true;
            
            fetch(`/chat/search_users?term=${encodeURIComponent(searchTerm)}`)
                .then(response => {
                     if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json()
                })
                .then(users => {
                    // Use the common render function
                    renderUserList(users, resultsContainer);
                })
                .catch(error => {
                    console.error('Error searching users:', error);
                    resultsContainer.innerHTML = '<div style="text-align: center; color: #ff6b6b; padding: 20px;">Error searching users</div>';
                });
        }
        
        // Function to add a contact
        function addContact(contactId) {
            fetch('/chat/add_contact', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ contact_id: contactId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === "Contact added") {
                    // Show success message
                    showNotification('Contact added successfully', 'success');
                    
                    // Reload contacts to show the new contact
                    if (document.querySelector('.nav-icon[data-target="contacts"]').classList.contains('active')) {
                        loadContacts();
                    }
                    
                    // Return to contacts view
                    const backButton = document.getElementById('back-to-contacts');
                    if (backButton) {
                        backButton.click();
                    }
                } else {
                    showNotification('Failed to add contact: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error adding contact:', error);
                showNotification('Failed to add contact. Please try again.', 'error');
            });
        }
        
        // Function to reattach event listeners to contacts after sidebar content is restored
        function reattachContactEventListeners() {
            // Reattach event listeners to search box
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('keyup', searchContacts);
            }
            
            // Reattach event listeners to contacts
            document.querySelectorAll('.contact').forEach(contact => {
                contact.addEventListener('click', handleContactClick);
            });
        }
        
        // Function to show notification
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'notification-toast';
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.right = '20px';
            
            // Set color based on notification type
            let backgroundColor;
            switch(type) {
                case 'success':
                    backgroundColor = '#00a884';
                    break;
                case 'error':
                    backgroundColor = '#f15c6d';
                    break;
                case 'warning':
                    backgroundColor = '#ffa000';
                    break;
                default: // info
                    backgroundColor = '#005c4b';
            }
            
            notification.style.backgroundColor = backgroundColor;
            notification.style.color = 'white';
            notification.style.padding = '12px 20px';
            notification.style.borderRadius = '8px';
            notification.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
            notification.style.zIndex = '9999';
            notification.style.maxWidth = '300px';
            notification.style.wordBreak = 'break-word';
            notification.innerText = message;
            
            // Add to document
            document.body.appendChild(notification);
            
            // Remove after 5 seconds
            setTimeout(function() {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s ease';
                setTimeout(function() {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 500);
            }, 5000);
        }
        
        // Function to show groups view
        function showGroupsView() {
            // Get the sidebar content
            const sidebarContent = document.querySelector('.sidebar-content');
            
            // Save the current sidebar content
            const originalContent = sidebarContent.innerHTML;
            
            // Update sidebar content with groups view
            sidebarContent.innerHTML = `
                <div class="sidebar-header">
                    <div class="app-name">Groups</div>
                    <div class="sidebar-header-icons">
                        <div id="create-group-button" style="cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="search-container">
                    <div class="search-bar">
                        <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                            <path fill="currentColor" d="M15.009 13.805h-.636l-.22-.219a5.184 5.184 0 0 0 1.256-3.386 5.207 5.207 0 1 0-5.207 5.208 5.183 5.183 0 0 0 3.385-1.255l.221.22v.635l4.004 3.999 1.194-1.195-3.997-4.007zm-4.808 0a3.605 3.605 0 1 1 0-7.21 3.605 3.605 0 0 1 0 7.21z"></path>
                        </svg>
                        <input type="text" id="group-search-input" placeholder="Search groups" onkeyup="searchGroups()">
                    </div>
                </div>
                
                <div id="groups-list" class="contact-list">
                    <div class="loading-groups" style="color: #8696a0; text-align: center; padding: 20px;">
                        Loading groups...
                    </div>
                </div>
            `;
            
            // Add event listener for creating new group
            document.getElementById('create-group-button').addEventListener('click', showCreateGroupView);
            
            // Load the user's groups
            loadGroups();
        }
        
        // Function to show create group view
        function showCreateGroupView() {
            // Get the sidebar content
            const sidebarContent = document.querySelector('.sidebar-content');
            
            // Save the current sidebar content
            const originalContent = sidebarContent.innerHTML;
            
            // Create and show the create group interface in the sidebar
            sidebarContent.innerHTML = `
                <div class="sidebar-header">
                    <div style="display: flex; align-items: center;">
                        <div id="back-to-groups" style="margin-right: 15px; cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 11H7.83l4.88-4.88c.39-.39.39-1.03 0-1.42-.39-.39-1.02-.39-1.41 0l-6.59 6.59c-.39.39-.39 1.02 0 1.41l6.59 6.59c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L7.83 13H19c.55 0 1-.45 1-1s-.45-1-1-1z"></path>
                            </svg>
                        </div>
                        <div class="app-name">Create New Group</div>
                    </div>
                </div>
                
                <div style="padding: 15px; background-color: #111b21;">
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="group-name" style="display: block; color: #e9edef; margin-bottom: 5px;">Group Name</label>
                        <input type="text" id="group-name" style="width: 100%; padding: 10px; background-color: #2a3942; border: none; color: #e9edef; border-radius: 5px;" placeholder="Enter group name">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; color: #e9edef; margin-bottom: 5px;">Group Avatar</label>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div id="group-avatar-preview" style="width: 80px; height: 80px; border-radius: 50%; overflow: hidden; background-color: #2a3942; display: flex; justify-content: center; align-items: center;">
                                <svg viewBox="0 0 24 24" width="40" height="40" style="color: #8696a0;">
                                    <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"></path>
                                </svg>
                            </div>
                            <div style="flex: 1;">
                                <input type="file" id="group-avatar-input" accept="image/*" style="display: none;">
                                <button type="button" id="upload-avatar-btn" style="padding: 8px 15px; background-color: #2a3942; color: #e9edef; border: 1px solid #8696a0; border-radius: 5px; cursor: pointer; font-size: 14px;">
                                    Upload Avatar
                                </button>
                                <div style="color: #8696a0; font-size: 12px; margin-top: 5px;">
                                    Recommended size: 200x200 pixels
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="group-description" style="display: block; color: #e9edef; margin-bottom: 5px;">Group Description (Optional)</label>
                        <textarea id="group-description" style="width: 100%; height: 80px; padding: 10px; background-color: #2a3942; border: none; color: #e9edef; border-radius: 5px; resize: none;" placeholder="Enter group description"></textarea>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; color: #e9edef; margin-bottom: 5px;">Select Members</label>
                        <div style="display: flex;">
                            <input type="text" id="search-members" style="flex: 1; padding: 10px; background-color: #2a3942; border: none; color: #e9edef; border-radius: 5px;" placeholder="Search contacts">
                        </div>
                    </div>
                </div>
                
                <div style="padding: 10px 15px; background-color: #111b21; border-bottom: 1px solid #222d34;">
                    <div style="color: #e9edef; font-size: 14px; margin-bottom: 5px;">Selected Contacts (<span id="selected-count">0</span>)</div>
                    <div id="selected-members" style="display: flex; flex-wrap: wrap; gap: 5px;"></div>
                </div>
                
                <div id="contact-selection-list" style="overflow-y: auto; flex: 1; background-color: #111b21;">
                    <div style="text-align: center; color: #8696a0; padding: 20px;">
                        Loading contacts...
                    </div>
                </div>
                
                <div style="padding: 15px; background-color: #111b21; border-top: 1px solid #222d34;">
                    <button id="create-group-btn" style="width: 100%; padding: 12px; background-color: #00a884; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; opacity: 0.5;" disabled>
                        Create Group
                    </button>
                </div>
            `;
            
            // Add event listener to back button
            document.getElementById('back-to-groups').addEventListener('click', function() {
                // Restore original sidebar content
                sidebarContent.innerHTML = originalContent;
                
                // Reattach event listener to create group button
                document.getElementById('create-group-button').addEventListener('click', showCreateGroupView);
                
                // Load the groups
                loadGroups();
            });
            
            // Add event listeners for avatar upload
            const avatarInput = document.getElementById('group-avatar-input');
            const uploadButton = document.getElementById('upload-avatar-btn');
            const avatarPreview = document.getElementById('group-avatar-preview');
            
            uploadButton.addEventListener('click', function() {
                avatarInput.click();
            });
            
            avatarInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Check if file is an image
                    if (!file.type.startsWith('image/')) {
                        showNotification('Please select an image file', 'error');
                        return;
                    }
                    
                    // Check file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        showNotification('Image size should be less than 5MB', 'error');
                        return;
                    }
                    
                    // Create preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        avatarPreview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Add event listener for group name input
            const groupNameInput = document.getElementById('group-name');
            groupNameInput.addEventListener('input', function() {
                updateCreateGroupButton();
            });
            
            // Add event listener for create group button
            const createGroupBtn = document.getElementById('create-group-btn');
            createGroupBtn.addEventListener('click', function(e) {
                e.preventDefault();
                createNewGroup();
            });
            
            // Load contacts for selection
            loadContactsForGroupCreation();
        }
        
        // Function to load contacts for group creation
        function loadContactsForGroupCreation() {
            const contactsList = document.getElementById('contact-selection-list');
            
            fetch('/chat/contacts')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load contacts');
                    }
                    return response.json();
                })
                .then(contacts => {
                    contactsList.innerHTML = '';
                    
                    if (contacts.length === 0) {
                        contactsList.innerHTML = '<div style="text-align: center; color: #8696a0; padding: 20px;">No contacts found. Add contacts first to create a group.</div>';
                        return;
                    }
                    
                    // Create contact elements for selection
                    contacts.forEach(contact => {
                        let contactId, contactName, profilePic;
                        
                        // Handle different contact data formats
                        if (Array.isArray(contact)) {
                            contactId = contact[0];
                            contactName = contact[1];
                            profilePic = `/api/placeholder/49/49`; // Default placeholder
                        } else {
                            contactId = contact.id;
                            contactName = contact.username || contact.name;
                            profilePic = contact.profile_picture ? `/uploads/profile_pics/${contact.profile_picture}` : `/api/placeholder/49/49`;
                        }
                        
                        const contactElement = document.createElement('div');
                        contactElement.className = 'contact-selection-item';
                        contactElement.setAttribute('data-contact-id', contactId);
                        contactElement.setAttribute('data-contact-name', contactName);
                        
                        // Check if this contact is already selected
                        const isSelected = selectedMembers.has(contactId);
                        
                        contactElement.innerHTML = `
                            <div style="display: flex; align-items: center; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #222d34; transition: background-color 0.2s;">
                                <div style="width: 45px; height: 45px; border-radius: 50%; margin-right: 15px; overflow: hidden;">
                                    <img src="${profilePic}" alt="${contactName}" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                                <div style="flex: 1;">
                                    <div style="color: #e9edef; font-size: 16px;">${contactName}</div>
                                </div>
                                <div class="contact-checkbox" style="width: 24px; height: 24px; border: 2px solid ${isSelected ? '#00a884' : '#8696a0'}; border-radius: 50%; display: flex; justify-content: center; align-items: center;">
                                    <svg viewBox="0 0 24 24" width="18" height="18" style="display: ${isSelected ? 'block' : 'none'};">
                                    <path fill="#00a884" d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"></path>
                                </svg>
                                </div>
                            </div>
                        `;
                        
                        contactElement.addEventListener('click', function() {
                            const contactId = this.getAttribute('data-contact-id');
                            const contactName = this.getAttribute('data-contact-name');
                            const checkbox = this.querySelector('.contact-checkbox');
                            const checkmark = checkbox.querySelector('svg');
                            
                            if (selectedMembers.has(contactId)) {
                                removeSelectedMember(contactId);
                                checkbox.style.borderColor = '#8696a0';
                                checkmark.style.display = 'none';
                            } else {
                                addSelectedMember(contactId, contactName, profilePic);
                                checkbox.style.borderColor = '#00a884';
                                checkmark.style.display = 'block';
                            }
                            
                            // Update the Next button state
                            updateNextButton();
                        });
                        
                        contactsList.appendChild(contactElement);
                    });
                })
                .catch(error => {
                    console.error('Error loading contacts:', error);
                    contactsList.innerHTML = '<div style="text-align: center; color: #ff6b6b; padding: 20px;">Failed to load contacts. Please try again.</div>';
                });
        }
        
        // Selected members for group creation
        const selectedMembers = new Map();
        
        // Function to add a selected member
        function addSelectedMember(id, name, profilePic) {
            selectedMembers.set(id, { id, name, profilePic });
        }
        
        // Function to remove a selected member
        function removeSelectedMember(id) {
            selectedMembers.delete(id);
        }
        
        // Function to filter contacts for group creation
        function filterContactsForGroupCreation(searchTerm) {
            const contacts = document.querySelectorAll('.contact-selection-item');
            
            contacts.forEach(contact => {
                const name = contact.getAttribute('data-contact-name').toLowerCase();
                if (name.includes(searchTerm)) {
                    contact.style.display = '';
                } else {
                    contact.style.display = 'none';
                }
            });
        }
        
        // Function to update create group button state
        function updateCreateGroupButton() {
            const createButton = document.getElementById('create-group-btn');
            const groupName = document.getElementById('group-name').value.trim();
            
            // Enable button if there's a group name and at least 2 members selected
            if (groupName && selectedMembers.size >= 2) {
                createButton.style.opacity = '1';
                createButton.disabled = false;
            } else {
                createButton.style.opacity = '0.5';
                createButton.disabled = true;
            }
        }
        
        // Add event listener to group name input
        document.addEventListener('input', function(e) {
            if (e.target && e.target.id === 'group-name') {
                updateCreateGroupButton();
            }
        });
        
        // Function to create a new group
        function createNewGroup() {
            const groupName = document.getElementById('group-name').value.trim();
            const groupDescription = document.getElementById('group-description').value.trim();
            const avatarFile = document.getElementById('group-avatar-input').files[0];
            
            // Validate inputs
            if (!groupName) {
                showNotification('Please enter a group name', 'error');
                return;
            }
            
            if (selectedMembers.size < 2) {
                showNotification('Please select at least 2 contacts', 'error');
                return;
            }
            
            // Disable button and show loading state
            const createButton = document.getElementById('create-group-btn');
            const originalButtonText = createButton.textContent;
            createButton.disabled = true;
            createButton.textContent = 'Creating...';
            
            // Prepare member IDs
            const memberIds = Array.from(selectedMembers.keys());
            
            // Create FormData for file upload
            const formData = new FormData();
            formData.append('group_name', groupName);
            formData.append('description', groupDescription);
            
            // Add each member ID separately instead of as JSON string
            memberIds.forEach(id => {
                formData.append('member_ids', id);
            });
            
            if (avatarFile) {
                formData.append('group_picture', avatarFile);
            }
            
            // Send request to create group
            fetch('/chat/create_group', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === "Group created successfully") {
                    showNotification('Group created successfully', 'success');
                    
                    // Reset selectedMembers for next time
                    selectedMembers.clear();
                    
                    // Go back to groups view
                    if (window.originalSidebarState) {
                        const sidebarContent = document.querySelector('.sidebar-content');
                        sidebarContent.innerHTML = window.originalSidebarState;
                    }
                    
                    // Set groups tab as active and load groups
                    document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
                    document.querySelector('.nav-icon[data-target="groups"]').classList.add('active');
                    showGroupsView();
                } else {
                    showNotification('Failed to create group: ' + data.message, 'error');
                    // Reset button
                    createButton.disabled = false;
                    createButton.textContent = originalButtonText;
                }
            })
            .catch(error => {
                console.error('Error creating group:', error);
                showNotification('Failed to create group. Please try again.', 'error');
                
                // Reset button
                createButton.disabled = false;
                createButton.textContent = originalButtonText;
            });
        }
        
        // Function to load the user's groups
        function loadGroups() {
            const groupsList = document.getElementById('groups-list');
            
            fetch('/chat/groups')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load groups');
                    }
                    return response.json();
                })
                .then(groups => {
                    groupsList.innerHTML = '';
                    
                    if (groups.length === 0) {
                        groupsList.innerHTML = '<div class="no-groups" style="color: #8696a0; text-align: center; padding: 20px;">No groups found. Create a new group to get started.</div>';
                        return;
                    }
                    
                    // Create group elements
                    groups.forEach((group, index) => {
                        const groupElement = document.createElement('div');
                        groupElement.className = 'contact'; // Reusing contact class for styling
                        groupElement.setAttribute('data-group-id', group.id);
                        
                        // Get group profile picture if available
                        const profilePic = group.picture 
                            ? `/uploads/group_images/${group.picture}` 
                            : '/api/placeholder/49/49';
                        
                        groupElement.innerHTML = `
                            <div class="profile-pic">
                                <img src="${profilePic}" alt="${group.name}">
                            </div>
                            <div class="contact-info">
                                <div class="contact-name">${group.name}</div>
                                <div class="contact-message">${group.member_count} members</div>
                            </div>
                            <div class="contact-meta">
                                ${group.is_admin ? '<div class="admin-badge" style="color: #00a884; font-size: 12px;">Admin</div>' : ''}
                            </div>
                        `;
                        
                        // Add click event to load group chat
                        groupElement.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // Remove active class from all contacts
                            document.querySelectorAll('.contact').forEach(c => c.classList.remove('contact-active'));
                            // Add active class to this group
                            this.classList.add('contact-active');
                            
                            const groupId = this.getAttribute('data-group-id');
                            console.log('Group clicked - loading group chat with ID:', groupId);
                            
                            // Stop any ongoing processes
                            if (window.loadingChatPromise) {
                                window.loadingChatPromise.cancel = true;
                            }
                            
                            // Load the group chat with a new promise
                            loadGroupChat(groupId);
                        });
                        
                        groupsList.appendChild(groupElement);
                    });
                })
                .catch(error => {
                    console.error('Error loading groups:', error);
                    groupsList.innerHTML = '<div class="error-message" style="color: #ff6b6b; text-align: center; padding: 20px;">Failed to load groups. Please refresh and try again.</div>';
                });
        }
        
        // Function to search groups
        function searchGroups() {
            const searchInput = document.getElementById('group-search-input');
            const filter = searchInput.value.toLowerCase();
            const groups = document.querySelectorAll('#groups-list .contact');
            
            groups.forEach(group => {
                const name = group.querySelector('.contact-name').textContent.toLowerCase();
                if (name.includes(filter)) {
                    group.style.display = '';
                } else {
                    group.style.display = 'none';
                }
            });
            
            // Show no results message if all groups are hidden
            const visibleGroups = Array.from(groups).filter(g => g.style.display !== 'none');
            const groupsList = document.getElementById('groups-list');
            const noResultsMsg = groupsList.querySelector('.no-results');
            
            if (visibleGroups.length === 0 && filter) {
                if (!noResultsMsg) {
                    const noResults = document.createElement('div');
                    noResults.className = 'no-results';
                    noResults.style.color = '#8696a0';
                    noResults.style.textAlign = 'center';
                    noResults.style.padding = '20px';
                    noResults.textContent = `No groups found for "${filter}"`;
                    groupsList.appendChild(noResults);
                }
            } else if (noResultsMsg) {
                noResultsMsg.remove();
            }
        }
        
        // Function to load a group chat
        function loadGroupChat(groupId) {
            console.log('Loading group chat with ID:', groupId);
            
            // Important: Completely reset any ongoing chat first
            window.currentChat = null;
            
            // Leave any current chat room first
            if (window.currentChat) {
                if (window.currentChat.type === 'direct') {
                    socket.emit('leave', { room: window.currentChat.id });
                } else if (window.currentChat.type === 'group') {
                    socket.emit('leave', { room: `group_${window.currentChat.id}` });
                }
            }
            
            // Clear chat display
            const chatBody = document.querySelector('.chat-body');
            if (chatBody) {
                chatBody.innerHTML = '<div class="loading-message" style="align-self: center; padding: 10px;">Loading group chat...</div>';
            }
            
            // First, get the group info
            fetch(`/chat/group/${groupId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load group info');
                    }
                    return response.json();
                })
                .then(group => {
                    console.log('Group info loaded:', group);
                    
                    // IMPORTANT: Force set the chat type to group right here
                    window.currentChat = {
                        id: Number(groupId),  // Ensure it's a number
                        type: 'group',
                        name: group.name,
                        entity: group
                    };
                    
                    console.log('Current chat set to:', window.currentChat);
                    
                    // Store the last active chat
                    storeLastActiveChat(groupId, 'group', group.name);
                    
                    // Update the chat header with group info
                    updateChatHeader(group, true);
                    
                    // Join the group's Socket.IO room
                    const roomName = `group_${groupId}`;
                    console.log('Joining room:', roomName);
                    socket.emit('join', { room: roomName });
                    
                    // Load group messages
                    loadGroupMessages(groupId);
                    
                    // Show chat interface
                    const chatInterface = document.querySelector('.chat-interface');
                    if (chatInterface) {
                        chatInterface.style.display = 'flex';
                    }
                    
                    // Set up message input event listeners
                    const messageInput = document.getElementById('message-input');
                    const sendButton = document.getElementById('send-message');
                    
                    if (messageInput) {
                        // Remove existing listeners first to avoid duplicates
                        messageInput.removeEventListener('keypress', handleEnterPress);
                        // Add new listener
                        messageInput.addEventListener('keypress', handleEnterPress);
                        // Clear any existing message
                        messageInput.value = '';
                        // Update placeholder
                        messageInput.placeholder = 'Type a message to the group...';
                    }
                    
                    if (sendButton) {
                        // Remove existing listener first to avoid duplicates
                        sendButton.removeEventListener('click', sendMessage);
                        // Add new listener
                        sendButton.addEventListener('click', sendMessage);
                    }
                    
                    // Highlight the active group in the list
                    document.querySelectorAll('.contact').forEach(c => c.classList.remove('contact-active'));
                    const groupElement = document.querySelector(`.contact[data-group-id="${groupId}"]`);
                    if (groupElement) {
                        groupElement.classList.add('contact-active');
                    }
                })
                .catch(error => {
                    console.error('Error loading group info:', error);
                    showNotification('Failed to load group chat', 'error');
                });
        }
        
        // Function to update the chat header with contact or group info
        function updateChatHeader(entity, isGroup = false) {
            const chatHeader = document.querySelector('.chat-header');
            
            console.log("Updating chat header for:", isGroup ? "group" : "direct chat", entity);
            
            // Store entity for later reference
            window.currentChat = {
                id: Number(entity.id),  // Ensure it's a number
                type: isGroup ? 'group' : 'direct',
                name: isGroup ? entity.name : entity.username,
                entity: entity // Store the full entity for info panel
            };
            
            console.log("Current chat updated to:", window.currentChat);
            
            // Get profile picture
            const profilePic = isGroup
                ? (entity.picture ? `/uploads/group_images/${entity.picture}` : '/api/placeholder/49/49')
                : (entity.profile_picture ? `/uploads/profile_photos/${entity.profile_picture}` : '/api/placeholder/49/49');
            
            // Update header content
            chatHeader.innerHTML = `
                <div class="profile-pic" style="cursor: pointer;">
                    <img src="${profilePic}" alt="${isGroup ? entity.name : entity.username}">
                </div>
                <div class="chat-header-info" style="cursor: pointer;">
                    <div class="chat-header-name">${isGroup ? entity.name : entity.username}</div>
                    <div class="chat-header-status ${isUserOnline(entity.id) ? 'online' : 'offline'}">${isGroup ? (entity.member_count + ' members') : (isUserOnline(entity.id) ? 'online' : 'offline')}</div>
                </div>
                <div class="chat-header-icons">
                    <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                        <path fill="currentColor" d="M15.9 14.3H15l-.3-.3c1-1.1 1.6-2.7 1.6-4.3 0-3.7-3-6.7-6.7-6.7S3 6 3 9.7s3 6.7 6.7 6.7c1.6 0 3.2-.6 4.3-1.6l.3.3v.8l5.1 5.1 1.5-1.5-5-5.2zm-6.2 0c-2.6 0-4.6-2.1-4.6-4.6s2.1-4.6 4.6-4.6 4.6 2.1 4.6 4.6-2 4.6-4.6 4.6z"></path>
                    </svg>
                    <div class="info-button" style="cursor: pointer;">
                        <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                            <path fill="currentColor" d="M12 7a2 2 0 1 0-.001-4.001A2 2 0 0 0 12 7zm0 2a2 2 0 1 0-.001 3.999A2 2 0 0 0 12 9zm0 6a2 2 0 1 0-.001 3.999A2 2 0 0 0 12 15z"></path>
                        </svg>
                    </div>
                </div>
            `;
            
            // Add event listener for profile click (both image and name/status area)
            const profileElements = [
                chatHeader.querySelector('.profile-pic'), 
                chatHeader.querySelector('.chat-header-info')
            ];
            
            profileElements.forEach(element => {
                element.addEventListener('click', function() {
                    if (isGroup) {
                        showGroupInfo(entity);
                    } else {
                        showContactInfo(entity);
                    }
                });
            });
            
            // Add event listener for info button
            chatHeader.querySelector('.info-button').addEventListener('click', function() {
                if (isGroup) {
                    showGroupInfo(entity);
                } else {
                    showContactInfo(entity);
                }
            });
        }
        
        // Function to load group messages
        function loadGroupMessages(groupId) {
            const chatBody = document.querySelector('.chat-body');
            chatBody.innerHTML = '';
            
            // Show loading indicator
            const loadingElement = document.createElement('div');
            loadingElement.className = 'message';
            loadingElement.style.alignSelf = 'center';
            loadingElement.textContent = 'Loading messages...';
            chatBody.appendChild(loadingElement);
            
            // Fetch messages for this group
            fetch(`/chat/get_group_messages/${groupId}`)
                .then(response => response.json())
                .then(messages => {
                    // Remove loading indicator
                    chatBody.innerHTML = '';
                    
                    if (messages.length === 0) {
                        const welcomeElement = document.createElement('div');
                        welcomeElement.className = 'message';
                        welcomeElement.style.alignSelf = 'center';
                        welcomeElement.style.backgroundColor = '#202c33';
                        welcomeElement.style.padding = '10px 15px';
                        welcomeElement.style.borderRadius = '8px';
                        welcomeElement.style.color = '#e9edef';
                        welcomeElement.textContent = `No messages yet in this group. Be the first to say hello!`;
                        chatBody.appendChild(welcomeElement);
                    } else {
                        // Add messages to the chat
                        messages.forEach(msg => {
                            // In group messages, we now get [sender_id, sender_username, message, time]
                            const [senderId, senderUsername, msgContent, timestamp] = msg;
                            
                            // Generate a stable message ID based on content and timestamp
                            const messageId = `history_${senderId}_${timestamp.replace(/[^0-9]/g, '')}_${msgContent.substring(0, 10).replace(/\s/g, '')}`;
                            
                            // Check if this is a sent or received message
                            const isSent = senderId.toString() === document.documentElement.getAttribute('data-user-id');
                            
                            // Create message element
                            const messageElement = document.createElement('div');
                            messageElement.className = isSent ? 'message sent' : 'message received';
                            messageElement.setAttribute('data-message-id', messageId);
                            
                            // For received messages in groups, show sender name
                            let senderNameDiv = '';
                            if (!isSent) {
                                senderNameDiv = `<div class="message-sender" style="font-size: 12px; color: #00a884; margin-bottom: 2px;">${senderUsername}</div>`;
                            }
                            
                            messageElement.innerHTML = `
                                ${senderNameDiv}
                                <div class="message-content">${msgContent}</div>
                                <span class="message-timestamp">${timestamp}</span>
                            `;
                            
                            chatBody.appendChild(messageElement);
                        });
                    }
                    
                    // Scroll to bottom
                    chatBody.scrollTop = chatBody.scrollHeight;
                    
                    // Update the message input placeholder
                    document.querySelector('.message-input').placeholder = 'Type a message to the group...';
                })
                .catch(error => {
                    console.error('Error loading group messages:', error);
                    chatBody.innerHTML = '';
                    
                    const errorElement = document.createElement('div');
                    errorElement.className = 'message';
                    errorElement.style.alignSelf = 'center';
                    errorElement.style.backgroundColor = '#8B0000';
                    errorElement.style.padding = '10px 15px';
                    errorElement.style.borderRadius = '8px';
                    errorElement.style.color = '#ffffff';
                    errorElement.textContent = 'Error loading messages. Please try again.';
                    chatBody.appendChild(errorElement);
                });
        }
        
        // Function to show group info
        function showGroupInfo(group) {
            // Create a modal to display group info
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '1000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'flex-end'; // Align to right side
            modal.style.alignItems = 'stretch';
            
            // Group profile picture
            const profilePic = group.picture ? `/uploads/group_images/${group.picture}` : '/api/placeholder/80/80';
            
            // Create side panel
            const panel = document.createElement('div');
            panel.className = 'group-info-panel';
            panel.style.backgroundColor = '#1f2c33';
            panel.style.width = '350px';
            panel.style.maxWidth = '100%';
            panel.style.height = '100%';
            panel.style.overflowY = 'auto';
            panel.style.transition = 'transform 0.3s ease';
            panel.style.transform = 'translateX(100%)'; // Start offscreen
            panel.style.boxShadow = '-5px 0 15px rgba(0, 0, 0, 0.1)';
            
            // Check if user is admin
            const isAdmin = group.is_admin || group.admin_id === parseInt(document.documentElement.getAttribute('data-user-id'));
            
            panel.innerHTML = `
                <div style="display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #2a3942;">
                    <div id="close-group-info" style="cursor: pointer; margin-right: 15px;">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor" d="M19.8 11H7.5l5.6-5.6L11.7 4l-8 8 8 8 1.4-1.4L7.5 13h12.3v-2z"></path>
                        </svg>
                    </div>
                    <h2 style="color: #e9edef; margin: 0;">Group Info</h2>
                </div>
                
                <div style="padding: 20px; text-align: center; border-bottom: 1px solid #2a3942;">
                    <div style="width: 150px; height: 150px; border-radius: 75px; overflow: hidden; margin: 0 auto 15px;">
                        <img src="${profilePic}" alt="${group.name}" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <h2 style="color: #e9edef; margin-bottom: 5px;">${group.name}</h2>
                    <p style="color: #8696a0; margin-bottom: 0;">Group · ${group.member_count} members</p>
                </div>
                
                ${group.description ? `
                <div style="padding: 15px; border-bottom: 1px solid #2a3942;">
                    <h3 style="color: #e9edef; margin-bottom: 10px; font-size: 16px;">Description</h3>
                    <p style="color: #e9edef; margin: 0;">${group.description}</p>
                </div>
                ` : ''}
                
                ${isAdmin ? `
                <div style="padding: 15px; border-bottom: 1px solid #2a3942;">
                    <button id="add-members-btn" class="action-button" style="width: 100%; padding: 12px; background-color: #00a884; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                        Add Members
                    </button>
                </div>
                ` : ''}
                
                <div style="padding: 15px; border-bottom: 1px solid #2a3942;">
                    <h3 style="color: #e9edef; margin-bottom: 10px; font-size: 16px;">Members</h3>
                    <div id="group-members-list">
                        ${group.members.map(member => `
                            <div class="group-member" data-user-id="${member.id}" style="display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #2a3942; cursor: pointer;">
                                <div style="width: 40px; height: 40px; border-radius: 20px; overflow: hidden; margin-right: 15px;">
                                    <img src="${member.profile_picture ? `/uploads/profile_photos/${member.profile_picture}` : '/api/placeholder/40/40'}" alt="${member.username}" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <div style="flex: 1;">
                                    <div style="color: #e9edef;">${member.username}</div>
                                    ${member.is_admin ? `<div style="color: #00a884; font-size: 12px;">Group Admin</div>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="padding: 15px;">
                    <button id="leave-group-btn" class="action-button" style="width: 100%; padding: 12px; background-color: #1f2c33; color: #f15c6d; border: 1px solid #2a3942; border-radius: 5px; cursor: pointer; font-size: 16px;">
                        Leave Group
                    </button>
                </div>
            `;
            
            modal.appendChild(panel);
            document.body.appendChild(modal);
            
            // Add a slight delay for animation effect
            setTimeout(() => {
                panel.style.transform = 'translateX(0)';
            }, 10);
            
            // Close panel when button is clicked
            document.getElementById('close-group-info').addEventListener('click', function() {
                panel.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(modal);
                }, 300);
            });
            
            // Close panel when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    panel.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        document.body.removeChild(modal);
                    }, 300);
                }
            });
            
            // Add click event to members to view their profile
            const memberElements = document.querySelectorAll('.group-member');
            memberElements.forEach(element => {
                element.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    const member = group.members.find(m => m.id == userId);
                    
                    if (member) {
                        // Close current panel first
                        panel.style.transform = 'translateX(100%)';
                        setTimeout(() => {
                            document.body.removeChild(modal);
                            // Show user profile
                            showContactInfo(member);
                        }, 300);
                    }
                });
            });
            
            // Handle leave group action
            document.getElementById('leave-group-btn').addEventListener('click', function() {
                if (confirm('Are you sure you want to leave this group?')) {
                    // You would implement the actual leave group functionality here
                    showNotification('This feature is not yet implemented', 'warning');
                }
            });
            
            // Add members functionality (if admin)
            const addMembersBtn = document.getElementById('add-members-btn');
            if (addMembersBtn) {
                addMembersBtn.addEventListener('click', function() {
                    // Close the current panel
                    panel.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        document.body.removeChild(modal);
                        // You would implement the add members functionality here
                        showAddGroupMembersView(group.id);
                    }, 300);
                });
            }
        }

        // Function to show contact info
        function showContactInfo(contact) {
            // If we only have the user ID, fetch the complete profile
            if (typeof contact === 'number' || (contact && !contact.username && contact.id)) {
                const userId = typeof contact === 'number' ? contact : contact.id;
                
                // Show loading indicator
                showNotification('Loading contact info...', 'info');
                
                // Fetch user details
                fetch(`/chat/user_info/${userId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to fetch user info');
                        }
                        return response.json();
                    })
                    .then(userData => {
                        // Hide notification
                        hideNotification();
                        // Show user profile with complete data
                        showContactInfo(userData);
                    })
                    .catch(error => {
                        console.error('Error fetching user info:', error);
                        showNotification('Failed to load contact info', 'error');
                    });
                return;
            }
            
            // Create a modal to display contact info
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '1000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'flex-end'; // Align to right side
            modal.style.alignItems = 'stretch';
            
            // Contact profile picture
            const profilePic = contact.profile_picture ? 
                `/uploads/profile_photos/${contact.profile_picture}` : 
                '/api/placeholder/80/80';
            
            // Create side panel
            const panel = document.createElement('div');
            panel.className = 'contact-info-panel';
            panel.style.backgroundColor = '#1f2c33';
            panel.style.width = '350px';
            panel.style.maxWidth = '100%';
            panel.style.height = '100%';
            panel.style.overflowY = 'auto';
            panel.style.transition = 'transform 0.3s ease';
            panel.style.transform = 'translateX(100%)'; // Start offscreen
            panel.style.boxShadow = '-5px 0 15px rgba(0, 0, 0, 0.1)';
            
            panel.innerHTML = `
                <div style="display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #2a3942;">
                    <div id="close-contact-info" style="cursor: pointer; margin-right: 15px;">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor" d="M19.8 11H7.5l5.6-5.6L11.7 4l-8 8 8 8 1.4-1.4L7.5 13h12.3v-2z"></path>
                        </svg>
                    </div>
                    <h2 style="color: #e9edef; margin: 0;">Contact Info</h2>
                </div>
                
                <div style="padding: 20px; text-align: center; border-bottom: 1px solid #2a3942;">
                    <div style="width: 150px; height: 150px; border-radius: 75px; overflow: hidden; margin: 0 auto 15px;">
                        <img src="${profilePic}" alt="${contact.name || contact.username}" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <h2 style="color: #e9edef; margin-bottom: 5px;">${contact.name || ''}</h2>
                    <p style="color: #8696a0; margin-bottom: 0;">@${contact.username}</p>
                </div>
                
                ${contact.info ? `
                <div style="padding: 15px; border-bottom: 1px solid #2a3942;">
                    <h3 style="color: #e9edef; margin-bottom: 10px; font-size: 16px;">Bio</h3>
                    <p style="color: #e9edef; margin: 0;">${contact.info}</p>
                </div>
                ` : ''}
                
                <div style="padding: 15px; border-bottom: 1px solid #2a3942;">
                    <h3 style="color: #e9edef; margin-bottom: 10px; font-size: 16px;">Media & Files</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                        <div style="color: #8696a0; text-align: center; padding: 10px;">
                            No media or files shared yet
                        </div>
                    </div>
                </div>
                
                <div style="padding: 15px;">
                    <button id="report-contact-btn" class="action-button" style="width: 100%; padding: 12px; background-color: #1f2c33; color: #f15c6d; border: 1px solid #2a3942; border-radius: 5px; cursor: pointer; font-size: 16px;">
                        Report Contact
                    </button>
                </div>
            `;
            
            modal.appendChild(panel);
            document.body.appendChild(modal);
            
            // Add a slight delay for animation effect
            setTimeout(() => {
                panel.style.transform = 'translateX(0)';
            }, 10);
            
            // Close panel when button is clicked
            document.getElementById('close-contact-info').addEventListener('click', function() {
                panel.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(modal);
                }, 300);
            });
            
            // Close panel when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    panel.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        document.body.removeChild(modal);
                    }, 300);
                }
            });
            
            // Handle report contact action
            document.getElementById('report-contact-btn').addEventListener('click', function() {
                if (confirm('Are you sure you want to report this contact?')) {
                    showNotification('Report feature is not yet implemented', 'warning');
                }
            });
        }

        // Function to show add members to group view
        function showAddGroupMembersView(groupId) {
            // This function would be similar to the contact selection in showCreateGroupView
            showNotification('Add members functionality is not yet implemented', 'warning');
        }

        // Function to show create group view - Step 1: Select contacts
        function showCreateGroupView() {
            // Get the sidebar content
            const sidebarContent = document.querySelector('.sidebar-content');
            
            // Save the current sidebar content
            const originalContent = sidebarContent.innerHTML;
            window.originalSidebarState = originalContent;
            
            // Clear selected members for a fresh start
            selectedMembers.clear();
            
            // Create and show the contact selection interface (Step 1)
            sidebarContent.innerHTML = `
                <div class="sidebar-header">
                    <div style="display: flex; align-items: center;">
                        <div id="back-to-groups" style="margin-right: 15px; cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 11H7.83l4.88-4.88c.39-.39.39-1.03 0-1.42-.39-.39-1.02-.39-1.41 0l-6.59 6.59c-.39.39-.39 1.02 0 1.41l6.59 6.59c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L7.83 13H19c.55 0 1-.45 1-1s-.45-1-1-1z"></path>
                            </svg>
                        </div>
                        <div class="app-name">Select Group Members</div>
                    </div>
                </div>
                
                <div style="padding: 10px 15px; background-color: #111b21; border-bottom: 1px solid #222d34;">
                    <div class="search-bar">
                        <svg viewBox="0 0 24 24" width="24" height="24" class="search-icon">
                            <path fill="currentColor" d="M15.009 13.805h-.636l-.22-.219a5.184 5.184 0 0 0 1.256-3.386 5.207 5.207 0 1 0-5.207 5.208 5.183 5.183 0 0 0 3.385-1.255l.221.22v.635l4.004 3.999 1.194-1.195-3.997-4.007zm-4.808 0a3.605 3.605 0 1 1 0-7.21 3.605 3.605 0 0 1 0 7.21z"></path>
                                </svg>
                        <input type="text" id="contact-selection-search" placeholder="Search contacts" onkeyup="filterContactsForGroupCreation(this.value.toLowerCase())">
                        </div>
                        </div>
                
                <div id="contact-selection-list" class="contact-list" style="overflow-y: auto; flex: 1;">
                    <div class="loading-contacts" style="color: #8696a0; text-align: center; padding: 20px;">
                        Loading contacts...
                </div>
                        </div>
                
                <div class="add-contact-footer">
                    <button id="next-to-group-details" disabled>Next</button>
                    </div>
            `;
            
            // Add event listener for back button
            document.getElementById('back-to-groups').addEventListener('click', function() {
                if (window.originalSidebarState) {
                    sidebarContent.innerHTML = window.originalSidebarState;
                } else {
                    showGroupsView();
                }
            });
            
            // Add event listener for next button
            document.getElementById('next-to-group-details').addEventListener('click', function() {
                if (selectedMembers.size >= 2) {
                    showGroupDetailsView();
                } else {
                    showNotification('Please select at least 2 contacts', 'warning');
                }
            });
            
            // Load contacts for selection
            loadContactsForGroupCreation();
        }
        
        // Function to show group details view - Step 2: Set group name and avatar
        function showGroupDetailsView() {
            // Get the sidebar content
            const sidebarContent = document.querySelector('.sidebar-content');
            
            // Create and show the group details interface (Step 2)
            sidebarContent.innerHTML = `
                <div class="sidebar-header">
                    <div style="display: flex; align-items: center;">
                        <div id="back-to-contact-selection" style="margin-right: 15px; cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 11H7.83l4.88-4.88c.39-.39.39-1.03 0-1.42-.39-.39-1.02-.39-1.41 0l-6.59 6.59c-.39.39-.39 1.02 0 1.41l6.59 6.59c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L7.83 13H19c.55 0 1-.45 1-1s-.45-1-1-1z"></path>
                            </svg>
                        </div>
                        <div class="app-name">Create New Group</div>
                    </div>
                </div>
                
                <div style="padding: 20px; overflow-y: auto; flex: 1;">
                    <div style="background-color: #202c33; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 20px;">
                            <div style="position: relative; width: 100px; height: 100px; margin-bottom: 10px;">
                                <img id="group-avatar-preview" src="/api/placeholder/100/100" alt="Group" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                                <div style="position: absolute; bottom: 0; right: 0; background-color: #00a884; width: 30px; height: 30px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer;">
                                    <svg viewBox="0 0 24 24" width="20" height="20">
                                        <path fill="white" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path>
                                    </svg>
                        </div>
                                <input type="file" id="group-avatar-input" style="display: none;" accept="image/*">
                        </div>
                            <div style="font-size: 14px; color: #8696a0; margin-bottom: 5px;">Click to upload group avatar</div>
                    </div>
                    
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 14px; color: #8696a0; margin-bottom: 5px;">Group Name (required)</div>
                            <input type="text" id="group-name" style="width: 100%; padding: 8px 12px; background-color: #2a3942; border: none; border-radius: 5px; color: #e9edef;" placeholder="Enter group name">
                    </div>
                    
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 14px; color: #8696a0; margin-bottom: 5px;">Group Description (optional)</div>
                            <textarea id="group-description" style="width: 100%; height: 80px; padding: 8px 12px; background-color: #2a3942; border: none; border-radius: 5px; color: #e9edef; resize: none;" placeholder="Enter group description"></textarea>
                        </div>
                    </div>
                    
                    <div style="background-color: #202c33; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 14px; color: #8696a0; margin-bottom: 10px;">Selected Members (${selectedMembers.size})</div>
                        <div id="selected-members-list" style="display: flex; flex-wrap: wrap; gap: 10px;">
                        </div>
                    </div>
                </div>
                
                <div class="add-contact-footer">
                    <button id="create-group-btn" disabled>Create Group</button>
                </div>
            `;
            
            // Add event listener for back button
            document.getElementById('back-to-contact-selection').addEventListener('click', function() {
                showCreateGroupView();
            });
            
            // Add event listener for create group button
            document.getElementById('create-group-btn').addEventListener('click', createNewGroup);
            
            // Add event listener for group name input
            document.getElementById('group-name').addEventListener('input', updateCreateGroupButton);
            
            // Add event listener for avatar upload
            const avatarPreview = document.getElementById('group-avatar-preview');
            const avatarInput = document.getElementById('group-avatar-input');
            
            avatarPreview.addEventListener('click', function() {
                avatarInput.click();
            });
            
            avatarInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        avatarPreview.src = e.target.result;
                    };
                    reader.readAsDataURL(this.files[0]);
                }
            });
            
            // Display selected members
            const selectedMembersList = document.getElementById('selected-members-list');
            selectedMembers.forEach((member, id) => {
                const memberElement = document.createElement('div');
                memberElement.style.display = 'flex';
                memberElement.style.alignItems = 'center';
                memberElement.style.backgroundColor = '#111b21';
                memberElement.style.padding = '5px 10px';
                memberElement.style.borderRadius = '16px';
                
                memberElement.innerHTML = `
                    <img src="${member.profilePic}" alt="${member.name}" style="width: 24px; height: 24px; border-radius: 50%; margin-right: 5px;">
                    <span style="color: #e9edef; font-size: 13px;">${member.name}</span>
                `;
                
                selectedMembersList.appendChild(memberElement);
            });
        }
        
        // Function to update create group button state
        function updateCreateGroupButton() {
            const createButton = document.getElementById('create-group-btn');
            const groupName = document.getElementById('group-name').value.trim();
            
            // Enable button if there's a group name and at least 2 members selected
            if (groupName && selectedMembers.size >= 2) {
                createButton.style.opacity = '1';
                createButton.disabled = false;
            } else {
                createButton.style.opacity = '0.5';
                createButton.disabled = true;
            }
        }
        
        // Function to update next button state in contact selection view
        function updateNextButton() {
            const nextButton = document.getElementById('next-to-group-details');
            if (!nextButton) return;
            
            // Enable button if at least 2 members selected
            if (selectedMembers.size >= 2) {
                nextButton.style.opacity = '1';
                nextButton.disabled = false;
            } else {
                nextButton.style.opacity = '0.5';
                nextButton.disabled = true;
            }
        }
        
        // Function to show member selection for new group
        function showGroupMemberSelection(groupName, groupDescription) {
            // Get the sidebar
            const sidebar = document.querySelector('.sidebar');
            
            // Create member selection view
            sidebar.innerHTML = `
                <div class="sidebar-header">
                    <div style="display: flex; align-items: center;">
                        <div id="back-to-group-info" style="margin-right: 15px; cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 15.5c-3.58 0-6.5-2.92-6.5-6.5S8.42 5.5 12 5.5s6.5 2.92 6.5 6.5-2.92 6.5-6.5 6.5zm0-12c-3.03 0-5.5 2.47-5.5 5.5s2.47 5.5 5.5 5.5 5.5-2.47 5.5-5.5-2.47-5.5-5.5-5.5z"></path>
                                <path fill="currentColor" d="M12 18.5c3.03 0 5.5-2.47 5.5-5.5S15.03 7.5 12 7.5 6.5 9.97 6.5 13s2.47 5.5 5.5 5.5zm0-10c2.48 0 4.5 2.02 4.5 4.5S14.48 17.5 12 17.5 7.5 15.48 7.5 13 9.52 8.5 12 8.5z"></path>
                            </svg>
                        </div>
                        <div id="close-auth-panel" style="cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div style="padding: 20px;">
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #e9edef; margin-bottom: 10px;">User Management</h3>
                        <button id="load-users-btn" style="padding: 10px; background-color: #00a884; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">Load All Users</button>
                        <div id="users-container" style="max-height: 300px; overflow-y: auto;">
                            <div style="text-align: center; color: #8696a0; padding: 20px;">
                                Click "Load All Users" to view all registered users
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #e9edef; margin-bottom: 10px;">System Statistics</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">
                            <div style="background-color: #2a3942; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #00a884; font-size: 24px; font-weight: bold;">12</div>
                                <div style="color: #e9edef;">Total Users</div>
                            </div>
                            
                            <div style="background-color: #2a3942; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #00a884; font-size: 24px; font-weight: bold;">42</div>
                                <div style="color: #e9edef;">Messages Today</div>
                            </div>
                            
                            <div style="background-color: #2a3942; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #00a884; font-size: 24px; font-weight: bold;">3</div>
                                <div style="color: #e9edef;">Groups Created</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            authModal.appendChild(authPanel);
            document.body.appendChild(authModal);
            
            // Add event listener to close button
            document.getElementById('close-auth-panel').addEventListener('click', function() {
                document.body.removeChild(authModal);
            });
            
            // Add event listener to return to contacts button
            document.getElementById('return-to-contacts-from-auth').addEventListener('click', function() {
                document.body.removeChild(authModal);
                
                // Hide settings sidebar
                document.querySelector('.settings-sidebar').style.display = 'none';
                
                // Show main sidebar
                document.querySelector('.sidebar').style.display = 'flex';
                
                // Set contacts tab as active
                document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
                document.querySelector('.nav-icon[data-target="contacts"]').classList.add('active');
            });
            
            // Add event listener to load users button
            document.getElementById('load-users-btn').addEventListener('click', function() {
                const usersContainer = document.getElementById('users-container');
                usersContainer.innerHTML = '<div style="text-align: center; color: #e9edef; padding: 20px;">Loading users...</div>';
                
                // Fetch all users
                fetch('/api/users')
                    .then(response => response.json())
                    .then(data => {
                        if (data.users && data.users.length > 0) {
                            usersContainer.innerHTML = `
                                <table style="width: 100%; border-collapse: collapse; color: #e9edef;">
                                    <thead>
                                        <tr>
                                            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #2a3942;">ID</th>
                                            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #2a3942;">Username</th>
                                            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #2a3942;">Email</th>
                                            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #2a3942;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.users.map(user => `
                                            <tr>
                                                <td style="padding: 8px; border-bottom: 1px solid #2a3942;">${user.id}</td>
                                                <td style="padding: 8px; border-bottom: 1px solid #2a3942;">${user.username}</td>
                                                <td style="padding: 8px; border-bottom: 1px solid #2a3942;">${user.email || 'N/A'}</td>
                                                <td style="padding: 8px; border-bottom: 1px solid #2a3942;">
                                                    <button class="edit-user-btn" data-user-id="${user.id}" style="background-color: #00a884; color: white; border: none; border-radius: 3px; padding: 3px 8px; cursor: pointer; margin-right: 5px;">Edit</button>
                                                    <button class="delete-user-btn" data-user-id="${user.id}" style="background-color: #f15c6d; color: white; border: none; border-radius: 3px; padding: 3px 8px; cursor: pointer;">Delete</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            `;
                            
                            // Add event listeners to action buttons
                            document.querySelectorAll('.edit-user-btn').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const userId = this.getAttribute('data-user-id');
                                    showNotification(`Edit user functionality for user ${userId} is not implemented yet`, 'warning');
                                });
                            });
                            
                            document.querySelectorAll('.delete-user-btn').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const userId = this.getAttribute('data-user-id');
                                    if (confirm(`Are you sure you want to delete user with ID ${userId}?`)) {
                                        showNotification(`Delete user functionality for user ${userId} is not implemented yet`, 'warning');
                                    }
                                });
                            });
                        } else {
                            usersContainer.innerHTML = '<div style="text-align: center; color: #e9edef; padding: 20px;">No users found</div>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading users:', error);
                        usersContainer.innerHTML = '<div style="text-align: center; color: #ff6b6b; padding: 20px;">Error loading users</div>';
                    });
            });
            
            // Close when clicked outside
            authModal.addEventListener('click', function(e) {
                if (e.target === authModal) {
                    document.body.removeChild(authModal);
                }
            });
        }

        // Function to show actual admin panel
        function showActualAdminPanel() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '1000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            
            const panel = document.createElement('div');
            panel.style.backgroundColor = '#1f2c33';
            panel.style.padding = '20px';
            panel.style.borderRadius = '8px';
            panel.style.width = '600px';
            panel.style.maxWidth = '90%';
            panel.style.maxHeight = '80vh';
            panel.style.overflowY = 'auto';
            
            panel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #e9edef; margin: 0;">Admin Panel - Users</h2>
                    <div class="close-button" style="cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                            </svg>
                        </div>
                    </div>
                <div class="user-list" style="display: flex; flex-direction: column; gap: 10px;">
                    Loading users...
                </div>
            `;
            
            modal.appendChild(panel);
            document.body.appendChild(modal);
            
            // Add close button event listener
            const closeButton = panel.querySelector('.close-button');
            closeButton.addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // Load users
                fetch('/api/users')
                    .then(response => response.json())
                    .then(data => {
                    const userList = panel.querySelector('.user-list');
                    userList.innerHTML = '';

                    data.users.forEach(user => {
                        const userCard = document.createElement('div');
                        userCard.style.backgroundColor = '#2a3942';
                        userCard.style.padding = '15px';
                        userCard.style.borderRadius = '8px';
                        userCard.style.cursor = 'pointer';
                        userCard.style.display = 'flex';
                        userCard.style.alignItems = 'center';
                        userCard.style.gap = '15px';

                        userCard.innerHTML = `
                            <div class="user-avatar" style="width: 50px; height: 50px; border-radius: 50%; overflow: hidden; background-color: #374045;">
                                <img src="/api/placeholder/50/50" alt="${user.username}" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                            <div style="flex: 1;">
                                <div style="color: #e9edef; font-weight: bold;">${user.username}</div>
                                <div style="color: #8696a0; font-size: 14px;">${user.email}</div>
                            </div>
                        `;

                        userCard.addEventListener('click', () => showUserDetailsModal(user.id));
                        userList.appendChild(userCard);
                    });
                    })
                    .catch(error => {
                        console.error('Error loading users:', error);
                    panel.querySelector('.user-list').innerHTML = 'Error loading users';
                });
        }

        function showUserDetailsModal(userId) {
            fetch(`/api/users/${userId}/details`)
                .then(response => response.json())
                .then(user => {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                    modal.style.zIndex = '1001';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            
            const panel = document.createElement('div');
            panel.style.backgroundColor = '#1f2c33';
                    panel.style.padding = '20px';
                    panel.style.borderRadius = '8px';
                    panel.style.width = '400px';
            panel.style.maxWidth = '90%';
            
            panel.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: #e9edef; margin: 0;">User Details</h2>
                            <div class="close-button" style="cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                            </svg>
                        </div>
                    </div>
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="width: 120px; height: 120px; border-radius: 50%; overflow: hidden; margin: 0 auto 15px;">
                                <img src="${user.profile_picture || '/api/placeholder/120/120'}" alt="${user.username}" 
                                     style="width: 100%; height: 100%; object-fit: cover;">
                </div>
                            <div style="color: #e9edef; font-size: 20px; font-weight: bold;">${user.username}</div>
                            <div style="color: #8696a0;">${user.name || 'No name set'}</div>
                    </div>
                        <div style="background-color: #2a3942; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="color: #8696a0; margin-bottom: 5px;">Bio</div>
                            <div style="color: #e9edef;">${user.bio || 'No bio set'}</div>
                </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                            <div style="background-color: #2a3942; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #8696a0;">Groups</div>
                                <div style="color: #e9edef; font-size: 18px;">${user.group_count || 0}</div>
                </div>
                            <div style="background-color: #2a3942; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #8696a0;">Complaints</div>
                                <div style="color: #e9edef; font-size: 18px;">${user.complaint_count || 0}</div>
                    </div>
                </div>
                        <div style="background-color: #2a3942; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="color: #8696a0;">Registration Date</div>
                            <div style="color: #e9edef;">${new Date(user.registration_date).toLocaleDateString()}</div>
                        </div>
                        <button onclick="deleteUser(${user.id})" 
                                style="width: 100%; padding: 12px; background-color: #dc3545; color: white; border: none; 
                                       border-radius: 8px; cursor: pointer; font-size: 16px;">
                            Delete Account
                        </button>
            `;
            
            modal.appendChild(panel);
            document.body.appendChild(modal);
            
                    // Add close button event listener
                    const closeButton = panel.querySelector('.close-button');
                    closeButton.addEventListener('click', () => {
                document.body.removeChild(modal);
            });
                })
                .catch(error => {
                    console.error('Error loading user details:', error);
                    showNotification('Error loading user details', 'error');
                });
        }

        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                fetch(`/api/users/${userId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    showNotification('User deleted successfully', 'success');
                    // Refresh admin panel
                    document.body.removeChild(document.querySelector('.modal'));
                    showActualAdminPanel();
                })
                .catch(error => {
                    console.error('Error deleting user:', error);
                    showNotification('Error deleting user', 'error');
                });
            }
        }

        // Function to show language settings
        function showLanguageSettings() {
            // Create a simple notification since this feature is not fully implemented
            showNotification('Language settings feature is coming soon!', 'info');
        }

        // Function to show password change settings
        function showPasswordSettings() {
            // Create a simple notification since this feature is not fully implemented
            showNotification('Password change feature is coming soon!', 'info');
        }

        function showMainSidebar() {
            // Set contacts tab as active
            document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
            document.querySelector('.nav-icon[data-target="contacts"]').classList.add('active');
            
            // Show contacts view
            const sidebarContent = document.querySelector('.sidebar-content');
            sidebarContent.style.display = "none";
            sidebarContent.innerHTML = `
                <div class="sidebar-header">
                    <div class="app-name">TogolohChat</div>
                    <div class="sidebar-header-icons">
                        <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                            <path fill="currentColor" d="M12 20.664a8.664 8.664 0 0 1-8.664-8.664A8.664 8.664 0 0 1 12 3.336a8.664 8.664 0 0 1 8.664 8.664A8.664 8.664 0 0 1 12 20.664zm0-17.328a8.664 8.664 0 0 0-8.664 8.664A8.664 8.664 0 0 0 12 20.664a8.664 8.664 0 0 0 8.664-8.664A8.664 8.664 0 0 0 12 3.336z"></path>
                            <path fill="currentColor" d="M12 14.504c-1.104 0-2-.896-2-2s.896-2 2-2 2 .896 2 2-.896 2-2 2zm0-5c-1.657 0-3 1.343-3 3s1.343 3 3 3 3-1.343 3-3-1.343-3-3-3z"></path>
                        </svg>
                    </div>
                </div>
                
                <div class="search-container">
                    <div class="search-bar">
                        <svg viewBox="0 0 24 24" width="24" height="24" class="icon">
                            <path fill="currentColor" d="M15.009 13.805h-.636l-.22-.219a5.184 5.184 0 0 0 1.256-3.386 5.207 5.207 0 1 0-5.207 5.208 5.183 5.183 0 0 0 3.385-1.255l.221.22v.635l4.004 3.999 1.194-1.195-3.997-4.007zm-4.808 0a3.605 3.605 0 1 1 0-7.21 3.605 3.605 0 0 1 0 7.21z"></path>
                        </svg>
                        <input type="text" id="search-input" placeholder="Іздеу же жаңы чат баштоо..." onkeyup="searchContacts()">
                    </div>
                </div>
                
                <div class="contact-list" id="contact-list">
                    <div class="loading-contacts" style="color: #8696a0; text-align: center; padding: 20px;">
                        Loading contacts...
                    </div>
                </div>
            `;
            sidebarContent.style.display = "block";
            
            // Reattach event listeners and load contacts
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('keyup', searchContacts);
            }
            
            // Refresh contacts
            loadContacts();
        }

        // Function to load and show admin panel
        function loadAdminPanel() {
            showAdminPasswordPrompt();
        }

        // Function to show admin password prompt
        function showAdminPasswordPrompt() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '1000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';

            const panel = document.createElement('div');
            panel.style.backgroundColor = '#1f2c33';
            panel.style.padding = '20px';
            panel.style.borderRadius = '8px';
            panel.style.width = '400px';
            panel.style.maxWidth = '90%';

            panel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #e9edef; margin: 0;">Admin Authentication</h2>
                    <div class="close-button" style="cursor: pointer;">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                        </svg>
                    </div>
                </div>
                <div style="color: #e9edef;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">Enter Admin Password</label>
                        <input type="password" id="admin-password" style="width: 100%; padding: 8px; background-color: #2a3942; color: #e9edef; border: 1px solid #374045; border-radius: 4px;">
                    </div>
                    <button id="verify-admin" style="width: 100%; padding: 10px; background-color: #00a884; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Verify
                    </button>
                </div>
            `;

            modal.appendChild(panel);
            document.body.appendChild(modal);

            // Add event listeners
            const closeButton = panel.querySelector('.close-button');
            const verifyButton = panel.querySelector('#verify-admin');
            const passwordInput = panel.querySelector('#admin-password');

            closeButton.addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            // Add enter key support
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    verifyPassword();
                }
            });

            verifyButton.addEventListener('click', verifyPassword);

            function verifyPassword() {
                const password = passwordInput.value;
                if (password === '1234') {
                    // Set session storage to indicate admin access
                    sessionStorage.setItem('adminAccess', 'true');
                    document.body.removeChild(modal);
                    showActualAdminPanel();
                } else {
                    showNotification('Incorrect admin password', 'error');
                }
            }
        }

        // Function to check if user has admin access
        function hasAdminAccess() {
            return sessionStorage.getItem('adminAccess') === 'true';
        }

        // Function to show actual admin panel with user list
        function showActualAdminPanel() {
            // Check if user has admin access
            if (!hasAdminAccess()) {
                showAdminPasswordPrompt();
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '1000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';

            const panel = document.createElement('div');
            panel.className = 'admin-panel';
            panel.style.backgroundColor = '#1f2c33';
            panel.style.width = '800px';
            panel.style.maxWidth = '90%';
            panel.style.maxHeight = '80vh';
            panel.style.overflowY = 'auto';
            panel.style.borderRadius = '8px';
            panel.style.display = 'flex';
            panel.style.flexDirection = 'column';

            // Initial panel content with loading state
            panel.innerHTML = `
                <div style="padding: 20px; border-bottom: 1px solid #374045;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #e9edef; margin: 0;">Admin Panel</h2>
                        <div class="close-button" style="cursor: pointer;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                            </svg>
                        </div>
                    </div>
                    <div style="position: relative;">
                        <input type="text" id="user-search" placeholder="Search users..." 
                            style="width: 100%; padding: 8px 32px 8px 8px; background-color: #2a3942; color: #e9edef; 
                            border: 1px solid #374045; border-radius: 4px; font-size: 14px;">
                        <svg viewBox="0 0 24 24" width="20" height="20" 
                            style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: #8696a0;">
                            <path fill="currentColor" d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path>
                        </svg>
                    </div>
                </div>
                <div id="users-stats" style="padding: 15px; border-bottom: 1px solid #374045; color: #e9edef;">
                    Loading user statistics...
                </div>
                <div id="users-list" style="padding: 15px;">
                    <div style="color: #e9edef; text-align: center;">
                        Loading users...
                    </div>
                </div>
            `;

            modal.appendChild(panel);
            document.body.appendChild(modal);

            // Add event listeners
            const closeButton = panel.querySelector('.close-button');
            const searchInput = panel.querySelector('#user-search');

            closeButton.addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            // Load and display users
            fetch('/api/users')
                .then(response => response.json())
                .then(data => {
                    const users = data.users;
                    const usersList = panel.querySelector('#users-list');
                    const usersStats = panel.querySelector('#users-stats');

                    // Update stats
                    usersStats.innerHTML = `
                        <div style="font-size: 16px;">
                            Total Users: <span style="color: #00a884; font-weight: bold;">${users.length}</span>
                        </div>
                    `;

                    // Render users list
                    usersList.innerHTML = users.map(user => `
                        <div class="user-item" data-user-id="${user.id}" style="display: flex; align-items: center; padding: 10px; background-color: #2a3942; margin-bottom: 8px; border-radius: 8px; cursor: pointer;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden; margin-right: 15px;">
                                <img src="${user.profile_picture || '/api/placeholder/40/40'}" alt="${user.username}" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <div style="flex: 1;">
                                <div style="color: #e9edef;">${user.username}</div>
                                <div style="color: #8696a0; font-size: 12px;">${user.email || 'No email'}</div>
                                </div>
                            </div>
                        `).join('');

                    // Add click event listeners to user items
                    const userItems = usersList.querySelectorAll('.user-item');
                    userItems.forEach(item => {
                        item.addEventListener('click', () => {
                            const userId = item.getAttribute('data-user-id');
                            showUserDetailsModal(userId);
                        });
                    });

                    // Add search functionality
                    if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                            userItems.forEach(item => {
                                const username = item.querySelector('div:nth-child(2) div:first-child').textContent.toLowerCase();
                                const email = item.querySelector('div:nth-child(2) div:last-child').textContent.toLowerCase();
                                if (username.includes(searchTerm) || email.includes(searchTerm)) {
                                    item.style.display = 'flex';
                                } else {
                                    item.style.display = 'none';
                                }
                            });
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading users:', error);
                    panel.querySelector('#users-list').innerHTML = `
                        <div style="color: #ff6b6b; text-align: center; padding: 20px;">
                            Error loading users. Please try again.
                        </div>
                    `;
                });
        }

        function showUserDetailsModal(userId) {
            // Check if user has admin access
            if (!hasAdminAccess()) {
                showAdminPasswordPrompt();
                return;
            }

            fetch(`/api/users/${userId}/details`)
                .then(response => response.json())
                .then(user => {
                    const modal = document.createElement('div');
                    modal.className = 'modal';
                    modal.style.position = 'fixed';
                    modal.style.top = '0';
                    modal.style.left = '0';
                    modal.style.width = '100%';
                    modal.style.height = '100%';
                    modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                    modal.style.zIndex = '1001';
                    modal.style.display = 'flex';
                    modal.style.justifyContent = 'center';
                    modal.style.alignItems = 'center';

                    const panel = document.createElement('div');
                    panel.style.backgroundColor = '#1f2c33';
                    panel.style.padding = '20px';
                    panel.style.borderRadius = '8px';
                    panel.style.width = '400px';
                    panel.style.maxWidth = '90%';

                    panel.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: #e9edef; margin: 0;">User Details</h2>
                            <div class="close-button" style="cursor: pointer;">
                                <svg viewBox="0 0 24 24" width="24" height="24">
                                    <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                                </svg>
                            </div>
                        </div>
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="width: 120px; height: 120px; border-radius: 50%; overflow: hidden; margin: 0 auto 15px;">
                                <img src="${user.profile_picture || '/api/placeholder/120/120'}" alt="${user.username}" 
                                     style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                            <div style="color: #e9edef; font-size: 20px; font-weight: bold;">${user.username}</div>
                            <div style="color: #8696a0;">${user.name || 'No name set'}</div>
                        </div>
                        <div style="background-color: #2a3942; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="color: #8696a0; margin-bottom: 5px;">Bio</div>
                            <div style="color: #e9edef;">${user.bio || 'No bio set'}</div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                            <div style="background-color: #2a3942; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #8696a0;">Groups</div>
                                <div style="color: #e9edef; font-size: 18px;">${user.group_count || 0}</div>
                            </div>
                            <div style="background-color: #2a3942; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #8696a0;">Complaints</div>
                                <div style="color: #e9edef; font-size: 18px;">${user.complaint_count || 0}</div>
                            </div>
                        </div>
                        <div style="background-color: #2a3942; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="color: #8696a0;">Registration Date</div>
                            <div style="color: #e9edef;">${new Date(user.registration_date).toLocaleDateString()}</div>
                        </div>
                        <button onclick="deleteUser(${user.id})" 
                                style="width: 100%; padding: 12px; background-color: #dc3545; color: white; border: none; 
                                       border-radius: 8px; cursor: pointer; font-size: 16px;">
                            Delete Account
                        </button>
                    `;

                    modal.appendChild(panel);
                    document.body.appendChild(modal);

                    // Add close button event listener
                    const closeButton = panel.querySelector('.close-button');
                    closeButton.addEventListener('click', () => {
                        document.body.removeChild(modal);
                    });

                    // Close when clicking outside
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            document.body.removeChild(modal);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading user details:', error);
                    showNotification('Error loading user details', 'error');
                });
        }

        // Function to show language settings modal
        function showLanguageSettings() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '1000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';

            const panel = document.createElement('div');
            panel.style.backgroundColor = '#1f2c33';
            panel.style.padding = '20px';
            panel.style.borderRadius = '8px';
            panel.style.width = '400px';
            panel.style.maxWidth = '90%';

            panel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #e9edef; margin: 0;">Language Settings</h2>
                    <div class="close-button" style="cursor: pointer;">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                        </svg>
                    </div>
                </div>
                <div style="color: #e9edef;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">Select Language</label>
                        <select id="language-select" style="width: 100%; padding: 8px; background-color: #2a3942; color: #e9edef; border: 1px solid #374045; border-radius: 4px;">
                            <option value="en">English</option>
                            <option value="ky">Кыргызча</option>
                            <option value="ru">Русский</option>
                        </select>
                    </div>
                    <button id="save-language" style="width: 100%; padding: 10px; background-color: #00a884; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Save Changes
                    </button>
                </div>
            `;

            modal.appendChild(panel);
            document.body.appendChild(modal);

            // Add event listeners
            const closeButton = panel.querySelector('.close-button');
            const saveButton = panel.querySelector('#save-language');

            closeButton.addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            saveButton.addEventListener('click', () => {
                const selectedLanguage = panel.querySelector('#language-select').value;
                // Here you would typically make an API call to save the language preference
                showNotification('Language preference saved!', 'success');
                document.body.removeChild(modal);
            });
        }

        // Function to show password change modal
        function showPasswordSettings() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '1000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';

            const panel = document.createElement('div');
            panel.style.backgroundColor = '#1f2c33';
            panel.style.padding = '20px';
            panel.style.borderRadius = '8px';
            panel.style.width = '400px';
            panel.style.maxWidth = '90%';

            panel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #e9edef; margin: 0;">Change Password</h2>
                    <div class="close-button" style="cursor: pointer;">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                        </svg>
                    </div>
                </div>
                <div style="color: #e9edef;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">Current Password</label>
                        <input type="password" id="current-password" style="width: 100%; padding: 8px; background-color: #2a3942; color: #e9edef; border: 1px solid #374045; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">New Password</label>
                        <input type="password" id="new-password" style="width: 100%; padding: 8px; background-color: #2a3942; color: #e9edef; border: 1px solid #374045; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">Confirm New Password</label>
                        <input type="password" id="confirm-password" style="width: 100%; padding: 8px; background-color: #2a3942; color: #e9edef; border: 1px solid #374045; border-radius: 4px;">
                    </div>
                    <button id="save-password" style="width: 100%; padding: 10px; background-color: #00a884; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Change Password
                    </button>
                </div>
            `;

            modal.appendChild(panel);
            document.body.appendChild(modal);

            // Add event listeners
            const closeButton = panel.querySelector('.close-button');
            const saveButton = panel.querySelector('#save-password');

            closeButton.addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            saveButton.addEventListener('click', () => {
                const currentPassword = panel.querySelector('#current-password').value;
                const newPassword = panel.querySelector('#new-password').value;
                const confirmPassword = panel.querySelector('#confirm-password').value;

                if (!currentPassword || !newPassword || !confirmPassword) {
                    showNotification('Please fill in all fields', 'error');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    showNotification('New passwords do not match', 'error');
                    return;
                }

                if (newPassword.length < 6) {
                    showNotification('New password must be at least 6 characters long', 'error');
                     return;
                }

                // Make API call to change password
                fetch('/api/change_password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        old_password: currentPassword,
                        new_password: newPassword
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.message || 'Failed to change password');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                        showNotification('Password changed successfully!', 'success');
                        document.body.removeChild(modal);
                })
                .catch(error => {
                    console.error('Error changing password:', error);
                    showNotification(error.message || 'Error changing password', 'error');
                });
            });
        }

        // Add this after the existing socket connection code but before other functions

        // Function to load chat messages for a contact
        function loadChatMessages(contactId) {
            const chatBody = document.querySelector('.chat-body');
            if (!chatBody) return;
            
            chatBody.innerHTML = '<div class="loading-messages">Loading messages...</div>';
            
            // Load existing messages
            fetch(`/chat/get_messages/${contactId}`)
                .then(response => response.json())
                .then(messages => {
                    chatBody.innerHTML = ''; // Clear loading message
                    
                    // Display each message
                    messages.forEach(msg => {
                        const [senderId, receiverId, messageText, timestamp] = msg;
                        const isSent = senderId == document.documentElement.getAttribute('data-user-id');
                        
                        // Generate a stable message ID based on content and timestamp
                        const messageId = `history_${senderId}_${receiverId}_${timestamp.replace(/[^0-9]/g, '')}_${messageText.substring(0, 10).replace(/\s/g, '')}`;
                        
                        const messageElement = document.createElement('div');
                        messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
                        messageElement.setAttribute('data-message-id', messageId);
                        messageElement.innerHTML = `
                            <div class="message-content">${messageText}</div>
                            <span class="message-timestamp">${formatTimestamp(timestamp)}</span>
                        `;
                        
                        chatBody.appendChild(messageElement);
                    });
                    
                    // Scroll to bottom
                    chatBody.scrollTop = chatBody.scrollHeight;
                    
                    // Update the message input placeholder for direct messages
                    document.querySelector('.message-input').placeholder = 'Type a message...';
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                    chatBody.innerHTML = '<div class="error-message">Failed to load messages</div>';
                });
        }

        // Function to format timestamp
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Handle receiving messages
        socket.on('new_message', function(data) {
            // Only show message if we're in the correct chat
            if (window.currentChat && (
                (data.sender_id == window.currentChat.id) || 
                (data.receiver_id == window.currentChat.id)
            )) {
                const chatBody = document.querySelector('.chat-body');
                const messageElement = document.createElement('div');
                messageElement.className = `message ${data.sender_id == document.documentElement.getAttribute('data-user-id') ? 'sent' : 'received'}`;
                messageElement.innerHTML = `
                    <div class="message-content">${data.message}</div>
                    <span class="message-timestamp">${formatTimestamp(new Date(data.timestamp))}</span>
                `;
                chatBody.appendChild(messageElement);
                chatBody.scrollTop = chatBody.scrollHeight;
                
                // Send read receipt
                socket.emit('update_message_status', {
                    message_id: data.message_id,
                    status: 'read',
                    chat_id: data.sender_id,
                    chat_type: 'direct'
                });
            } else {
                // Show notification for messages from other chats
                showNotification(`New message from ${data.sender_username}: ${data.message}`);
            }
        });

        // Add a map to track online users
        window.onlineUsers = new Set();
        
        // Function to update user status in chat header
        function updateUserStatus(userId, isOnline) {
            // Only update if we're in a direct chat with this user
            if (window.currentChat && 
                window.currentChat.type === 'direct' && 
                window.currentChat.id == userId) {
                
                const statusElement = document.querySelector('.chat-header-status');
                if (statusElement) {
                    statusElement.textContent = isOnline ? 'online' : 'offline';
                    statusElement.className = 'chat-header-status ' + (isOnline ? 'online' : 'offline');
                }
            }
        }

        
        

        // Function to check if a user is online
        function isUserOnline(userId) {
            return window.onlineUsers.has(userId);
        }

        // When connecting, request current online users
        socket.on('connect', function() {
            console.log('Connected to server');
            
            const htmlElement = document.documentElement;
            const isAuthenticated = htmlElement.getAttribute('data-authenticated') === 'true';
            
            if (isAuthenticated) {
                const userId = htmlElement.getAttribute('data-user-id');
                socket.emit('join', { room: userId });
                console.log('Joined personal room:', userId);
                
                // Request current online users
                socket.emit('request_online_users');
                
                // Setup socket listeners and load contacts
                setupSocketListeners();
                
            } else {
                console.log('Not authenticated, no room to join');
            }
        });

        // Function to store the last active chat
        function storeLastActiveChat(chatId, chatType, chatName) {
            localStorage.setItem('lastActiveChat', JSON.stringify({
                id: chatId,
                type: chatType,
                name: chatName,
                timestamp: new Date().getTime()
            }));
        }

        // Function to retrieve the last active chat
        function getLastActiveChat() {
            const lastChat = localStorage.getItem('lastActiveChat');
            if (lastChat) {
                return JSON.parse(lastChat);
            }
            return null;
        }

        // Function to load the last active chat
        function loadLastActiveChat() {
            const lastChat = getLastActiveChat();
            console.log('Loading last active chat:', lastChat);
            
            if (lastChat) {
                console.log('Last active chat type:', lastChat.type, 'id:', lastChat.id, 'name:', lastChat.name);
                
                // Clear any existing chat content first
                const chatBody = document.querySelector('.chat-body');
                if (chatBody) {
                    chatBody.innerHTML = '';
                }
                
                if (lastChat.type === 'direct') {
                    console.log('Starting direct chat with contact:', lastChat.id, lastChat.name);
                    startChatWithContact(lastChat.id, lastChat.name);
                } else if (lastChat.type === 'group') {
                    console.log('Loading group chat:', lastChat.id);
                    loadGroupChat(lastChat.id);
                }
            }
        }

        // Initialize the chat system
        document.addEventListener('DOMContentLoaded', function() {
            // Load the last active chat
            setTimeout(loadLastActiveChat, 500); // Add a small delay to ensure other elements are loaded
        });

        // ... existing code ...
        // Function to sort contacts by last message timestamp
        function sortContactsByTimestamp(contacts) {
            return contacts.sort((a, b) => {
                const timestampA = a.last_message_timestamp || 0;
                const timestampB = b.last_message_timestamp || 0;
                return timestampB - timestampA;
            });
        }

        // Function to render contacts with sorting
        function renderContacts(contacts) {
            const contactList = document.querySelector('.contact-list');
            if (!contactList) return;

            // Sort contacts by last message timestamp
            const sortedContacts = sortContactsByTimestamp(contacts);

            contactList.innerHTML = sortedContacts.map(contact => `
                <div class="contact" data-contact-id="${contact.id}" onclick="startChatWithContact(${contact.id}, '${contact.username}')">
                    <div class="profile-pic">
                        <img src="${contact.profile_pic || '/static/default_profile.png'}" alt="${contact.username}">
                    </div>
                    <div class="contact-info">
                        <div class="contact-name">${contact.username}</div>
                        <div class="contact-message">${contact.last_message || ''}</div>
                    </div>
                    <div class="contact-meta">
                        <div class="message-time">${contact.last_message_time || ''}</div>
                    </div>
                </div>
            `).join('');
        }

        // Function to update contact's last message timestamp
        function updateContactTimestamp(contactId, timestamp) {
            const contacts = window.contacts || [];
            const contactIndex = contacts.findIndex(c => c.id === contactId);
            
            if (contactIndex !== -1) {
                contacts[contactIndex].last_message_timestamp = timestamp;
                contacts[contactIndex].last_message_time = new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                window.contacts = contacts;
                renderContacts(contacts);
            }
        }

        // ... existing code ...
        // Function to update a contact's last message and timestamp
        function updateContactLastMessage(contactId, message, timestamp) {
            const contact = document.querySelector(`.contact[data-contact-id="${contactId}"]`);
            if (contact) {
                const messagePreview = contact.querySelector('.contact-message');
                const timeElement = contact.querySelector('.message-time');
                if (messagePreview) {
                    messagePreview.textContent = message;
                }
                if (timeElement) {
                    timeElement.textContent = new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }

                // Update the contact's timestamp in the global contacts array
                if (window.userContacts) {
                    const contactData = window.userContacts.find(c => c[0] == contactId);
                    if (contactData) {
                        contactData.last_message = message;
                        contactData.last_message_timestamp = timestamp;
                        contactData.last_message_time = new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }
                }

                // Move contact to top of list
                const contactList = contact.parentElement;
                contactList.insertBefore(contact, contactList.firstChild);
            }
        }

        // Update WebSocket event handlers
        socket.on('new_message', function(data) {
            console.log('Received new_message:', data);
            
            const currentChatId = window.currentChat?.id;
            const currentChatType = window.currentChat?.type;
            const isFromCurrentUser = data.sender_id == document.documentElement.getAttribute('data-user-id');
            const timestamp = data.timestamp || Date.now();
            const messageId = data.message_id || `msg_${timestamp}_${Math.random().toString(36).substring(2, 9)}`;
            
            // Check if this message already exists in the chat to prevent duplicates
            if (document.querySelector(`[data-message-id="${messageId}"]`)) {
                console.log('Preventing duplicate message:', messageId);
                return;
            }
            
            // Update contact list for the sender
            if (!isFromCurrentUser) {
                updateContactLastMessage(data.sender_id, data.message, timestamp);
            }
            
            // Handle message display in chat
            if (data.group_id) {
                console.log('Handling group message:', data.group_id, 'current chat:', currentChatId, currentChatType);
                
                if (currentChatType === 'group' && currentChatId == data.group_id) {
                    const chatBody = document.querySelector('.chat-body');
                    const messageElement = document.createElement('div');
                    messageElement.className = isFromCurrentUser ? 'message sent' : 'message received';
                    messageElement.setAttribute('data-message-id', messageId);
                        
                    const senderName = !isFromCurrentUser ? `<div class="message-sender" style="font-size: 12px; color: #00a884; margin-bottom: 2px;">${data.sender_username}</div>` : '';
                    
                    messageElement.innerHTML = `
                        ${senderName}
                        <div class="message-content">${data.message}</div>
                        <span class="message-timestamp">${new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    `;
                    
                    chatBody.appendChild(messageElement);
                    chatBody.scrollTop = chatBody.scrollHeight;
                } else {
                    showNotification(`New message in group: ${data.message}`);
                }
            } 
            // Handle direct messages
            else {
                if (currentChatType === 'direct' && (currentChatId == data.sender_id || currentChatId == data.receiver_id)) {
                    const chatBody = document.querySelector('.chat-body');
                    const messageElement = document.createElement('div');
                    messageElement.className = isFromCurrentUser ? 'message sent' : 'message received';
                    messageElement.setAttribute('data-message-id', messageId);
                    
                    messageElement.innerHTML = `
                        <div class="message-content">${data.message}</div>
                        <span class="message-timestamp">${new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    `;
                    
                    chatBody.appendChild(messageElement);
                    chatBody.scrollTop = chatBody.scrollHeight;
                    
                    // Send read receipt
                    socket.emit('update_message_status', {
                        message_id: data.message_id,
                        status: 'read',
                        chat_id: data.sender_id,
                        chat_type: 'direct'
                    });
                } else {
                    showNotification(`${data.sender_username}: ${data.message}`);
                }
            }
        });

        socket.on('message_sent', function(data) {
            console.log('Message sent confirmation:', data);
            const timestamp = data.timestamp || Date.now();
            
            // Update contact list for the receiver
            updateContactLastMessage(data.receiver_id, data.message, timestamp);
            
            // Store the last active chat
            storeLastActiveChat(data.receiver_id, 'direct', data.receiver_username);
        });

        // Function to create contact element (update the existing function)
        function createContactElement(contact, userDetail = null) {
            const contactId = contact[0];
            const contactElement = document.createElement('div');
            contactElement.className = 'contact';
            contactElement.setAttribute('data-contact-id', contactId);
            
            let displayName = userDetail?.username || contact[1] || 'Unknown User';
            let lastMessage = userDetail?.last_message || '';
            let lastMessageTime = userDetail?.last_message_time || '';
            
            // Use data URI for default avatar
            const defaultAvatar = '/Backend/static/images/contact_logo.png'';
            
            // Fix avatar path handling
            let profilePic;
            if (userDetail?.profile_picture) {
                profilePic = `/uploads/profile_photos/${userDetail.profile_picture}`;
            } else {
                profilePic = defaultAvatar;
            }

            contactElement.innerHTML = `
                <div class="profile-pic">
                    <img src="${profilePic}" alt="${displayName}" onerror="this.src='${defaultAvatar}'">
                </div>
                <div class="contact-info">
                    <div class="contact-name">${displayName}</div>
                    <div class="contact-message">${lastMessage}</div>
                </div>
                <div class="contact-meta">
                    <div class="message-time">${lastMessageTime}</div>
                </div>
            `;

            contactElement.onclick = () => startChatWithContact(contactId, displayName);
            return contactElement;
        }

        // Profile functionality
        function loadProfileData() {
            fetch('/api/user/profile')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('profile-nickname').textContent = data.username;
                    document.getElementById('profile-name-input').value = data.name || '';
                    document.getElementById('profile-bio-input').value = data.bio || '';
                    if (data.profile_picture) {
                        document.getElementById('profile-avatar-img').src = `/uploads/profile_photos/${data.profile_picture}`;
                    }
                })
                .catch(error => console.error('Error loading profile:', error));
        }

        // Handle profile name updates
        const nameInput = document.getElementById('profile-name-input');
        let nameTimeout;
        nameInput.addEventListener('input', () => {
            clearTimeout(nameTimeout);
            nameTimeout = setTimeout(() => {
                const newName = nameInput.value;
                fetch('/api/user/update-profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: newName })
                })
                .catch(error => console.error('Error updating name:', error));
            }, 500);
        });

        // Handle profile bio updates
        const bioInput = document.getElementById('profile-bio-input');
        let bioTimeout;
        bioInput.addEventListener('input', () => {
            clearTimeout(bioTimeout);
            bioTimeout = setTimeout(() => {
                const newBio = bioInput.value;
                fetch('/api/user/update-profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ bio: newBio })
                })
                .catch(error => console.error('Error updating bio:', error));
            }, 500);
        });

        // Handle profile picture updates
        const avatarEdit = document.querySelector('.avatar-edit');
        avatarEdit.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const formData = new FormData();
                    formData.append('profile_picture', file);
                    
                    fetch('/api/user/update-profile-picture', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('profile-avatar-img').src = `/uploads/profile_photos/${data.filename}`;
                        }
                    })
                    .catch(error => console.error('Error updating profile picture:', error));
                }
            };
            input.click();
        });

        // Handle logout
        document.getElementById('logout-button').addEventListener('click', () => {
            fetch('/auth/logout', {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    window.location.href = '/';
                }
            })
            .catch(error => console.error('Error logging out:', error));
        });

        // Load profile data when settings sidebar is opened
        const settingsSidebar = document.querySelector('.settings-sidebar');
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'style') {
                    if (settingsSidebar.style.display !== 'none') {
                        loadProfileData();
                    }
                }
            });
        });

        observer.observe(settingsSidebar, {
            attributes: true
        });

        // ... existing code ...
                        // Single click - Select chat
                        showChat(entity.id, entity.name || entity.username, isGroup);
                     if (event.detail === 2) {
                        // Double click - Show info
                        if (isGroup) {
                            showGroupInfo(entity);
                        } else {
                            showContactInfo(entity);
                        }
                    }
                

                // Add info button click event (3 dots)
                const infoBtn = contactElement.querySelector('.contact-info-btn');
                infoBtn.addEventListener('click', function(event) {
                    event.stopPropagation(); // Prevent triggering the contact click
                    if (isGroup) {
                        showGroupInfo(entity);
                    } else {
                        showContactInfo(entity);
                    }
                });
    </script>
</body>
</html>

